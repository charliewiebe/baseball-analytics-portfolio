<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Portfolio Notebook">
<meta name="dcterms.date" content="2025-10-08">

<title>Pitch Sequencing &amp; Tunneling, Python (Unfinished) – Baseball Analytics Projects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-80278d44abbb443aada24b13759e4b65.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Baseball Analytics Projects</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.qmd"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="header-section-number">0.1</span> Intro</a></li>
  <li><a href="#setup-data-pull-statcast" id="toc-setup-data-pull-statcast" class="nav-link" data-scroll-target="#setup-data-pull-statcast"><span class="header-section-number">0.2</span> Setup &amp; Data Pull (Statcast)</a></li>
  <li><a href="#statistical-aggregation" id="toc-statistical-aggregation" class="nav-link" data-scroll-target="#statistical-aggregation"><span class="header-section-number">0.3</span> Statistical Aggregation</a></li>
  <li><a href="#pitch-sequencing-class-level" id="toc-pitch-sequencing-class-level" class="nav-link" data-scroll-target="#pitch-sequencing-class-level"><span class="header-section-number">0.4</span> Pitch Sequencing (Class-level)</a></li>
  <li><a href="#pitch-tunneling" id="toc-pitch-tunneling" class="nav-link" data-scroll-target="#pitch-tunneling"><span class="header-section-number">0.5</span> Pitch Tunneling</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Pitch Sequencing &amp; Tunneling, Python (Unfinished)</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Pitching</div>
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">Tunneling</div>
    <div class="quarto-category">Python</div>
    <div class="quarto-category">Unfinished</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Portfolio Notebook </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 8, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="intro" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="intro"><span class="header-section-number">0.1</span> Intro</h3>
<div id="45c4d7b2" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># As a former collegiate pitcher and little-league catcher, I've always been enthralled by the idea of pitch calling. Baseball, at its strategic core, is a game of information, deception, and probabilistic decision-making. Every pitch is a trade-off between prediction and surprise — the pitcher’s sequencing and tunneling shaping how a hitter perceives and reacts. This project quantifies and models those hidden layers of decision-making: how pitch type, location, and previous context (including the order of these pitches) interact to influence hitting outcomes such as OBP, SLG, and OPS. By transforming raw Statcast data into structured pitch sequences, the analysis explores whether algorithms can detect the subtle, repeatable signatures of effective pitching strategies. This work is not only a statistical exercise but also a look at the psychology and optimization of in-game tactics. It offers a framework for how data-driven insights might one day complement or even redefine the intuition of pitchers and coaches when calling pitches. Finally, the project assesses the efficacy of tunneling pitches.</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="setup-data-pull-statcast" class="level3" data-number="0.2">
<h3 data-number="0.2" class="anchored" data-anchor-id="setup-data-pull-statcast"><span class="header-section-number">0.2</span> Setup &amp; Data Pull (Statcast)</h3>
<div id="7e583d37" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This block acquires Statcast pitch-level data and standardizes schema for downstream reuse.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensures every metric/visual that follows is apples-to-apples across seasons and sources.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb, pybaseball <span class="im">as</span> pb, pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pb.statcast(<span class="st">"2023-01-01"</span>, <span class="st">"2025-12-31"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df.copy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="statistical-aggregation" class="level3" data-number="0.3">
<h3 data-number="0.3" class="anchored" data-anchor-id="statistical-aggregation"><span class="header-section-number">0.3</span> Statistical Aggregation</h3>
<div id="265d796d" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I aggregated plate-appearance outcomes to compute OBP, SLG, and OPS by sequence. I chose these specific statistics for front-office interpretibility; ties pitch-calling decisions directly to run value—clear, actionable scorecard for coaches and catchers.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 3-pitch sequences → OPS by sequence (OBP + SLG)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps "Other" pitches in df, but DROPS sequences that contain "Other"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inside/Away anchored to RIGHT-HANDED perspective for ALL batters</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: pandas, numpy</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure long sequence strings are fully visible when printed</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Columns &amp; NA handling</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed to build pitch_desc for every pitch in sequences:</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>cols_for_desc <span class="op">=</span> [</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitch_name"</span>, <span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed at the terminal pitch to compute PA outcome</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>cols_for_pa <span class="op">=</span> [<span class="st">"events"</span>]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Check presence</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_for_desc <span class="op">+</span> cols_for_pa:</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Required column missing: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric for computations</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span>]:</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> pd.to_numeric(df[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows that cannot contribute to sequences due to missing location/zone/pitch info</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>cols_for_desc).copy()</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Pitch class mapping (KEEP "Other"; we will filter sequences later)</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_cat"</span>]   <span class="op">=</span> df[<span class="st">"pitch_class"</span>]  <span class="co"># optional alias</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Rule-book zone + directions</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co">#     - In/Away uses RHB perspective for everyone:</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="co">#         plate_x &lt; -0.15 → "In", plate_x &gt; 0.15 → "Away", else "Middle"</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Strike if within plate edges and between sz_bot/sz_top</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Direction picks the more extreme axis between Up/Down and In/Away</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># ft (17" plate / 2)</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)  <span class="co"># guard</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="co"># In-zone (NA-safe → False)</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizontal direction anchored to RHB, NA-safe</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical direction, NA-safe</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the most extreme axis</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>is_vert  <span class="op">=</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>is_horiz <span class="op">=</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> is_vert</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> is_horiz</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Terminal 3-pitch sequence (PA must have ≥3 pitches)</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Keep "Other" in df, but DROP sequences containing any "Other"</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>df_sorted <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]).copy()</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark last pitch per PA</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>max_pitch_num <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_number"</span>].transform(<span class="st">"max"</span>)</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>is_last <span class="op">=</span> (df_sorted[<span class="st">"pitch_number"</span>] <span class="op">==</span> max_pitch_num)</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Previous two pitch_desc and pitch_class within PA</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m1"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m2"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m1"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m2"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only terminal rows with two priors (PA length ≥ 3)</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> df_sorted.loc[</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>    is_last <span class="op">&amp;</span> df_sorted[<span class="st">"desc_m2"</span>].notna(),</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>,</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_desc"</span>, <span class="st">"desc_m1"</span>, <span class="st">"desc_m2"</span>,</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_class"</span>, <span class="st">"class_m1"</span>, <span class="st">"class_m2"</span>,</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>        <span class="st">"events"</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>terminal.rename(columns<span class="op">=</span>{<span class="st">"pitch_class"</span>: <span class="st">"class_final"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset index to avoid duplicate-index alignment issues during assignment</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>terminal.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Need valid events to compute OPS; normalize to lower-case strings</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> terminal[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally collapse common variants to canonical labels</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> (</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"events"</span>]</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"intentional_walk"</span>, <span class="st">"intent_walk"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"home run"</span>, <span class="st">"home_run"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_bunt"</span>, <span class="st">"sac_bunt"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove sequences that include ANY "Other" pitch</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>mask_has_other <span class="op">=</span> (</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_final"</span>] <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m1"</span>]   <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m2"</span>]   <span class="op">==</span> <span class="st">"Other"</span>)</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> terminal.loc[<span class="op">~</span>mask_has_other].copy()</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Build sequence string (now guaranteed to have no "Other")</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"sequence"</span>] <span class="op">=</span> terminal[<span class="st">"desc_m2"</span>] <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span> terminal[<span class="st">"desc_m1"</span>] <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span> terminal[<span class="st">"pitch_desc"</span>]</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) From terminal 'events' → PA outcome components</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a><span class="co">#     OBP = (H + BB + HBP) / (AB + BB + HBP + SF)</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a><span class="co">#     SLG = TB / AB</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="co">#     OPS = OBP + SLG</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>HIT_EVENTS <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>BB_EVENTS  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>HBP_EVENTS <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>SF_EVENTS  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sac_fly_double_play"</span>}  <span class="co"># include DP variant as SF</span></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>SH_EVENTS  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>CI_EVENTS  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> terminal[<span class="st">"events"</span>]  <span class="co"># same index as terminal after reset_index</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Use NumPy arrays for assignment to avoid any reindex attempts</span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_H"</span>]   <span class="op">=</span> ev.isin(HIT_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_BB"</span>]  <span class="op">=</span> ev.isin(BB_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_HBP"</span>] <span class="op">=</span> ev.isin(HBP_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SF"</span>]  <span class="op">=</span> ev.isin(SF_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SH"</span>]  <span class="op">=</span> ev.isin(SH_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_CI"</span>]  <span class="op">=</span> ev.isin(CI_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Total bases per PA</span></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a><span class="co"># At-bat indicator (AB excludes BB, HBP, SF, SH, CI)</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_AB"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> terminal[[<span class="st">"pa_BB"</span>, <span class="st">"pa_HBP"</span>, <span class="st">"pa_SF"</span>, <span class="st">"pa_SH"</span>, <span class="st">"pa_CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to sequence level, compute OPS, filter n_pas &gt;= 20</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>seq_agg <span class="op">=</span> (</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>    terminal.groupby(<span class="st">"sequence"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>            .agg(</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>                n_pas<span class="op">=</span>(<span class="st">"sequence"</span>, <span class="st">"size"</span>),</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>                H<span class="op">=</span>(<span class="st">"pa_H"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>                BB<span class="op">=</span>(<span class="st">"pa_BB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>                HBP<span class="op">=</span>(<span class="st">"pa_HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>                SF<span class="op">=</span>(<span class="st">"pa_SF"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>                AB<span class="op">=</span>(<span class="st">"pa_AB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>                TB<span class="op">=</span>(<span class="st">"pa_TB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a><span class="co"># OBP &amp; SLG (avoid division by zero)</span></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>denom_obp <span class="op">=</span> seq_agg[<span class="st">"AB"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SF"</span>]</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>, (seq_agg[<span class="st">"H"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp, np.nan)</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(seq_agg[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, seq_agg[<span class="st">"TB"</span>] <span class="op">/</span> seq_agg[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OPS"</span>] <span class="op">=</span> seq_agg[<span class="st">"OBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SLG"</span>]</span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only sequences with at least 20 PAs and valid OPS; show only n_pas and OPS</span></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>final_stats <span class="op">=</span> (</span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>    seq_agg[(seq_agg[<span class="st">"n_pas"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>) <span class="op">&amp;</span> (seq_agg[<span class="st">"OPS"</span>].notna())]</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>    .loc[:, [<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]]</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])  <span class="co"># sort high→low by default</span></span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Top 10 lowest / highest / most common (ONLY n_pas and OPS)</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>top10_lowest <span class="op">=</span> (</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>top10_highest <span class="op">=</span> (</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>top10_common <span class="op">=</span> (</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"n_pas"</span>, <span class="st">"sequence"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">True</span>])</span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Display / export (optional)</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_lowest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_highest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_common.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a><span class="co"># # Optionally save:</span></span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a><span class="co"># final_stats.to_csv("sequence_ops_summary_noOther_min20.csv", index=False)</span></span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_lowest.to_csv("top10_lowest_ops_sequences_min20.csv", index=False)</span></span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_highest.to_csv("top10_highest_ops_sequences_min20.csv", index=False)</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_common.to_csv("top10_most_common_sequences_ops_min20.csv", index=False)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
=== Top 10 sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===
                                                            sequence  n_pas      OPS
  Breaking In (Strike), Breaking Away (Strike), Breaking Down (Ball)     26 0.000000
  Breaking In (Strike), Fastball Away (Strike), Breaking Away (Ball)     21 0.000000
        Change In (Ball), Fastball In (Strike), Change Down (Strike)     21 0.000000
      Fastball Down (Strike), Change In (Ball), Breaking Down (Ball)     20 0.000000
Breaking Down (Strike), Breaking Away (Strike), Breaking Down (Ball)     45 0.022222
            Breaking In (Ball), Change In (Ball), Change Down (Ball)     24 0.041667
        Fastball Away (Ball), Change Down (Strike), Change In (Ball)     24 0.041667
  Fastball Away (Strike), Breaking Down (Strike), Change Down (Ball)     23 0.043478
        Breaking In (Strike), Change In (Ball), Breaking Down (Ball)     22 0.045455
      Breaking Up (Strike), Fastball In (Strike), Fastball Up (Ball)     22 0.045455

=== Top 10 sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===
                                                              sequence  n_pas      OPS
  Breaking Away (Ball), Breaking Down (Ball), Breaking Middle (Strike)     24 1.869565
        Fastball Away (Ball), Change Away (Ball), Fastball Down (Ball)     23 1.792642
          Change In (Ball), Fastball Down (Ball), Fastball Away (Ball)     26 1.769231
Breaking Away (Strike), Breaking Away (Ball), Fastball Middle (Strike)     22 1.590909
        Breaking In (Ball), Change Down (Ball), Fastball Down (Strike)     29 1.551724
            Breaking In (Ball), Change Down (Ball), Fastball Up (Ball)     22 1.545455
      Fastball Down (Strike), Change In (Ball), Fastball Down (Strike)     37 1.542042
          Change Down (Ball), Change In (Ball), Breaking Down (Strike)     22 1.500000
    Breaking Down (Strike), Fastball Away (Ball), Change Down (Strike)     25 1.480000
        Fastball Away (Ball), Fastball Away (Ball), Breaking Up (Ball)     22 1.469697

=== Top 10 sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ===
                                                          sequence  n_pas      OPS
  Breaking Down (Ball), Breaking Down (Ball), Breaking Down (Ball)    837 0.328643
        Fastball In (Ball), Fastball In (Ball), Fastball In (Ball)    731 0.903494
  Fastball Away (Ball), Fastball Away (Ball), Fastball Away (Ball)    718 0.793223
        Fastball Up (Ball), Fastball Up (Ball), Fastball Up (Ball)    648 0.631166
  Breaking Away (Ball), Breaking Away (Ball), Breaking Away (Ball)    631 0.387728
Fastball Away (Ball), Fastball Away (Ball), Fastball Away (Strike)    501 0.802049
      Fastball In (Ball), Fastball In (Ball), Fastball In (Strike)    468 0.821028
      Fastball Up (Ball), Fastball Up (Ball), Fastball Up (Strike)    428 0.622862
Fastball Away (Ball), Fastball Away (Ball), Fastball Down (Strike)    416 0.723564
  Breaking Down (Ball), Breaking Down (Ball), Fastball In (Strike)    391 0.732282
</code></pre>
<div id="73414fae" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I found that binning pitch locations in the previous analysis made the results too granular, and thus, not very statically powerful. For this next analysis, I completed many of the same steps to assess pitch sequences, but did not use the same location data, thus expanding the tests.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 3-pitch sequences → OPS by sequence (OBP + SLG)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps "Other" pitches in df, but DROPS sequences that contain "Other"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inside/Away anchored to RIGHT-HANDED perspective for ALL batters</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: pandas, numpy</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Only change vs working script: sequence uses PITCH CLASS ONLY</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#       e.g., "Fastball, Fastball, Curveball" (no location features).</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure long sequence strings are fully visible when printed</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Columns &amp; NA handling</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed to build pitch_desc for every pitch in sequences:</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>cols_for_desc <span class="op">=</span> [</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitch_name"</span>, <span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed at the terminal pitch to compute PA outcome</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>cols_for_pa <span class="op">=</span> [<span class="st">"events"</span>]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Check presence</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_for_desc <span class="op">+</span> cols_for_pa:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Required column missing: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric for computations</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span>]:</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> pd.to_numeric(df[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows that cannot contribute to sequences due to missing location/zone/pitch info</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>cols_for_desc).copy()</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Pitch class mapping (KEEP "Other"; we will filter sequences later)</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>,</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_cat"</span>]   <span class="op">=</span> df[<span class="st">"pitch_class"</span>]  <span class="co"># optional alias</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Rule-book zone + directions (UNCHANGED; not used for sequence now)</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="co">#     - In/Away uses RHB perspective for everyone:</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="co">#         plate_x &lt; -0.15 → "In", plate_x &gt; 0.15 → "Away", else "Middle"</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Strike if within plate edges and between sz_bot/sz_top</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Direction picks the more extreme axis between Up/Down and In/Away</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># ft (17" plate / 2)</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)  <span class="co"># guard</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="co"># In-zone (NA-safe → False)</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizontal direction anchored to RHB, NA-safe</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical direction, NA-safe</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the most extreme axis</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>is_vert  <span class="op">=</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>is_horiz <span class="op">=</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> is_vert</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> is_horiz</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Terminal 3-pitch sequence (PA must have ≥3 pitches)</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Keep "Other" in df, but DROP sequences containing any "Other"</span></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a><span class="co">#     - ONLY CHANGE: build sequence from PITCH CLASS ONLY</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a><span class="co">#       e.g., "Fastball, Fastball, Curveball"</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>df_sorted <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]).copy()</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark last pitch per PA</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>max_pitch_num <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_number"</span>].transform(<span class="st">"max"</span>)</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>is_last <span class="op">=</span> (df_sorted[<span class="st">"pitch_number"</span>] <span class="op">==</span> max_pitch_num)</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Previous two pitch_desc and pitch_class within PA</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m1"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m2"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m1"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m2"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only terminal rows with two priors (PA length ≥ 3) — unchanged condition</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> df_sorted.loc[</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>    is_last <span class="op">&amp;</span> df_sorted[<span class="st">"desc_m2"</span>].notna(),</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>        <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>,</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_desc"</span>, <span class="st">"desc_m1"</span>, <span class="st">"desc_m2"</span>,</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_class"</span>, <span class="st">"class_m1"</span>, <span class="st">"class_m2"</span>,</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>        <span class="st">"events"</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>terminal.rename(columns<span class="op">=</span>{<span class="st">"pitch_class"</span>: <span class="st">"class_final"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset index to avoid duplicate-index alignment issues during assignment</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>terminal.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Need valid events to compute OPS; normalize to lower-case strings</span></span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> terminal[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally collapse common variants to canonical labels</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> (</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"events"</span>]</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"intentional_walk"</span>, <span class="st">"intent_walk"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"home run"</span>, <span class="st">"home_run"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_bunt"</span>, <span class="st">"sac_bunt"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove sequences that include ANY "Other" pitch</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>mask_has_other <span class="op">=</span> (</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_final"</span>] <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m1"</span>]   <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m2"</span>]   <span class="op">==</span> <span class="st">"Other"</span>)</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> terminal.loc[<span class="op">~</span>mask_has_other].copy()</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- ONLY CHANGE: sequence = last three PITCH CLASSES ----------</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"sequence"</span>] <span class="op">=</span> (</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_m2"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_m1"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_final"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) From terminal 'events' → PA outcome components</span></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a><span class="co">#     OBP = (H + BB + HBP) / (AB + BB + HBP + SF)</span></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a><span class="co">#     SLG = TB / AB</span></span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a><span class="co">#     OPS = OBP + SLG</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>HIT_EVENTS <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>BB_EVENTS  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>HBP_EVENTS <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>SF_EVENTS  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sac_fly_double_play"</span>}  <span class="co"># include DP variant as SF</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>SH_EVENTS  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>CI_EVENTS  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> terminal[<span class="st">"events"</span>]  <span class="co"># same index as terminal after reset_index</span></span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Use NumPy arrays for assignment to avoid any reindex attempts</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_H"</span>]   <span class="op">=</span> ev.isin(HIT_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_BB"</span>]  <span class="op">=</span> ev.isin(BB_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_HBP"</span>] <span class="op">=</span> ev.isin(HBP_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SF"</span>]  <span class="op">=</span> ev.isin(SF_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SH"</span>]  <span class="op">=</span> ev.isin(SH_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_CI"</span>]  <span class="op">=</span> ev.isin(CI_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Total bases per PA</span></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a><span class="co"># At-bat indicator (AB excludes BB, HBP, SF, SH, CI)</span></span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_AB"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> terminal[[<span class="st">"pa_BB"</span>, <span class="st">"pa_HBP"</span>, <span class="st">"pa_SF"</span>, <span class="st">"pa_SH"</span>, <span class="st">"pa_CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to sequence level, compute OPS, filter n_pas &gt;= 20</span></span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>seq_agg <span class="op">=</span> (</span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>    terminal.groupby(<span class="st">"sequence"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>            .agg(</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>                n_pas<span class="op">=</span>(<span class="st">"sequence"</span>, <span class="st">"size"</span>),</span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>                H<span class="op">=</span>(<span class="st">"pa_H"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>                BB<span class="op">=</span>(<span class="st">"pa_BB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>                HBP<span class="op">=</span>(<span class="st">"pa_HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>                SF<span class="op">=</span>(<span class="st">"pa_SF"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>                AB<span class="op">=</span>(<span class="st">"pa_AB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>                TB<span class="op">=</span>(<span class="st">"pa_TB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a><span class="co"># OBP &amp; SLG (avoid division by zero)</span></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>denom_obp <span class="op">=</span> seq_agg[<span class="st">"AB"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SF"</span>]</span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>, (seq_agg[<span class="st">"H"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp, np.nan)</span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(seq_agg[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, seq_agg[<span class="st">"TB"</span>] <span class="op">/</span> seq_agg[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OPS"</span>] <span class="op">=</span> seq_agg[<span class="st">"OBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SLG"</span>]</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only sequences with at least 20 PAs and valid OPS; show only n_pas and OPS</span></span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>final_stats <span class="op">=</span> (</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>    seq_agg[(seq_agg[<span class="st">"n_pas"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>) <span class="op">&amp;</span> (seq_agg[<span class="st">"OPS"</span>].notna())]</span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>    .loc[:, [<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]]</span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])  <span class="co"># sort high→low by default</span></span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Top 10 lowest / highest / most common (ONLY n_pas and OPS)</span></span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>top10_lowest <span class="op">=</span> (</span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>top10_highest <span class="op">=</span> (</span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])</span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>top10_common <span class="op">=</span> (</span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"n_pas"</span>, <span class="st">"sequence"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">True</span>])</span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Display / export (optional)</span></span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_lowest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_highest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_common.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a><span class="co"># # Optionally save:</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a><span class="co"># final_stats.to_csv("sequence_ops_summary_classONLY_min20.csv", index=False)</span></span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_lowest.to_csv("top10_lowest_ops_sequences_classONLY_min20.csv", index=False)</span></span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_highest.to_csv("top10_highest_ops_sequences_classONLY_min20.csv", index=False)</span></span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_common.to_csv("top10_most_common_sequences_ops_classONLY_min20.csv", index=False)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<!-- Evidence: selected outputs kept for interpretability. -->
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
=== Top 10 CLASS-ONLY sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===
                    sequence  n_pas      OPS
      Change, Change, Change   4661 0.505688
  Breaking, Breaking, Change   3179 0.520671
Fastball, Breaking, Breaking  25343 0.522692
Breaking, Breaking, Breaking  20000 0.525544
  Fastball, Breaking, Change   5495 0.538381
    Change, Breaking, Change   2438 0.549796
    Fastball, Change, Change   9321 0.553125
  Fastball, Change, Breaking   4844 0.561085
Fastball, Fastball, Breaking  33190 0.568219
    Breaking, Change, Change   3464 0.572111

=== Top 10 CLASS-ONLY sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===
                    sequence  n_pas      OPS
  Change, Fastball, Fastball  13134 0.759152
    Change, Change, Fastball   8148 0.750642
Fastball, Fastball, Fastball  70505 0.732533
  Fastball, Change, Fastball  14741 0.730778
  Change, Breaking, Fastball   4503 0.714981
  Breaking, Change, Fastball   5955 0.709868
Fastball, Breaking, Fastball  31953 0.703844
Breaking, Fastball, Fastball  29800 0.696462
Breaking, Breaking, Fastball  23819 0.679377
    Change, Fastball, Change   7329 0.617856

=== Top 10 CLASS-ONLY sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ===
                    sequence  n_pas      OPS
Fastball, Fastball, Fastball  70505 0.732533
Fastball, Fastball, Breaking  33190 0.568219
Fastball, Breaking, Fastball  31953 0.703844
Breaking, Fastball, Fastball  29800 0.696462
Fastball, Breaking, Breaking  25343 0.522692
Breaking, Breaking, Fastball  23819 0.679377
Breaking, Fastball, Breaking  21745 0.608894
Breaking, Breaking, Breaking  20000 0.525544
  Fastball, Change, Fastball  14741 0.730778
  Fastball, Fastball, Change  14171 0.598230
</code></pre>
</section>
<section id="pitch-sequencing-class-level" class="level3" data-number="0.4">
<h3 data-number="0.4" class="anchored" data-anchor-id="pitch-sequencing-class-level"><span class="header-section-number">0.4</span> Pitch Sequencing (Class-level)</h3>
<div id="9c4b190e" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I encoded pitch-class order (FB/BRK/CH) and quantified its relationship to outcomes in order to identify **repeatable** sequencing templates to script early counts for pitchers.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">Three-pitch class-only table (27 rows) coloured by OPS.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">Assumes `final_stats` DataFrame already exists with columns:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    sequence | n_pas | OPS</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">and contains only class-level sequences </span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Enumerate every three-pitch class combination (27 rows)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">"Fastball"</span>, <span class="st">"Breaking"</span>, <span class="st">"Change"</span>]</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> [</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"first"</span>: f, <span class="st">"second"</span>: s, <span class="st">"third"</span>: t,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sequence"</span>: <span class="ss">f"</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f, s, t <span class="kw">in</span> itertools.product(classes, repeat<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>all_seq <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Merge with stats so missing combos show NaN</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> (</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    all_seq</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    .merge(final_stats[[<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]], on<span class="op">=</span><span class="st">"sequence"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>])</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Colour map: green (low) → yellow (≈0.710) → red (high)</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>vmin <span class="op">=</span> <span class="fl">0.410</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>vmax <span class="op">=</span> <span class="fl">0.850</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>mid  <span class="op">=</span> <span class="fl">0.710</span>                                  <span class="co"># centre point requested</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> matplotlib.colors.TwoSlopeNorm(vmin<span class="op">=</span>vmin, vcenter<span class="op">=</span>mid, vmax<span class="op">=</span>vmax)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> plt.cm.get_cmap(<span class="st">"RdYlGn_r"</span>)             <span class="co"># reversed so high =&gt; red</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>row_colors <span class="op">=</span> [</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#dddddd"</span> <span class="cf">if</span> np.isnan(v)                   <span class="co"># grey rows = no PAs</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> matplotlib.colors.to_hex(cmap(norm(v)))</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> merged[<span class="st">"OPS"</span>]</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot a single figure containing the coloured table</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">18</span>))        <span class="co"># one figure = rule-compliant</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> ax.table(</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>merged[[<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]].fillna(<span class="st">""</span>).values,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>],</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"center"</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Style header &amp; data rows</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (row, col), cell <span class="kw">in</span> tbl.get_celld().items():</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row <span class="op">==</span> <span class="dv">0</span>:                               <span class="co"># header row</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        cell.set_text_props(weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:                                      <span class="co"># data rows</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        cell.set_facecolor(row_colors[row <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: save to file</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="co"># fig.savefig("three_pitch_sequences_table_red_to_green.png",</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="co">#             dpi=300, bbox_inches="tight")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
/var/folders/b9/qvkdlgns0d19941by569ptqr0000gn/T/ipykernel_84802/3373149627.py:45: MatplotlibDeprecationWarning: The get_cmap function was deprecated in Matplotlib 3.7 and will be removed in 3.11. Use ``matplotlib.colormaps[name]`` or ``matplotlib.colormaps.get_cmap()`` or ``pyplot.get_cmap()`` instead.
  cmap = plt.cm.get_cmap("RdYlGn_r")             # reversed so high =&gt; red
</code></pre>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
&lt;Figure size 900x1800 with 1 Axes&gt;
</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figure_3_1_1.png" class="img-fluid figure-img"></p>
<figcaption>Figure from cell 4</figcaption>
</figure>
</div>
<div id="d6e58473" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">TOP-N OPENING SEQUENCES, RANKED BY OPS (WITH LOCATION INFO)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">======================================</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">• Works from a Statcast-like pitch-level DataFrame `df`.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">• Produces five tables:</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #1   (single pitch context)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #2   (first-two pitches)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #3</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #4</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #5</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">  Each table shows: context count, ‘ended_here’ count,</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">  wOBA, OPS, and the literal sequence.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Imports</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Map pitch names → pitch_class</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>, <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>, <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>, <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>, <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>, <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>, <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>, <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>, <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>, <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Build pitch_desc  (class + direction + zone)</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># feet (17" / 2)</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># in–zone?</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="co"># directions</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="co"># choose axis with greater deviance</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Collapse to one row per plate appearance</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]) <span class="op">\</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>      .groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> (</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    g.agg(</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        pitch_list<span class="op">=</span>(<span class="st">"pitch_desc"</span>, <span class="bu">list</span>),</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>        events<span class="op">=</span>(<span class="st">"events"</span>, <span class="st">"last"</span>)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"n_pitches"</span>] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="co"># grab first five pitches if present</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lbl <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>, <span class="st">"fourth"</span>, <span class="st">"fifth"</span>], start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    pa[lbl] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>[i<span class="op">-</span><span class="dv">1</span>].where(pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> i)</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a><span class="co"># flags: PA ended exactly on pitch n?</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    pa[<span class="ss">f"end_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (pa[<span class="st">"n_pitches"</span>] <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Per-PA outcome components</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> pa[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="co"># wOBA weights (2024 weights)</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>WOBA_WT <span class="op">=</span> {</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_run"</span>: <span class="fl">1.95</span>, <span class="st">"triple"</span>: <span class="fl">1.56</span>, <span class="st">"double"</span>: <span class="fl">1.24</span>, <span class="st">"single"</span>: <span class="fl">0.90</span>,</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"walk"</span>: <span class="fl">0.69</span>, <span class="st">"intent_walk"</span>: <span class="fl">0.69</span>, <span class="st">"hit_by_pitch"</span>: <span class="fl">0.72</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_numerator"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(WOBA_WT).fillna(<span class="fl">0.0</span>)</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_denom"</span>] <span class="op">=</span> <span class="fl">1.0</span>   <span class="co"># one plate appearance per row</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a><span class="co"># OPS components</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>HIT <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>BB  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>HBP <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>SF  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly_double_play"</span>}</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>SH  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>CI  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"H"</span>]   <span class="op">=</span> ev.isin(HIT).astype(<span class="bu">int</span>)</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"BB"</span>]  <span class="op">=</span> ev.isin(BB).astype(<span class="bu">int</span>)</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"HBP"</span>] <span class="op">=</span> ev.isin(HBP).astype(<span class="bu">int</span>)</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SF"</span>]  <span class="op">=</span> ev.isin(SF).astype(<span class="bu">int</span>)</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SH"</span>]  <span class="op">=</span> ev.isin(SH).astype(<span class="bu">int</span>)</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"CI"</span>]  <span class="op">=</span> ev.isin(CI).astype(<span class="bu">int</span>)</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"AB"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> pa[[<span class="st">"BB"</span>, <span class="st">"HBP"</span>, <span class="st">"SF"</span>, <span class="st">"SH"</span>, <span class="st">"CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Helper to build N-pitch tables (properly weighted OPS)</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_table(n: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">5</span> <span class="kw">or</span> n <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be 1–5"</span>)</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create opening-sequence key</span></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    seq_col <span class="op">=</span> <span class="ss">f"seq_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> pa[<span class="st">"first"</span>]</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">=</span> [pa[<span class="st">"first"</span>], pa[<span class="st">"second"</span>], pa[<span class="st">"third"</span>],</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>                 pa.get(<span class="st">"fourth"</span>), pa.get(<span class="st">"fifth"</span>)][:n]</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> parts[<span class="dv">0</span>]</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> parts[<span class="dv">1</span>:]:</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>            pa[seq_col] <span class="op">=</span> pa[seq_col] <span class="op">+</span> <span class="st">" </span><span class="ch">\u2192</span><span class="st"> "</span> <span class="op">+</span> p  <span class="co"># arrow separator</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># aggregate</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> (</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>        pa[pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> n]</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>        .groupby(seq_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>            count<span class="op">=</span>(<span class="st">"game_pk"</span>, <span class="st">"size"</span>),</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>            ended_here<span class="op">=</span>(<span class="ss">f"end_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>, <span class="st">"sum"</span>),</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>            woba_num<span class="op">=</span>(<span class="st">"woba_numerator"</span>, <span class="st">"sum"</span>),</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>            woba_den<span class="op">=</span>(<span class="st">"woba_denom"</span>, <span class="st">"sum"</span>),</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>            H<span class="op">=</span>(<span class="st">"H"</span>, <span class="st">"sum"</span>), BB<span class="op">=</span>(<span class="st">"BB"</span>, <span class="st">"sum"</span>), HBP<span class="op">=</span>(<span class="st">"HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>            SF<span class="op">=</span>(<span class="st">"SF"</span>, <span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>, <span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>, <span class="st">"sum"</span>)</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> grp[grp[<span class="st">"count"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>] </span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute wOBA</span></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"wOBA"</span>] <span class="op">=</span> grp[<span class="st">"woba_num"</span>] <span class="op">/</span> grp[<span class="st">"woba_den"</span>]</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute OBP &amp; SLG from summed components</span></span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>    denom_obp <span class="op">=</span> grp[<span class="st">"AB"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>] <span class="op">+</span> grp[<span class="st">"SF"</span>]</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>                          (grp[<span class="st">"H"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp,</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>                          np.nan)</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(grp[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, grp[<span class="st">"TB"</span>] <span class="op">/</span> grp[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OPS"</span>] <span class="op">=</span> grp[<span class="st">"OBP"</span>] <span class="op">+</span> grp[<span class="st">"SLG"</span>]</span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># final tidy</span></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> (</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>        grp.sort_values([<span class="st">"OPS"</span>, <span class="st">"count"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>           .head(<span class="dv">10</span>)</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>           .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>           .loc[:, [<span class="st">"count"</span>, <span class="st">"ended_here"</span>, <span class="st">"wOBA"</span>, <span class="st">"OPS"</span>, seq_col]]</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{seq_col: <span class="st">"sequence"</span>})</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Produce and print tables for n = 1 … 5</span></span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 sequences at pitch-number </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> (by OPS):"</span>)</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>    tbl <span class="op">=</span> build_table(n)</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tbl.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wOBA"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span>,</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OPS"</span>:  <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>    }))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
Top 10 sequences at pitch-number 1 (by OPS):
 count  ended_here  wOBA   OPS               sequence
 10752        1313 0.277 0.645   Breaking Up (Strike)
 16469        3020 0.284 0.661 Breaking Away (Strike)
 35725        6257 0.286 0.668   Fastball Up (Strike)
 14728        2226 0.286 0.668   Breaking In (Strike)
 31362        6331 0.293 0.681 Fastball Down (Strike)
    49          13 0.300 0.681    Other Down (Strike)
 36087        7238 0.293 0.681 Fastball Away (Strike)
 20365        4039 0.294 0.684 Breaking Down (Strike)
 35118        7933 0.297 0.690   Fastball In (Strike)
  4045        1137 0.304 0.714     Change In (Strike)

Top 10 sequences at pitch-number 2 (by OPS):
 count  ended_here  wOBA   OPS                                        sequence
    27          14 0.092 0.188   Breaking Middle (Strike) → Change In (Strike)
    20          10 0.107 0.258         Change Up (Strike) → Change Up (Strike)
    33          16 0.130 0.303       Change In (Strike) → Change Away (Strike)
    32           4 0.145 0.323       Change Up (Strike) → Fastball Down (Ball)
    44          14 0.157 0.328     Breaking Down (Strike) → Change Up (Strike)
    25           8 0.158 0.360     Change In (Ball) → Breaking Middle (Strike)
    25          12 0.158 0.360         Change In (Strike) → Change Up (Strike)
   147           8 0.187 0.398       Breaking In (Strike) → Breaking Up (Ball)
   251           9 0.183 0.399 Fastball Middle (Strike) → Fastball Down (Ball)
    26           4 0.210 0.406     Change Middle (Strike) → Change Away (Ball)

Top 10 sequences at pitch-number 3 (by OPS):
 count  ended_here  wOBA   OPS                                                               sequence
    20           6 0.000 0.000         Change Away (Ball) → Change Down (Strike) → Change Down (Ball)
    22          10 0.031 0.045   Breaking Away (Strike) → Breaking Away (Ball) → Breaking Up (Strike)
    22           9 0.031 0.045   Breaking Up (Strike) → Fastball Down (Strike) → Breaking Away (Ball)
    21          14 0.034 0.048 Breaking Down (Strike) → Breaking In (Strike) → Breaking Down (Strike)
    20           6 0.034 0.050       Breaking Up (Ball) → Breaking In (Ball) → Fastball Away (Strike)
    38          13 0.037 0.053   Fastball In (Strike) → Fastball Down (Strike) → Fastball Down (Ball)
    34           9 0.026 0.059     Breaking Up (Ball) → Breaking Away (Strike) → Breaking Down (Ball)
    25           5 0.055 0.080   Breaking Away (Ball) → Breaking In (Strike) → Fastball Away (Strike)
    22          10 0.041 0.091 Fastball Up (Strike) → Breaking Away (Ball) → Breaking Middle (Strike)
    23          12 0.039 0.093       Change Down (Strike) → Change Down (Ball) → Fastball In (Strike)

Top 10 sequences at pitch-number 4 (by OPS):
 count  ended_here  wOBA   OPS                                                                                      sequence
    22           8 0.000 0.000   Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Strike) → Fastball Up (Ball)
    20           9 0.000 0.000 Fastball Down (Strike) → Fastball Away (Strike) → Breaking Away (Ball) → Breaking Away (Ball)
    23           9 0.030 0.043     Fastball In (Strike) → Fastball In (Strike) → Breaking Down (Ball) → Breaking Down (Ball)
    34           7 0.047 0.089         Fastball Up (Ball) → Fastball Up (Strike) → Fastball Up (Strike) → Fastball Up (Ball)
    21          10 0.043 0.095           Fastball In (Strike) → Breaking In (Ball) → Breaking In (Ball) → Breaking In (Ball)
    20           9 0.070 0.100         Fastball In (Strike) → Fastball In (Ball) → Fastball Up (Ball) → Breaking Down (Ball)
    24           5 0.066 0.129     Fastball Away (Strike) → Fastball Up (Ball) → Breaking Down (Ball) → Breaking Down (Ball)
    23           7 0.090 0.130       Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking In (Ball)
    20           8 0.079 0.153   Breaking Away (Strike) → Breaking Away (Ball) → Breaking Down (Ball) → Breaking Down (Ball)
    25           2 0.072 0.163     Fastball Away (Strike) → Breaking Down (Ball) → Breaking Down (Ball) → Fastball Up (Ball)

Top 10 sequences at pitch-number 5 (by OPS):
 count  ended_here  wOBA   OPS                                                                                                           sequence
    21          10 0.230 0.333   Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball)
    20           8 0.194 0.483           Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Strike)
    33          14 0.301 0.568             Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball)
    31          11 0.337 0.610   Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball)
    30          18 0.451 0.800             Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball)
    22           7 0.385 0.919 Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball)
    20           8 0.486 0.983           Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Strike) → Fastball In (Ball)
    23          11 0.492 1.016 Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Ball)
</code></pre>
<div id="e66a2712" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">TOP-N OPENING SEQUENCES, RANKED BY OPS – **NO LOCATION INFO**</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">• Works from a Statcast-like pitch-level DataFrame `df`.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">• Sequences are built only from the *pitch class* (“Fastball”, “Breaking” …)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">  — nothing about In/Away/Up/Down/Strike/Ball.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">• Produces five tables (first pitch through fifth pitch), each showing</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">  context count, ‘ended_here’ count, wOBA, OPS, and the literal sequence.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">• Only sequences with ≥ 20 PAs are kept, and tables are sorted</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">  from **lowest OPS to highest**.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Imports</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Map Statcast pitch_name → pitch_class         (no location used)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>, <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>, <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>, <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>, <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>, <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>, <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>, <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>, <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>, <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Collapse to one row per plate appearance</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co">#    (using **only** pitch_class tokens)</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]) <span class="op">\</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      .groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> (</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    g.agg(</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        pitch_list<span class="op">=</span>(<span class="st">"pitch_class"</span>, <span class="bu">list</span>),   <span class="co"># ← token is pitch_class</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        events<span class="op">=</span>(<span class="st">"events"</span>, <span class="st">"last"</span>)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"n_pitches"</span>] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lbl <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>, <span class="st">"fourth"</span>, <span class="st">"fifth"</span>], start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    pa[lbl] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>[i<span class="op">-</span><span class="dv">1</span>].where(pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> i)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    pa[<span class="ss">f"end_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (pa[<span class="st">"n_pitches"</span>] <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Per-PA outcome components (same as before)</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> pa[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>WOBA_WT <span class="op">=</span> {           <span class="co"># 2024 weights</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_run"</span>: <span class="fl">1.95</span>, <span class="st">"triple"</span>: <span class="fl">1.56</span>, <span class="st">"double"</span>: <span class="fl">1.24</span>, <span class="st">"single"</span>: <span class="fl">0.90</span>,</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"walk"</span>: <span class="fl">0.69</span>, <span class="st">"intent_walk"</span>: <span class="fl">0.69</span>, <span class="st">"hit_by_pitch"</span>: <span class="fl">0.72</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_numerator"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(WOBA_WT).fillna(<span class="fl">0.0</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_denom"</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>HIT <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>BB  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>HBP <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>SF  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly_double_play"</span>}</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>SH  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>CI  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"H"</span>]   <span class="op">=</span> ev.isin(HIT).astype(<span class="bu">int</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"BB"</span>]  <span class="op">=</span> ev.isin(BB).astype(<span class="bu">int</span>)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"HBP"</span>] <span class="op">=</span> ev.isin(HBP).astype(<span class="bu">int</span>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SF"</span>]  <span class="op">=</span> ev.isin(SF).astype(<span class="bu">int</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SH"</span>]  <span class="op">=</span> ev.isin(SH).astype(<span class="bu">int</span>)</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"CI"</span>]  <span class="op">=</span> ev.isin(CI).astype(<span class="bu">int</span>)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"AB"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> pa[[<span class="st">"BB"</span>, <span class="st">"HBP"</span>, <span class="st">"SF"</span>, <span class="st">"SH"</span>, <span class="st">"CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Helper to build N-pitch tables (OPS from summed components)</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_table(n: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="kw">not</span> <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>):</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be 1–5"</span>)</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>    seq_col <span class="op">=</span> <span class="ss">f"seq_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> pa[<span class="st">"first"</span>]</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">=</span> [pa[<span class="st">"first"</span>], pa[<span class="st">"second"</span>], pa[<span class="st">"third"</span>],</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>                 pa.get(<span class="st">"fourth"</span>), pa.get(<span class="st">"fifth"</span>)][:n]</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> parts[<span class="dv">0</span>]</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> parts[<span class="dv">1</span>:]:</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>            pa[seq_col] <span class="op">=</span> pa[seq_col] <span class="op">+</span> <span class="st">" → "</span> <span class="op">+</span> p</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> (</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>        pa[pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> n]</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>        .groupby(seq_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>            count<span class="op">=</span>(<span class="st">"game_pk"</span>, <span class="st">"size"</span>),</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>            ended_here<span class="op">=</span>(<span class="ss">f"end_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>, <span class="st">"sum"</span>),</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>            woba_num<span class="op">=</span>(<span class="st">"woba_numerator"</span>, <span class="st">"sum"</span>),</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>            woba_den<span class="op">=</span>(<span class="st">"woba_denom"</span>, <span class="st">"sum"</span>),</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>            H<span class="op">=</span>(<span class="st">"H"</span>, <span class="st">"sum"</span>), BB<span class="op">=</span>(<span class="st">"BB"</span>, <span class="st">"sum"</span>), HBP<span class="op">=</span>(<span class="st">"HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>            SF<span class="op">=</span>(<span class="st">"SF"</span>, <span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>, <span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>, <span class="st">"sum"</span>)</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only sequences with ≥ 20 PAs</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> grp[grp[<span class="st">"count"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>]</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"wOBA"</span>] <span class="op">=</span> grp[<span class="st">"woba_num"</span>] <span class="op">/</span> grp[<span class="st">"woba_den"</span>]</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    denom_obp <span class="op">=</span> grp[<span class="st">"AB"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>] <span class="op">+</span> grp[<span class="st">"SF"</span>]</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>                          (grp[<span class="st">"H"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp,</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>                          np.nan)</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(grp[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, grp[<span class="st">"TB"</span>] <span class="op">/</span> grp[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OPS"</span>] <span class="op">=</span> grp[<span class="st">"OBP"</span>] <span class="op">+</span> grp[<span class="st">"SLG"</span>]</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> (</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>        grp.sort_values([<span class="st">"OPS"</span>, <span class="st">"count"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])  <span class="co"># lowest OPS first</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>           .head(<span class="dv">10</span>)</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>           .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>           .loc[:, [<span class="st">"count"</span>, <span class="st">"ended_here"</span>, <span class="st">"wOBA"</span>, <span class="st">"OPS"</span>, seq_col]]</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{seq_col: <span class="st">"sequence"</span>})</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Produce and print tables for n = 1 … 5</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 sequences at pitch-number </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> (by OPS; ≥20 PAs):"</span>)</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>    tbl <span class="op">=</span> build_table(n)</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tbl.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wOBA"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span>,</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OPS"</span>:  <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Visualise OPS trajectories, growing one pitch at a time</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.collections <span class="im">import</span> LineCollection</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-a) cache the OPS tables for n = 1 … 5</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>ops_by_len <span class="op">=</span> {n: build_table(n).set_index(<span class="st">"sequence"</span>)[<span class="st">"OPS"</span>] <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)}</span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-b) helper to fetch OPS for a sequence’s (n-1) prefix</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prefix_ops(seq, n):</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ops_by_len[<span class="dv">1</span>].get(seq)      <span class="co"># base case</span></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>    prefix <span class="op">=</span> <span class="st">" → "</span>.join(seq.split(<span class="st">" → "</span>)[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ops_by_len[n<span class="op">-</span><span class="dv">1</span>].get(prefix)</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-c) colour map for the *last pitch* in each segment</span></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>COLOR_MAP <span class="op">=</span> {<span class="st">"Fastball"</span>: <span class="st">"#377eb8"</span>, <span class="st">"Breaking"</span>: <span class="st">"#e41a1c"</span>,</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Change"</span>: <span class="st">"#4daf4a"</span>, <span class="st">"Other"</span>: <span class="st">"#984ea3"</span>}</span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a><span class="co"># first-pitch dots</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> seq, ops <span class="kw">in</span> ops_by_len[<span class="dv">1</span>].items():</span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>    ax.scatter(<span class="dv">1</span>, ops, s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span>COLOR_MAP.get(seq, <span class="st">"#999999"</span>),</span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a>               zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">1.02</span>, ops, seq, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="co"># build segments for n = 2 … 5</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>segments <span class="op">=</span> []</span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>colors   <span class="op">=</span> []</span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">6</span>):</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> seq, ops_n <span class="kw">in</span> ops_by_len[n].items():</span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>        ops_prev <span class="op">=</span> prefix_ops(seq, n)</span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isna(ops_prev):</span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>          <span class="co"># prefix didn’t meet 20-PA threshold</span></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>        x0, y0 <span class="op">=</span> n<span class="op">-</span><span class="dv">1</span>, ops_prev</span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> n,   ops_n</span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>        segments.append([(x0, y0), (x1, y1)])</span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>        last_pitch <span class="op">=</span> seq.split(<span class="st">" → "</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>        colors.append(COLOR_MAP.get(last_pitch, <span class="st">"#999999"</span>))</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all segments at once</span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>lc <span class="op">=</span> LineCollection(segments, colors<span class="op">=</span>colors, linewidths<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>ax.add_collection(lc)</span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a><span class="co"># scatter end-points so the last pitch colour shows on dots too</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x0, y0), (x1, y1), c <span class="kw">in</span> <span class="bu">zip</span>([s[<span class="dv">0</span>] <span class="cf">for</span> s <span class="kw">in</span> segments],</span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>                                 [s[<span class="dv">1</span>] <span class="cf">for</span> s <span class="kw">in</span> segments], colors):</span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>    ax.scatter(x1, y1, color<span class="op">=</span>c, s<span class="op">=</span><span class="dv">25</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a><span class="co"># axes cosmetics</span></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Pitch number in sequence"</span>)</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"OPS"</span>)</span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"OPS Trajectories for Opening Sequences</span><span class="ch">\n</span><span class="st">(segment colour = pitch thrown at that step)"</span>)</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="fl">0.8</span>, <span class="fl">5.2</span>)</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>ax.grid(ls<span class="op">=</span><span class="st">"--"</span>, lw<span class="op">=</span><span class="fl">0.4</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
Top 10 sequences at pitch-number 1 (by OPS; ≥20 PAs):
 count  ended_here  wOBA   OPS sequence
158664       14620 0.310 0.713 Breaking
312271       39637 0.310 0.713 Fastball
 43423        5426 0.326 0.755   Change
 19429        9041 0.330 0.759    Other

Top 10 sequences at pitch-number 2 (by OPS; ≥20 PAs):
 count  ended_here  wOBA   OPS            sequence
 57306        8696 0.292 0.665 Breaking → Breaking
 72168       11085 0.295 0.673 Fastball → Breaking
162489       28438 0.300 0.685 Fastball → Fastball
 10255        1335 0.306 0.687       Other → Other
 37968        6601 0.302 0.688   Fastball → Change
 19355        3237 0.306 0.697   Breaking → Change
 67368       12507 0.308 0.703 Breaking → Fastball
 17940        3062 0.315 0.724   Change → Fastball
 14102        2754 0.318 0.731     Change → Change
  5860         887 0.327 0.750   Change → Breaking

Top 10 sequences at pitch-number 3 (by OPS; ≥20 PAs):
 count  ended_here  wOBA   OPS                       sequence
 20500        5522 0.255 0.567 Breaking → Breaking → Breaking
 26831        6784 0.261 0.583 Fastball → Breaking → Breaking
  5480        1320 0.268 0.597   Fastball → Breaking → Change
 38656        9212 0.271 0.608 Fastball → Fastball → Breaking
  8875        4199 0.281 0.608          Other → Other → Other
 19188        4866 0.278 0.623 Breaking → Fastball → Breaking
 11369        2916 0.278 0.626     Fastball → Change → Change
  3662         995 0.284 0.638       Change → Change → Change
  4828        1090 0.284 0.638   Fastball → Change → Breaking
  4049         839 0.288 0.639   Breaking → Breaking → Change

Top 10 sequences at pitch-number 4 (by OPS; ≥20 PAs):
 count  ended_here  wOBA   OPS                                  sequence
   891         338 0.220 0.476     Fastball → Change → Breaking → Change
   322         128 0.233 0.491       Change → Breaking → Change → Change
  6978        2674 0.236 0.515 Breaking → Breaking → Breaking → Breaking
  1480         498 0.243 0.530   Fastball → Breaking → Breaking → Change
   895         353 0.244 0.531       Breaking → Change → Change → Change
  7880        2968 0.242 0.532 Fastball → Breaking → Breaking → Breaking
  2094         785 0.247 0.537       Fastball → Change → Change → Change
 11770        4181 0.246 0.543 Fastball → Fastball → Breaking → Breaking
  1381         417 0.252 0.550   Breaking → Breaking → Fastball → Change
  1370         530 0.252 0.553       Change → Fastball → Change → Change

Top 10 sequences at pitch-number 5 (by OPS; ≥20 PAs):
 count  ended_here  wOBA   OPS                                           sequence
    74          40 0.164 0.296     Change → Breaking → Fastball → Change → Change
   179          76 0.173 0.336 Breaking → Breaking → Breaking → Breaking → Change
   131          58 0.192 0.378   Breaking → Breaking → Change → Breaking → Change
    34          13 0.211 0.408     Change → Change → Change → Breaking → Breaking
    87          42 0.209 0.410 Change → Fastball → Breaking → Breaking → Breaking
   246         101 0.219 0.428 Breaking → Fastball → Breaking → Breaking → Change
   109          39 0.239 0.443   Change → Change → Fastball → Breaking → Breaking
    55          26 0.249 0.476       Change → Breaking → Change → Change → Change
   420         214 0.228 0.477       Change → Change → Fastball → Change → Change
   162          78 0.240 0.482 Change → Fastball → Breaking → Fastball → Breaking
</code></pre>
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
&lt;Figure size 1000x600 with 1 Axes&gt;
</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figure_5_1_2.png" class="img-fluid figure-img"></p>
<figcaption>Figure from cell 6</figcaption>
</figure>
</div>
</section>
<section id="pitch-tunneling" class="level3" data-number="0.5">
<h3 data-number="0.5" class="anchored" data-anchor-id="pitch-tunneling"><span class="header-section-number">0.5</span> Pitch Tunneling</h3>
<div id="2f92bc23" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This portion of the project assesses how "tunneling" pitches improves pitching outcomes. It flags pairs of pitches as being tunneled using Statcast's extremely granular location/release data, and a couple physics equations found at https://baseball.physics.illinois.edu/</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  OPS Impact of Optimal Tunnelling  –  last-pitch sequences (class change)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  • DataFrame `df` must already hold raw Statcast rows</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  • “Tunneled” if:</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#       3-D hand-distance  &lt; 0.35 ft  (≈ 4.2″)      AND</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#       distance between trajectories at 23 ft front of plate &lt; 0.18 ft</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  • Computes OPS for each DIFFERENT-class pair  ± tunnelling</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1  Pitch-class buckets ------------------------------------------------</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>CLASS <span class="op">=</span> {<span class="st">"Knuckle Curve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Curveball"</span>:<span class="st">"Breaking"</span>,<span class="st">"Sweeper"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Slider"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slurve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slow Curve"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Cutter"</span>:<span class="st">"Fastball"</span>,<span class="st">"4-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"2-Seam Fastball"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Sinker"</span>:<span class="st">"Fastball"</span>,<span class="st">"Pitch Out"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Split-Finger"</span>:<span class="st">"Change"</span>,<span class="st">"Changeup"</span>:<span class="st">"Change"</span>,<span class="st">"Forkball"</span>:<span class="st">"Change"</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Knuckleball"</span>:<span class="st">"Change"</span>,<span class="st">"Eephus"</span>:<span class="st">"Change"</span>}</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(CLASS).fillna(<span class="st">"Other"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2  Last two pitches of every PA --------------------------------------</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>,<span class="st">"pitch_number"</span>])</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>last2 <span class="op">=</span> df.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).tail(<span class="dv">2</span>).copy()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>last2[<span class="st">"idx"</span>] <span class="op">=</span> last2.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).cumcount()</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> (</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    last2.pivot(index<span class="op">=</span>[<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>], columns<span class="op">=</span><span class="st">"idx"</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>         .dropna(subset<span class="op">=</span>[(<span class="st">"pitch_class"</span>,<span class="dv">0</span>),(<span class="st">"pitch_class"</span>,<span class="dv">1</span>)])</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>wide.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,i <span class="kw">in</span> wide.columns]</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> wide[wide[<span class="st">"pitch_class_0"</span>] <span class="op">!=</span> wide[<span class="st">"pitch_class_1"</span>]]        <span class="co"># class change only</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3  Tunnel metrics ----------------------------------------------------</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>HAND_THR, DEC_THR, Y_DEC <span class="op">=</span> <span class="fl">0.35</span>, <span class="fl">0.18</span>, <span class="fl">23.0</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>hand_dist <span class="op">=</span> np.sqrt(</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_x_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_x_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_z_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_z_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_extension_1"</span>] <span class="op">-</span> wide[<span class="st">"release_extension_0"</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xy_at_23ft(frame, s):                             <span class="co"># s = 0 or 1</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    y0  <span class="op">=</span> frame[<span class="ss">f"release_pos_y_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    dy  <span class="op">=</span> y0 <span class="op">-</span> Y_DEC</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    vy0 <span class="op">=</span> frame[<span class="ss">f"vy0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    ay  <span class="op">=</span> frame[<span class="ss">f"ay_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> vy0<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>ay<span class="op">*</span>dy</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.full_like(vy0, np.nan)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    ok <span class="op">=</span> (disc <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (ay <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    t[ok] <span class="op">=</span> (<span class="op">-</span>vy0[ok] <span class="op">-</span> np.sqrt(disc[ok])) <span class="op">/</span> ay[ok]</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    vx0, ax <span class="op">=</span> frame[<span class="ss">f"vx0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"ax_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    vz0, az <span class="op">=</span> frame[<span class="ss">f"vz0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"az_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    x_rel, z_rel <span class="op">=</span> frame[<span class="ss">f"release_pos_x_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"release_pos_z_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x_rel <span class="op">+</span> vx0<span class="op">*</span>t <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>ax<span class="op">*</span>t<span class="op">**</span><span class="dv">2</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> z_rel <span class="op">+</span> vz0<span class="op">*</span>t <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>az<span class="op">*</span>t<span class="op">**</span><span class="dv">2</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x, z</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>x0,z0 <span class="op">=</span> xy_at_23ft(wide,<span class="dv">0</span>)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>x1,z1 <span class="op">=</span> xy_at_23ft(wide,<span class="dv">1</span>)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>dec_dist <span class="op">=</span> np.sqrt((x1<span class="op">-</span>x0)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (z1<span class="op">-</span>z0)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Boolean masks (NA → False)</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>cond_hand <span class="op">=</span> (hand_dist <span class="op">&lt;</span> HAND_THR).fillna(<span class="va">False</span>)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>cond_dec  <span class="op">=</span> np.where(np.isnan(dec_dist), <span class="va">False</span>, dec_dist <span class="op">&lt;</span> DEC_THR)</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>cond_dec  <span class="op">=</span> pd.Series(cond_dec, index<span class="op">=</span>wide.index)</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"tunneled"</span>] <span class="op">=</span> cond_hand <span class="op">&amp;</span> cond_dec</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4  Sequence label ----------------------------------------------------</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"seq"</span>] <span class="op">=</span> wide[<span class="st">"pitch_class_0"</span>] <span class="op">+</span> <span class="st">"→"</span> <span class="op">+</span> wide[<span class="st">"pitch_class_1"</span>]</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5  OPS components from final-pitch result ----------------------------</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> wide[<span class="st">"events_1"</span>].fillna(<span class="st">"none"</span>).<span class="bu">str</span>.lower()</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>single <span class="op">=</span> ev.eq(<span class="st">"single"</span>)<span class="op">;</span> double <span class="op">=</span> ev.eq(<span class="st">"double"</span>)<span class="op">;</span> triple <span class="op">=</span> ev.eq(<span class="st">"triple"</span>)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>hr     <span class="op">=</span> ev.eq(<span class="st">"home_run"</span>)<span class="op">;</span> walk <span class="op">=</span> ev.isin([<span class="st">"walk"</span>,<span class="st">"intent_walk"</span>,<span class="st">"hit_by_pitch"</span>])</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"PA"</span>]  <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"AB"</span>]  <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> walk</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"TB"</span>]  <span class="op">=</span> single <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>double <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>triple <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>hr</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"ONB"</span>] <span class="op">=</span> single <span class="op">+</span> double <span class="op">+</span> triple <span class="op">+</span> hr <span class="op">+</span> walk</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6  Aggregate to OPS --------------------------------------------------</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> (wide.groupby([<span class="st">"seq"</span>,<span class="st">"tunneled"</span>])</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>             .agg(PA<span class="op">=</span>(<span class="st">"PA"</span>,<span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>,<span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>,<span class="st">"sum"</span>), ONB<span class="op">=</span>(<span class="st">"ONB"</span>,<span class="st">"sum"</span>))</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>             .reset_index())</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OBP"</span>] <span class="op">=</span> agg[<span class="st">"ONB"</span>] <span class="op">/</span> agg[<span class="st">"PA"</span>]</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"SLG"</span>] <span class="op">=</span> agg[<span class="st">"TB"</span>]  <span class="op">/</span> agg[<span class="st">"AB"</span>].where(agg[<span class="st">"AB"</span>]<span class="op">&gt;</span><span class="dv">0</span>, np.nan)</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OPS"</span>] <span class="op">=</span> agg[<span class="st">"OBP"</span>] <span class="op">+</span> agg[<span class="st">"SLG"</span>]</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (agg.pivot(index<span class="op">=</span><span class="st">"seq"</span>, columns<span class="op">=</span><span class="st">"tunneled"</span>, values<span class="op">=</span>[<span class="st">"PA"</span>,<span class="st">"OPS"</span>])</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>             .rename(columns<span class="op">=</span>{<span class="va">False</span>:<span class="st">"NoTunnel"</span>, <span class="va">True</span>:<span class="st">"Tunnel"</span>}))</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>table.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,col <span class="kw">in</span> table.columns]</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>table[<span class="st">"ΔOPS (Tunnel – No)"</span>] <span class="op">=</span> table[<span class="st">"OPS_Tunnel"</span>] <span class="op">-</span> table[<span class="st">"OPS_NoTunnel"</span>]</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> table.sort_values(<span class="st">"ΔOPS (Tunnel – No)"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== OPS on last-pitch sequences  |  Tunneled vs Not Tunneled ==="</span>)</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table.to_string(float_format<span class="op">=</span><span class="kw">lambda</span> x:<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span>, na_rep<span class="op">=</span><span class="st">"–"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<!-- Evidence: selected outputs kept for interpretability. -->
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
=== OPS on last-pitch sequences  |  Tunneled vs Not Tunneled ===
                   PA_NoTunnel  PA_Tunnel  OPS_NoTunnel  OPS_Tunnel  ΔOPS (Tunnel – No)
seq                                                                                    
Breaking→Fastball    72115.000    665.000         0.729       0.924               0.195
Change→Fastball      31333.000    589.000         0.746       0.777               0.031
Fastball→Change      32965.000    649.000         0.643       0.611              -0.032
Change→Breaking      11244.000     90.000         0.608       0.550              -0.057
Breaking→Change      14236.000    113.000         0.595       0.527              -0.068
Fastball→Breaking    71010.000    521.000         0.632       0.563              -0.069
Breaking→Other          23.000          –         1.503           –                   –
Change→Other           103.000          –         0.958           –                   –
Fastball→Other          42.000          –         0.819           –                   –
Other→Breaking          29.000          –         0.466           –                   –
Other→Change           104.000          –         0.864           –                   –
Other→Fastball          51.000          –         0.514           –                   –
</code></pre>
<div id="a073d97b" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  OPS Impact of Straight-Line Tunnelling  – last-pitch class-change pairs</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1  Pitch-class buckets ----------------------------------------------</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>CLASS <span class="op">=</span> {<span class="st">"Knuckle Curve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Curveball"</span>:<span class="st">"Breaking"</span>,<span class="st">"Sweeper"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Slider"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slurve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slow Curve"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Cutter"</span>:<span class="st">"Fastball"</span>,<span class="st">"4-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Four-Seam Fastball"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">"2-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Two-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Sinker"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Pitch Out"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Split-Finger"</span>:<span class="st">"Change"</span>,<span class="st">"Splitter"</span>:<span class="st">"Change"</span>,<span class="st">"Changeup"</span>:<span class="st">"Change"</span>,<span class="st">"Forkball"</span>:<span class="st">"Change"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Knuckleball"</span>:<span class="st">"Change"</span>,<span class="st">"Eephus"</span>:<span class="st">"Change"</span>}</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(CLASS).fillna(<span class="st">"Other"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2  Last two pitches of each plate appearance ------------------------</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>,<span class="st">"pitch_number"</span>])</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>last2 <span class="op">=</span> df.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).tail(<span class="dv">2</span>).copy()</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>last2[<span class="st">"idx"</span>] <span class="op">=</span> last2.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).cumcount()</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> (last2</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        .pivot(index<span class="op">=</span>[<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>], columns<span class="op">=</span><span class="st">"idx"</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        .dropna(subset<span class="op">=</span>[(<span class="st">"pitch_class"</span>,<span class="dv">0</span>),(<span class="st">"pitch_class"</span>,<span class="dv">1</span>)]))</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>wide.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,i <span class="kw">in</span> wide.columns]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> wide[wide[<span class="st">"pitch_class_0"</span>] <span class="op">!=</span> wide[<span class="st">"pitch_class_1"</span>]]   <span class="co"># class switch only</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3  Tunnel metrics ----------------------------------------------------</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>HAND_THR   <span class="op">=</span> <span class="fl">0.333</span>   <span class="co"># 4 inches</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>PRED_THR   <span class="op">=</span> <span class="fl">0.333</span>   <span class="co"># 4 inches</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>Y_PLATE    <span class="op">=</span> <span class="fl">1.417</span>   <span class="co"># Statcast y at back edge of plate (ft)</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-a) release-point distance (x, z, extension)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>hand_dist <span class="op">=</span> np.sqrt(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_x_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_x_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_z_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_z_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_extension_1"</span>] <span class="op">-</span> wide[<span class="st">"release_extension_0"</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-b) straight-line (no-spin) projection to plate -----------------------</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> projected_xy(frame, s: <span class="bu">int</span>):</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return (x_proj, z_proj) at plate assuming ax = az = 0."""</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    y0  <span class="op">=</span> frame[<span class="ss">f"release_pos_y_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    dy  <span class="op">=</span> y0 <span class="op">-</span> Y_PLATE</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    vy0 <span class="op">=</span> frame[<span class="ss">f"vy0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    ay  <span class="op">=</span> frame[<span class="ss">f"ay_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()         <span class="co"># drag + gravity only</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> vy0<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>ay<span class="op">*</span>dy</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    t    <span class="op">=</span> np.full_like(vy0, np.nan)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    ok   <span class="op">=</span> (disc <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (ay <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    t[ok] <span class="op">=</span> (<span class="op">-</span>vy0[ok] <span class="op">-</span> np.sqrt(disc[ok])) <span class="op">/</span> ay[ok]</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    vx0 <span class="op">=</span> frame[<span class="ss">f"vx0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    vz0 <span class="op">=</span> frame[<span class="ss">f"vz0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    x0  <span class="op">=</span> frame[<span class="ss">f"release_pos_x_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    z0  <span class="op">=</span> frame[<span class="ss">f"release_pos_z_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    x_proj <span class="op">=</span> x0 <span class="op">+</span> vx0 <span class="op">*</span> t           <span class="co"># ax = 0</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    z_proj <span class="op">=</span> z0 <span class="op">+</span> vz0 <span class="op">*</span> t           <span class="co"># az = 0</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_proj, z_proj</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>x_proj0, z_proj0 <span class="op">=</span> projected_xy(wide, <span class="dv">0</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>x_proj1, z_proj1 <span class="op">=</span> projected_xy(wide, <span class="dv">1</span>)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>pred_dist <span class="op">=</span> np.sqrt((x_proj1 <span class="op">-</span> x_proj0)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (z_proj1 <span class="op">-</span> z_proj0)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-c) tunnel flag</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>cond_hand <span class="op">=</span> (hand_dist <span class="op">&lt;</span> HAND_THR).fillna(<span class="va">False</span>)</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>cond_pred <span class="op">=</span> np.where(np.isnan(pred_dist), <span class="va">False</span>, pred_dist <span class="op">&lt;</span> PRED_THR)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"tunneled"</span>] <span class="op">=</span> cond_hand <span class="op">&amp;</span> cond_pred</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4  Sequence label ----------------------------------------------------</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"seq"</span>] <span class="op">=</span> wide[<span class="st">"pitch_class_0"</span>] <span class="op">+</span> <span class="st">"→"</span> <span class="op">+</span> wide[<span class="st">"pitch_class_1"</span>]</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5  OPS components for final pitch -----------------------------------</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> wide[<span class="st">"events_1"</span>].fillna(<span class="st">"none"</span>).<span class="bu">str</span>.lower()</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>single <span class="op">=</span> ev.eq(<span class="st">"single"</span>)<span class="op">;</span> double <span class="op">=</span> ev.eq(<span class="st">"double"</span>)<span class="op">;</span> triple <span class="op">=</span> ev.eq(<span class="st">"triple"</span>)</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>hr     <span class="op">=</span> ev.eq(<span class="st">"home_run"</span>)<span class="op">;</span> walk  <span class="op">=</span> ev.isin([<span class="st">"walk"</span>,<span class="st">"intent_walk"</span>,<span class="st">"hit_by_pitch"</span>])</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"PA"</span>]  <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"AB"</span>]  <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> walk</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"TB"</span>]  <span class="op">=</span> single <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>double <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>triple <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>hr</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"ONB"</span>] <span class="op">=</span> single <span class="op">+</span> double <span class="op">+</span> triple <span class="op">+</span> hr <span class="op">+</span> walk</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6  Aggregate OPS split by tunnel flag -------------------------------</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> (wide.groupby([<span class="st">"seq"</span>,<span class="st">"tunneled"</span>])</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>             .agg(PA<span class="op">=</span>(<span class="st">"PA"</span>,<span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>,<span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>,<span class="st">"sum"</span>), ONB<span class="op">=</span>(<span class="st">"ONB"</span>,<span class="st">"sum"</span>))</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>             .reset_index())</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OBP"</span>] <span class="op">=</span> agg[<span class="st">"ONB"</span>] <span class="op">/</span> agg[<span class="st">"PA"</span>]</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"SLG"</span>] <span class="op">=</span> agg[<span class="st">"TB"</span>]  <span class="op">/</span> agg[<span class="st">"AB"</span>].where(agg[<span class="st">"AB"</span>]<span class="op">&gt;</span><span class="dv">0</span>, np.nan)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OPS"</span>] <span class="op">=</span> agg[<span class="st">"OBP"</span>] <span class="op">+</span> agg[<span class="st">"SLG"</span>]</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (agg.pivot(index<span class="op">=</span><span class="st">"seq"</span>, columns<span class="op">=</span><span class="st">"tunneled"</span>, values<span class="op">=</span>[<span class="st">"PA"</span>,<span class="st">"OPS"</span>])</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>             .rename(columns<span class="op">=</span>{<span class="va">False</span>:<span class="st">"NoTunnel"</span>, <span class="va">True</span>:<span class="st">"Tunnel"</span>}))</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>table.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,col <span class="kw">in</span> table.columns]</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"OPS_Tunnel"</span>, <span class="st">"OPS_NoTunnel"</span>]:        <span class="co"># ensure columns exist</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> table.columns:</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>        table[col] <span class="op">=</span> np.nan</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>table[<span class="st">"ΔOPS (Tunnel – No)"</span>] <span class="op">=</span> table[<span class="st">"OPS_Tunnel"</span>] <span class="op">-</span> table[<span class="st">"OPS_NoTunnel"</span>]</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> table.sort_values(<span class="st">"ΔOPS (Tunnel – No)"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== OPS on last-pitch sequences | Straight-Line Tunnel vs Not ==="</span>)</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table.to_string(float_format<span class="op">=</span><span class="kw">lambda</span> x:<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span>, na_rep<span class="op">=</span><span class="st">"–"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<!-- Evidence: selected outputs kept for interpretability. -->
<blockquote class="blockquote">
<p><strong>Console Output (evidence):</strong></p>
</blockquote>
<pre><code>
=== OPS on last-pitch sequences | Straight-Line Tunnel vs Not ===
                   PA_NoTunnel  PA_Tunnel  OPS_NoTunnel  OPS_Tunnel  ΔOPS (Tunnel – No)
seq                                                                                    
Breaking→Change      13945.000    404.000         0.593       0.662               0.069
Change→Breaking      11081.000    253.000         0.607       0.638               0.032
Breaking→Fastball    70794.000   1986.000         0.731       0.742               0.012
Change→Fastball      30874.000   1048.000         0.747       0.745              -0.002
Fastball→Change      32230.000   1384.000         0.645       0.592              -0.053
Fastball→Breaking    69876.000   1655.000         0.633       0.535              -0.098
Change→Other           100.000      3.000         0.973       0.333              -0.640
Breaking→Other          23.000          –         1.503           –                   –
Fastball→Other          42.000          –         0.819           –                   –
Other→Breaking          28.000      1.000         0.438           –                   –
Other→Change           104.000          –         0.864           –                   –
Other→Fastball          51.000          –         0.514           –                   –</code></pre>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Pitch Sequencing &amp; Tunneling, Python (Unfinished)"</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">  error: true</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="an">freeze:</span><span class="co"> auto</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Portfolio Notebook"</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-10-08</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [Pitching, Machine Learning, Tunneling, Python, Unfinished]</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intro</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># As a former collegiate pitcher and little-league catcher, I've always been enthralled by the idea of pitch calling. Baseball, at its strategic core, is a game of information, deception, and probabilistic decision-making. Every pitch is a trade-off between prediction and surprise — the pitcher’s sequencing and tunneling shaping how a hitter perceives and reacts. This project quantifies and models those hidden layers of decision-making: how pitch type, location, and previous context (including the order of these pitches) interact to influence hitting outcomes such as OBP, SLG, and OPS. By transforming raw Statcast data into structured pitch sequences, the analysis explores whether algorithms can detect the subtle, repeatable signatures of effective pitching strategies. This work is not only a statistical exercise but also a look at the psychology and optimization of in-game tactics. It offers a framework for how data-driven insights might one day complement or even redefine the intuition of pitchers and coaches when calling pitches. Finally, the project assesses the efficacy of tunneling pitches.</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="fu">### Setup &amp; Data Pull (Statcast)</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># This block acquires Statcast pitch-level data and standardizes schema for downstream reuse.</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensures every metric/visual that follows is apples-to-apples across seasons and sources.</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb, pybaseball <span class="im">as</span> pb, pandas <span class="im">as</span> pd</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pb.statcast(<span class="st">"2023-01-01"</span>, <span class="st">"2025-12-31"</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df.copy()</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="fu">### Statistical Aggregation</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="co"># I aggregated plate-appearance outcomes to compute OBP, SLG, and OPS by sequence. I chose these specific statistics for front-office interpretibility; ties pitch-calling decisions directly to run value—clear, actionable scorecard for coaches and catchers.</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 3-pitch sequences → OPS by sequence (OBP + SLG)</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps "Other" pitches in df, but DROPS sequences that contain "Other"</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Inside/Away anchored to RIGHT-HANDED perspective for ALL batters</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: pandas, numpy</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure long sequence strings are fully visible when printed</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Columns &amp; NA handling</span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed to build pitch_desc for every pitch in sequences:</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>cols_for_desc <span class="op">=</span> [</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>,</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitch_name"</span>, <span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed at the terminal pitch to compute PA outcome</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>cols_for_pa <span class="op">=</span> [<span class="st">"events"</span>]</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Check presence</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_for_desc <span class="op">+</span> cols_for_pa:</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Required column missing: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric for computations</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span>]:</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> pd.to_numeric(df[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows that cannot contribute to sequences due to missing location/zone/pitch info</span></span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>cols_for_desc).copy()</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Pitch class mapping (KEEP "Other"; we will filter sequences later)</span></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_cat"</span>]   <span class="op">=</span> df[<span class="st">"pitch_class"</span>]  <span class="co"># optional alias</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Rule-book zone + directions</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a><span class="co">#     - In/Away uses RHB perspective for everyone:</span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a><span class="co">#         plate_x &lt; -0.15 → "In", plate_x &gt; 0.15 → "Away", else "Middle"</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Strike if within plate edges and between sz_bot/sz_top</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Direction picks the more extreme axis between Up/Down and In/Away</span></span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># ft (17" plate / 2)</span></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)  <span class="co"># guard</span></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a><span class="co"># In-zone (NA-safe → False)</span></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizontal direction anchored to RHB, NA-safe</span></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical direction, NA-safe</span></span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the most extreme axis</span></span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>is_vert  <span class="op">=</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a>is_horiz <span class="op">=</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> is_vert</span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> is_horiz</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Terminal 3-pitch sequence (PA must have ≥3 pitches)</span></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Keep "Other" in df, but DROP sequences containing any "Other"</span></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>df_sorted <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]).copy()</span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark last pitch per PA</span></span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>max_pitch_num <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_number"</span>].transform(<span class="st">"max"</span>)</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>is_last <span class="op">=</span> (df_sorted[<span class="st">"pitch_number"</span>] <span class="op">==</span> max_pitch_num)</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Previous two pitch_desc and pitch_class within PA</span></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m1"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m2"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m1"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m2"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only terminal rows with two priors (PA length ≥ 3)</span></span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> df_sorted.loc[</span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>    is_last <span class="op">&amp;</span> df_sorted[<span class="st">"desc_m2"</span>].notna(),</span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>        <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>,</span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_desc"</span>, <span class="st">"desc_m1"</span>, <span class="st">"desc_m2"</span>,</span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_class"</span>, <span class="st">"class_m1"</span>, <span class="st">"class_m2"</span>,</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a>        <span class="st">"events"</span></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>terminal.rename(columns<span class="op">=</span>{<span class="st">"pitch_class"</span>: <span class="st">"class_final"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset index to avoid duplicate-index alignment issues during assignment</span></span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>terminal.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Need valid events to compute OPS; normalize to lower-case strings</span></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> terminal[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally collapse common variants to canonical labels</span></span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> (</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"events"</span>]</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"intentional_walk"</span>, <span class="st">"intent_walk"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"home run"</span>, <span class="st">"home_run"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_bunt"</span>, <span class="st">"sac_bunt"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove sequences that include ANY "Other" pitch</span></span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>mask_has_other <span class="op">=</span> (</span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_final"</span>] <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m1"</span>]   <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m2"</span>]   <span class="op">==</span> <span class="st">"Other"</span>)</span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> terminal.loc[<span class="op">~</span>mask_has_other].copy()</span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Build sequence string (now guaranteed to have no "Other")</span></span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"sequence"</span>] <span class="op">=</span> terminal[<span class="st">"desc_m2"</span>] <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span> terminal[<span class="st">"desc_m1"</span>] <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span> terminal[<span class="st">"pitch_desc"</span>]</span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) From terminal 'events' → PA outcome components</span></span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a><span class="co">#     OBP = (H + BB + HBP) / (AB + BB + HBP + SF)</span></span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a><span class="co">#     SLG = TB / AB</span></span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a><span class="co">#     OPS = OBP + SLG</span></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a>HIT_EVENTS <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a>BB_EVENTS  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a>HBP_EVENTS <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a>SF_EVENTS  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sac_fly_double_play"</span>}  <span class="co"># include DP variant as SF</span></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a>SH_EVENTS  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb19-240"><a href="#cb19-240" aria-hidden="true" tabindex="-1"></a>CI_EVENTS  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb19-241"><a href="#cb19-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-242"><a href="#cb19-242" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> terminal[<span class="st">"events"</span>]  <span class="co"># same index as terminal after reset_index</span></span>
<span id="cb19-243"><a href="#cb19-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-244"><a href="#cb19-244" aria-hidden="true" tabindex="-1"></a><span class="co"># Use NumPy arrays for assignment to avoid any reindex attempts</span></span>
<span id="cb19-245"><a href="#cb19-245" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_H"</span>]   <span class="op">=</span> ev.isin(HIT_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-246"><a href="#cb19-246" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_BB"</span>]  <span class="op">=</span> ev.isin(BB_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-247"><a href="#cb19-247" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_HBP"</span>] <span class="op">=</span> ev.isin(HBP_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-248"><a href="#cb19-248" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SF"</span>]  <span class="op">=</span> ev.isin(SF_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-249"><a href="#cb19-249" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SH"</span>]  <span class="op">=</span> ev.isin(SH_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-250"><a href="#cb19-250" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_CI"</span>]  <span class="op">=</span> ev.isin(CI_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-251"><a href="#cb19-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-252"><a href="#cb19-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Total bases per PA</span></span>
<span id="cb19-253"><a href="#cb19-253" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb19-254"><a href="#cb19-254" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-255"><a href="#cb19-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-256"><a href="#cb19-256" aria-hidden="true" tabindex="-1"></a><span class="co"># At-bat indicator (AB excludes BB, HBP, SF, SH, CI)</span></span>
<span id="cb19-257"><a href="#cb19-257" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_AB"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> terminal[[<span class="st">"pa_BB"</span>, <span class="st">"pa_HBP"</span>, <span class="st">"pa_SF"</span>, <span class="st">"pa_SH"</span>, <span class="st">"pa_CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb19-258"><a href="#cb19-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-259"><a href="#cb19-259" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-260"><a href="#cb19-260" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to sequence level, compute OPS, filter n_pas &gt;= 20</span></span>
<span id="cb19-261"><a href="#cb19-261" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-262"><a href="#cb19-262" aria-hidden="true" tabindex="-1"></a>seq_agg <span class="op">=</span> (</span>
<span id="cb19-263"><a href="#cb19-263" aria-hidden="true" tabindex="-1"></a>    terminal.groupby(<span class="st">"sequence"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-264"><a href="#cb19-264" aria-hidden="true" tabindex="-1"></a>            .agg(</span>
<span id="cb19-265"><a href="#cb19-265" aria-hidden="true" tabindex="-1"></a>                n_pas<span class="op">=</span>(<span class="st">"sequence"</span>, <span class="st">"size"</span>),</span>
<span id="cb19-266"><a href="#cb19-266" aria-hidden="true" tabindex="-1"></a>                H<span class="op">=</span>(<span class="st">"pa_H"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-267"><a href="#cb19-267" aria-hidden="true" tabindex="-1"></a>                BB<span class="op">=</span>(<span class="st">"pa_BB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-268"><a href="#cb19-268" aria-hidden="true" tabindex="-1"></a>                HBP<span class="op">=</span>(<span class="st">"pa_HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-269"><a href="#cb19-269" aria-hidden="true" tabindex="-1"></a>                SF<span class="op">=</span>(<span class="st">"pa_SF"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-270"><a href="#cb19-270" aria-hidden="true" tabindex="-1"></a>                AB<span class="op">=</span>(<span class="st">"pa_AB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-271"><a href="#cb19-271" aria-hidden="true" tabindex="-1"></a>                TB<span class="op">=</span>(<span class="st">"pa_TB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-272"><a href="#cb19-272" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-273"><a href="#cb19-273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-274"><a href="#cb19-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-275"><a href="#cb19-275" aria-hidden="true" tabindex="-1"></a><span class="co"># OBP &amp; SLG (avoid division by zero)</span></span>
<span id="cb19-276"><a href="#cb19-276" aria-hidden="true" tabindex="-1"></a>denom_obp <span class="op">=</span> seq_agg[<span class="st">"AB"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SF"</span>]</span>
<span id="cb19-277"><a href="#cb19-277" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>, (seq_agg[<span class="st">"H"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp, np.nan)</span>
<span id="cb19-278"><a href="#cb19-278" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(seq_agg[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, seq_agg[<span class="st">"TB"</span>] <span class="op">/</span> seq_agg[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb19-279"><a href="#cb19-279" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OPS"</span>] <span class="op">=</span> seq_agg[<span class="st">"OBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SLG"</span>]</span>
<span id="cb19-280"><a href="#cb19-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-281"><a href="#cb19-281" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only sequences with at least 20 PAs and valid OPS; show only n_pas and OPS</span></span>
<span id="cb19-282"><a href="#cb19-282" aria-hidden="true" tabindex="-1"></a>final_stats <span class="op">=</span> (</span>
<span id="cb19-283"><a href="#cb19-283" aria-hidden="true" tabindex="-1"></a>    seq_agg[(seq_agg[<span class="st">"n_pas"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>) <span class="op">&amp;</span> (seq_agg[<span class="st">"OPS"</span>].notna())]</span>
<span id="cb19-284"><a href="#cb19-284" aria-hidden="true" tabindex="-1"></a>    .loc[:, [<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]]</span>
<span id="cb19-285"><a href="#cb19-285" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])  <span class="co"># sort high→low by default</span></span>
<span id="cb19-286"><a href="#cb19-286" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-287"><a href="#cb19-287" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-288"><a href="#cb19-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-289"><a href="#cb19-289" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-290"><a href="#cb19-290" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Top 10 lowest / highest / most common (ONLY n_pas and OPS)</span></span>
<span id="cb19-291"><a href="#cb19-291" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-292"><a href="#cb19-292" aria-hidden="true" tabindex="-1"></a>top10_lowest <span class="op">=</span> (</span>
<span id="cb19-293"><a href="#cb19-293" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb19-294"><a href="#cb19-294" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-295"><a href="#cb19-295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-296"><a href="#cb19-296" aria-hidden="true" tabindex="-1"></a>top10_highest <span class="op">=</span> (</span>
<span id="cb19-297"><a href="#cb19-297" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])</span>
<span id="cb19-298"><a href="#cb19-298" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-299"><a href="#cb19-299" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-300"><a href="#cb19-300" aria-hidden="true" tabindex="-1"></a>top10_common <span class="op">=</span> (</span>
<span id="cb19-301"><a href="#cb19-301" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"n_pas"</span>, <span class="st">"sequence"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">True</span>])</span>
<span id="cb19-302"><a href="#cb19-302" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-303"><a href="#cb19-303" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-304"><a href="#cb19-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-305"><a href="#cb19-305" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-306"><a href="#cb19-306" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Display / export (optional)</span></span>
<span id="cb19-307"><a href="#cb19-307" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-308"><a href="#cb19-308" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-309"><a href="#cb19-309" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_lowest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-310"><a href="#cb19-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-311"><a href="#cb19-311" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-312"><a href="#cb19-312" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_highest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-313"><a href="#cb19-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-314"><a href="#cb19-314" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-315"><a href="#cb19-315" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_common.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-316"><a href="#cb19-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-317"><a href="#cb19-317" aria-hidden="true" tabindex="-1"></a><span class="co"># # Optionally save:</span></span>
<span id="cb19-318"><a href="#cb19-318" aria-hidden="true" tabindex="-1"></a><span class="co"># final_stats.to_csv("sequence_ops_summary_noOther_min20.csv", index=False)</span></span>
<span id="cb19-319"><a href="#cb19-319" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_lowest.to_csv("top10_lowest_ops_sequences_min20.csv", index=False)</span></span>
<span id="cb19-320"><a href="#cb19-320" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_highest.to_csv("top10_highest_ops_sequences_min20.csv", index=False)</span></span>
<span id="cb19-321"><a href="#cb19-321" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_common.to_csv("top10_most_common_sequences_ops_min20.csv", index=False)</span></span>
<span id="cb19-322"><a href="#cb19-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-323"><a href="#cb19-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-324"><a href="#cb19-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-325"><a href="#cb19-325" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-326"><a href="#cb19-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-327"><a href="#cb19-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-328"><a href="#cb19-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-329"><a href="#cb19-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-330"><a href="#cb19-330" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-331"><a href="#cb19-331" aria-hidden="true" tabindex="-1"></a><span class="in">                                                            sequence  n_pas      OPS</span></span>
<span id="cb19-332"><a href="#cb19-332" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking In (Strike), Breaking Away (Strike), Breaking Down (Ball)     26 0.000000</span></span>
<span id="cb19-333"><a href="#cb19-333" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking In (Strike), Fastball Away (Strike), Breaking Away (Ball)     21 0.000000</span></span>
<span id="cb19-334"><a href="#cb19-334" aria-hidden="true" tabindex="-1"></a><span class="in">        Change In (Ball), Fastball In (Strike), Change Down (Strike)     21 0.000000</span></span>
<span id="cb19-335"><a href="#cb19-335" aria-hidden="true" tabindex="-1"></a><span class="in">      Fastball Down (Strike), Change In (Ball), Breaking Down (Ball)     20 0.000000</span></span>
<span id="cb19-336"><a href="#cb19-336" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking Down (Strike), Breaking Away (Strike), Breaking Down (Ball)     45 0.022222</span></span>
<span id="cb19-337"><a href="#cb19-337" aria-hidden="true" tabindex="-1"></a><span class="in">            Breaking In (Ball), Change In (Ball), Change Down (Ball)     24 0.041667</span></span>
<span id="cb19-338"><a href="#cb19-338" aria-hidden="true" tabindex="-1"></a><span class="in">        Fastball Away (Ball), Change Down (Strike), Change In (Ball)     24 0.041667</span></span>
<span id="cb19-339"><a href="#cb19-339" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball Away (Strike), Breaking Down (Strike), Change Down (Ball)     23 0.043478</span></span>
<span id="cb19-340"><a href="#cb19-340" aria-hidden="true" tabindex="-1"></a><span class="in">        Breaking In (Strike), Change In (Ball), Breaking Down (Ball)     22 0.045455</span></span>
<span id="cb19-341"><a href="#cb19-341" aria-hidden="true" tabindex="-1"></a><span class="in">      Breaking Up (Strike), Fastball In (Strike), Fastball Up (Ball)     22 0.045455</span></span>
<span id="cb19-342"><a href="#cb19-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-343"><a href="#cb19-343" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-344"><a href="#cb19-344" aria-hidden="true" tabindex="-1"></a><span class="in">                                                              sequence  n_pas      OPS</span></span>
<span id="cb19-345"><a href="#cb19-345" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking Away (Ball), Breaking Down (Ball), Breaking Middle (Strike)     24 1.869565</span></span>
<span id="cb19-346"><a href="#cb19-346" aria-hidden="true" tabindex="-1"></a><span class="in">        Fastball Away (Ball), Change Away (Ball), Fastball Down (Ball)     23 1.792642</span></span>
<span id="cb19-347"><a href="#cb19-347" aria-hidden="true" tabindex="-1"></a><span class="in">          Change In (Ball), Fastball Down (Ball), Fastball Away (Ball)     26 1.769231</span></span>
<span id="cb19-348"><a href="#cb19-348" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking Away (Strike), Breaking Away (Ball), Fastball Middle (Strike)     22 1.590909</span></span>
<span id="cb19-349"><a href="#cb19-349" aria-hidden="true" tabindex="-1"></a><span class="in">        Breaking In (Ball), Change Down (Ball), Fastball Down (Strike)     29 1.551724</span></span>
<span id="cb19-350"><a href="#cb19-350" aria-hidden="true" tabindex="-1"></a><span class="in">            Breaking In (Ball), Change Down (Ball), Fastball Up (Ball)     22 1.545455</span></span>
<span id="cb19-351"><a href="#cb19-351" aria-hidden="true" tabindex="-1"></a><span class="in">      Fastball Down (Strike), Change In (Ball), Fastball Down (Strike)     37 1.542042</span></span>
<span id="cb19-352"><a href="#cb19-352" aria-hidden="true" tabindex="-1"></a><span class="in">          Change Down (Ball), Change In (Ball), Breaking Down (Strike)     22 1.500000</span></span>
<span id="cb19-353"><a href="#cb19-353" aria-hidden="true" tabindex="-1"></a><span class="in">    Breaking Down (Strike), Fastball Away (Ball), Change Down (Strike)     25 1.480000</span></span>
<span id="cb19-354"><a href="#cb19-354" aria-hidden="true" tabindex="-1"></a><span class="in">        Fastball Away (Ball), Fastball Away (Ball), Breaking Up (Ball)     22 1.469697</span></span>
<span id="cb19-355"><a href="#cb19-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-356"><a href="#cb19-356" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-357"><a href="#cb19-357" aria-hidden="true" tabindex="-1"></a><span class="in">                                                          sequence  n_pas      OPS</span></span>
<span id="cb19-358"><a href="#cb19-358" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking Down (Ball), Breaking Down (Ball), Breaking Down (Ball)    837 0.328643</span></span>
<span id="cb19-359"><a href="#cb19-359" aria-hidden="true" tabindex="-1"></a><span class="in">        Fastball In (Ball), Fastball In (Ball), Fastball In (Ball)    731 0.903494</span></span>
<span id="cb19-360"><a href="#cb19-360" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball Away (Ball), Fastball Away (Ball), Fastball Away (Ball)    718 0.793223</span></span>
<span id="cb19-361"><a href="#cb19-361" aria-hidden="true" tabindex="-1"></a><span class="in">        Fastball Up (Ball), Fastball Up (Ball), Fastball Up (Ball)    648 0.631166</span></span>
<span id="cb19-362"><a href="#cb19-362" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking Away (Ball), Breaking Away (Ball), Breaking Away (Ball)    631 0.387728</span></span>
<span id="cb19-363"><a href="#cb19-363" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball Away (Ball), Fastball Away (Ball), Fastball Away (Strike)    501 0.802049</span></span>
<span id="cb19-364"><a href="#cb19-364" aria-hidden="true" tabindex="-1"></a><span class="in">      Fastball In (Ball), Fastball In (Ball), Fastball In (Strike)    468 0.821028</span></span>
<span id="cb19-365"><a href="#cb19-365" aria-hidden="true" tabindex="-1"></a><span class="in">      Fastball Up (Ball), Fastball Up (Ball), Fastball Up (Strike)    428 0.622862</span></span>
<span id="cb19-366"><a href="#cb19-366" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball Away (Ball), Fastball Away (Ball), Fastball Down (Strike)    416 0.723564</span></span>
<span id="cb19-367"><a href="#cb19-367" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking Down (Ball), Breaking Down (Ball), Fastball In (Strike)    391 0.732282</span></span>
<span id="cb19-368"><a href="#cb19-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-369"><a href="#cb19-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-370"><a href="#cb19-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-371"><a href="#cb19-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-374"><a href="#cb19-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-375"><a href="#cb19-375" aria-hidden="true" tabindex="-1"></a><span class="co"># I found that binning pitch locations in the previous analysis made the results too granular, and thus, not very statically powerful. For this next analysis, I completed many of the same steps to assess pitch sequences, but did not use the same location data, thus expanding the tests.</span></span>
<span id="cb19-376"><a href="#cb19-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-377"><a href="#cb19-377" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-378"><a href="#cb19-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Terminal 3-pitch sequences → OPS by sequence (OBP + SLG)</span></span>
<span id="cb19-379"><a href="#cb19-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps "Other" pitches in df, but DROPS sequences that contain "Other"</span></span>
<span id="cb19-380"><a href="#cb19-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Inside/Away anchored to RIGHT-HANDED perspective for ALL batters</span></span>
<span id="cb19-381"><a href="#cb19-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: pandas, numpy</span></span>
<span id="cb19-382"><a href="#cb19-382" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Only change vs working script: sequence uses PITCH CLASS ONLY</span></span>
<span id="cb19-383"><a href="#cb19-383" aria-hidden="true" tabindex="-1"></a><span class="co">#       e.g., "Fastball, Fastball, Curveball" (no location features).</span></span>
<span id="cb19-384"><a href="#cb19-384" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb19-385"><a href="#cb19-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-386"><a href="#cb19-386" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-387"><a href="#cb19-387" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-388"><a href="#cb19-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-389"><a href="#cb19-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure long sequence strings are fully visible when printed</span></span>
<span id="cb19-390"><a href="#cb19-390" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb19-391"><a href="#cb19-391" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb19-392"><a href="#cb19-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-393"><a href="#cb19-393" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-394"><a href="#cb19-394" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Columns &amp; NA handling</span></span>
<span id="cb19-395"><a href="#cb19-395" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-396"><a href="#cb19-396" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed to build pitch_desc for every pitch in sequences:</span></span>
<span id="cb19-397"><a href="#cb19-397" aria-hidden="true" tabindex="-1"></a>cols_for_desc <span class="op">=</span> [</span>
<span id="cb19-398"><a href="#cb19-398" aria-hidden="true" tabindex="-1"></a>    <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>,</span>
<span id="cb19-399"><a href="#cb19-399" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pitch_name"</span>, <span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span></span>
<span id="cb19-400"><a href="#cb19-400" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-401"><a href="#cb19-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-402"><a href="#cb19-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns needed at the terminal pitch to compute PA outcome</span></span>
<span id="cb19-403"><a href="#cb19-403" aria-hidden="true" tabindex="-1"></a>cols_for_pa <span class="op">=</span> [<span class="st">"events"</span>]</span>
<span id="cb19-404"><a href="#cb19-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-405"><a href="#cb19-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Check presence</span></span>
<span id="cb19-406"><a href="#cb19-406" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_for_desc <span class="op">+</span> cols_for_pa:</span>
<span id="cb19-407"><a href="#cb19-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb19-408"><a href="#cb19-408" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Required column missing: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-409"><a href="#cb19-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-410"><a href="#cb19-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric for computations</span></span>
<span id="cb19-411"><a href="#cb19-411" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"plate_x"</span>, <span class="st">"plate_z"</span>, <span class="st">"sz_top"</span>, <span class="st">"sz_bot"</span>]:</span>
<span id="cb19-412"><a href="#cb19-412" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> pd.to_numeric(df[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb19-413"><a href="#cb19-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-414"><a href="#cb19-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows that cannot contribute to sequences due to missing location/zone/pitch info</span></span>
<span id="cb19-415"><a href="#cb19-415" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(subset<span class="op">=</span>cols_for_desc).copy()</span>
<span id="cb19-416"><a href="#cb19-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-417"><a href="#cb19-417" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-418"><a href="#cb19-418" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Pitch class mapping (KEEP "Other"; we will filter sequences later)</span></span>
<span id="cb19-419"><a href="#cb19-419" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-420"><a href="#cb19-420" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb19-421"><a href="#cb19-421" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-422"><a href="#cb19-422" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-423"><a href="#cb19-423" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-424"><a href="#cb19-424" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-425"><a href="#cb19-425" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-426"><a href="#cb19-426" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-427"><a href="#cb19-427" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-428"><a href="#cb19-428" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-429"><a href="#cb19-429" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-430"><a href="#cb19-430" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-431"><a href="#cb19-431" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-432"><a href="#cb19-432" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-433"><a href="#cb19-433" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-434"><a href="#cb19-434" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-435"><a href="#cb19-435" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-436"><a href="#cb19-436" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-437"><a href="#cb19-437" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-438"><a href="#cb19-438" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-439"><a href="#cb19-439" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-440"><a href="#cb19-440" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-441"><a href="#cb19-441" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-442"><a href="#cb19-442" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-443"><a href="#cb19-443" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-444"><a href="#cb19-444" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-445"><a href="#cb19-445" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_cat"</span>]   <span class="op">=</span> df[<span class="st">"pitch_class"</span>]  <span class="co"># optional alias</span></span>
<span id="cb19-446"><a href="#cb19-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-447"><a href="#cb19-447" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-448"><a href="#cb19-448" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Rule-book zone + directions (UNCHANGED; not used for sequence now)</span></span>
<span id="cb19-449"><a href="#cb19-449" aria-hidden="true" tabindex="-1"></a><span class="co">#     - In/Away uses RHB perspective for everyone:</span></span>
<span id="cb19-450"><a href="#cb19-450" aria-hidden="true" tabindex="-1"></a><span class="co">#         plate_x &lt; -0.15 → "In", plate_x &gt; 0.15 → "Away", else "Middle"</span></span>
<span id="cb19-451"><a href="#cb19-451" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Strike if within plate edges and between sz_bot/sz_top</span></span>
<span id="cb19-452"><a href="#cb19-452" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Direction picks the more extreme axis between Up/Down and In/Away</span></span>
<span id="cb19-453"><a href="#cb19-453" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-454"><a href="#cb19-454" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># ft (17" plate / 2)</span></span>
<span id="cb19-455"><a href="#cb19-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-456"><a href="#cb19-456" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb19-457"><a href="#cb19-457" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb19-458"><a href="#cb19-458" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-459"><a href="#cb19-459" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-460"><a href="#cb19-460" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)  <span class="co"># guard</span></span>
<span id="cb19-461"><a href="#cb19-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-462"><a href="#cb19-462" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb19-463"><a href="#cb19-463" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb19-464"><a href="#cb19-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-465"><a href="#cb19-465" aria-hidden="true" tabindex="-1"></a><span class="co"># In-zone (NA-safe → False)</span></span>
<span id="cb19-466"><a href="#cb19-466" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb19-467"><a href="#cb19-467" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb19-468"><a href="#cb19-468" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb19-469"><a href="#cb19-469" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb19-470"><a href="#cb19-470" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-471"><a href="#cb19-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-472"><a href="#cb19-472" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizontal direction anchored to RHB, NA-safe</span></span>
<span id="cb19-473"><a href="#cb19-473" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-474"><a href="#cb19-474" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-475"><a href="#cb19-475" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-476"><a href="#cb19-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-477"><a href="#cb19-477" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical direction, NA-safe</span></span>
<span id="cb19-478"><a href="#cb19-478" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-479"><a href="#cb19-479" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-480"><a href="#cb19-480" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-481"><a href="#cb19-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-482"><a href="#cb19-482" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the most extreme axis</span></span>
<span id="cb19-483"><a href="#cb19-483" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-484"><a href="#cb19-484" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-485"><a href="#cb19-485" aria-hidden="true" tabindex="-1"></a>is_vert  <span class="op">=</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-486"><a href="#cb19-486" aria-hidden="true" tabindex="-1"></a>is_horiz <span class="op">=</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-487"><a href="#cb19-487" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> is_vert</span>
<span id="cb19-488"><a href="#cb19-488" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> is_horiz</span>
<span id="cb19-489"><a href="#cb19-489" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-490"><a href="#cb19-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-491"><a href="#cb19-491" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb19-492"><a href="#cb19-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-493"><a href="#cb19-493" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb19-494"><a href="#cb19-494" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb19-495"><a href="#cb19-495" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb19-496"><a href="#cb19-496" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-497"><a href="#cb19-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-498"><a href="#cb19-498" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-499"><a href="#cb19-499" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Terminal 3-pitch sequence (PA must have ≥3 pitches)</span></span>
<span id="cb19-500"><a href="#cb19-500" aria-hidden="true" tabindex="-1"></a><span class="co">#     - Keep "Other" in df, but DROP sequences containing any "Other"</span></span>
<span id="cb19-501"><a href="#cb19-501" aria-hidden="true" tabindex="-1"></a><span class="co">#     - ONLY CHANGE: build sequence from PITCH CLASS ONLY</span></span>
<span id="cb19-502"><a href="#cb19-502" aria-hidden="true" tabindex="-1"></a><span class="co">#       e.g., "Fastball, Fastball, Curveball"</span></span>
<span id="cb19-503"><a href="#cb19-503" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-504"><a href="#cb19-504" aria-hidden="true" tabindex="-1"></a>df_sorted <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]).copy()</span>
<span id="cb19-505"><a href="#cb19-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-506"><a href="#cb19-506" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark last pitch per PA</span></span>
<span id="cb19-507"><a href="#cb19-507" aria-hidden="true" tabindex="-1"></a>max_pitch_num <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_number"</span>].transform(<span class="st">"max"</span>)</span>
<span id="cb19-508"><a href="#cb19-508" aria-hidden="true" tabindex="-1"></a>is_last <span class="op">=</span> (df_sorted[<span class="st">"pitch_number"</span>] <span class="op">==</span> max_pitch_num)</span>
<span id="cb19-509"><a href="#cb19-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-510"><a href="#cb19-510" aria-hidden="true" tabindex="-1"></a><span class="co"># Previous two pitch_desc and pitch_class within PA</span></span>
<span id="cb19-511"><a href="#cb19-511" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m1"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb19-512"><a href="#cb19-512" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"desc_m2"</span>]  <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_desc"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb19-513"><a href="#cb19-513" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m1"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb19-514"><a href="#cb19-514" aria-hidden="true" tabindex="-1"></a>df_sorted[<span class="st">"class_m2"</span>] <span class="op">=</span> df_sorted.groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])[<span class="st">"pitch_class"</span>].shift(<span class="dv">2</span>)</span>
<span id="cb19-515"><a href="#cb19-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-516"><a href="#cb19-516" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only terminal rows with two priors (PA length ≥ 3) — unchanged condition</span></span>
<span id="cb19-517"><a href="#cb19-517" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> df_sorted.loc[</span>
<span id="cb19-518"><a href="#cb19-518" aria-hidden="true" tabindex="-1"></a>    is_last <span class="op">&amp;</span> df_sorted[<span class="st">"desc_m2"</span>].notna(),</span>
<span id="cb19-519"><a href="#cb19-519" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb19-520"><a href="#cb19-520" aria-hidden="true" tabindex="-1"></a>        <span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>,</span>
<span id="cb19-521"><a href="#cb19-521" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_desc"</span>, <span class="st">"desc_m1"</span>, <span class="st">"desc_m2"</span>,</span>
<span id="cb19-522"><a href="#cb19-522" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pitch_class"</span>, <span class="st">"class_m1"</span>, <span class="st">"class_m2"</span>,</span>
<span id="cb19-523"><a href="#cb19-523" aria-hidden="true" tabindex="-1"></a>        <span class="st">"events"</span></span>
<span id="cb19-524"><a href="#cb19-524" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-525"><a href="#cb19-525" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb19-526"><a href="#cb19-526" aria-hidden="true" tabindex="-1"></a>terminal.rename(columns<span class="op">=</span>{<span class="st">"pitch_class"</span>: <span class="st">"class_final"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-527"><a href="#cb19-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-528"><a href="#cb19-528" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset index to avoid duplicate-index alignment issues during assignment</span></span>
<span id="cb19-529"><a href="#cb19-529" aria-hidden="true" tabindex="-1"></a>terminal.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-530"><a href="#cb19-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-531"><a href="#cb19-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Need valid events to compute OPS; normalize to lower-case strings</span></span>
<span id="cb19-532"><a href="#cb19-532" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> terminal[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-533"><a href="#cb19-533" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally collapse common variants to canonical labels</span></span>
<span id="cb19-534"><a href="#cb19-534" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"events"</span>] <span class="op">=</span> (</span>
<span id="cb19-535"><a href="#cb19-535" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"events"</span>]</span>
<span id="cb19-536"><a href="#cb19-536" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"intentional_walk"</span>, <span class="st">"intent_walk"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-537"><a href="#cb19-537" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"home run"</span>, <span class="st">"home_run"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-538"><a href="#cb19-538" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-539"><a href="#cb19-539" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="st">"sacrifice_bunt"</span>, <span class="st">"sac_bunt"</span>, regex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-540"><a href="#cb19-540" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-541"><a href="#cb19-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-542"><a href="#cb19-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove sequences that include ANY "Other" pitch</span></span>
<span id="cb19-543"><a href="#cb19-543" aria-hidden="true" tabindex="-1"></a>mask_has_other <span class="op">=</span> (</span>
<span id="cb19-544"><a href="#cb19-544" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_final"</span>] <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb19-545"><a href="#cb19-545" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m1"</span>]   <span class="op">==</span> <span class="st">"Other"</span>) <span class="op">|</span></span>
<span id="cb19-546"><a href="#cb19-546" aria-hidden="true" tabindex="-1"></a>    (terminal[<span class="st">"class_m2"</span>]   <span class="op">==</span> <span class="st">"Other"</span>)</span>
<span id="cb19-547"><a href="#cb19-547" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-548"><a href="#cb19-548" aria-hidden="true" tabindex="-1"></a>terminal <span class="op">=</span> terminal.loc[<span class="op">~</span>mask_has_other].copy()</span>
<span id="cb19-549"><a href="#cb19-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-550"><a href="#cb19-550" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- ONLY CHANGE: sequence = last three PITCH CLASSES ----------</span></span>
<span id="cb19-551"><a href="#cb19-551" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"sequence"</span>] <span class="op">=</span> (</span>
<span id="cb19-552"><a href="#cb19-552" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_m2"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span></span>
<span id="cb19-553"><a href="#cb19-553" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_m1"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">", "</span> <span class="op">+</span></span>
<span id="cb19-554"><a href="#cb19-554" aria-hidden="true" tabindex="-1"></a>    terminal[<span class="st">"class_final"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb19-555"><a href="#cb19-555" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-556"><a href="#cb19-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-557"><a href="#cb19-557" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-558"><a href="#cb19-558" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) From terminal 'events' → PA outcome components</span></span>
<span id="cb19-559"><a href="#cb19-559" aria-hidden="true" tabindex="-1"></a><span class="co">#     OBP = (H + BB + HBP) / (AB + BB + HBP + SF)</span></span>
<span id="cb19-560"><a href="#cb19-560" aria-hidden="true" tabindex="-1"></a><span class="co">#     SLG = TB / AB</span></span>
<span id="cb19-561"><a href="#cb19-561" aria-hidden="true" tabindex="-1"></a><span class="co">#     OPS = OBP + SLG</span></span>
<span id="cb19-562"><a href="#cb19-562" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-563"><a href="#cb19-563" aria-hidden="true" tabindex="-1"></a>HIT_EVENTS <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb19-564"><a href="#cb19-564" aria-hidden="true" tabindex="-1"></a>BB_EVENTS  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb19-565"><a href="#cb19-565" aria-hidden="true" tabindex="-1"></a>HBP_EVENTS <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb19-566"><a href="#cb19-566" aria-hidden="true" tabindex="-1"></a>SF_EVENTS  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sac_fly_double_play"</span>}  <span class="co"># include DP variant as SF</span></span>
<span id="cb19-567"><a href="#cb19-567" aria-hidden="true" tabindex="-1"></a>SH_EVENTS  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb19-568"><a href="#cb19-568" aria-hidden="true" tabindex="-1"></a>CI_EVENTS  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb19-569"><a href="#cb19-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-570"><a href="#cb19-570" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> terminal[<span class="st">"events"</span>]  <span class="co"># same index as terminal after reset_index</span></span>
<span id="cb19-571"><a href="#cb19-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-572"><a href="#cb19-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Use NumPy arrays for assignment to avoid any reindex attempts</span></span>
<span id="cb19-573"><a href="#cb19-573" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_H"</span>]   <span class="op">=</span> ev.isin(HIT_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-574"><a href="#cb19-574" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_BB"</span>]  <span class="op">=</span> ev.isin(BB_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-575"><a href="#cb19-575" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_HBP"</span>] <span class="op">=</span> ev.isin(HBP_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-576"><a href="#cb19-576" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SF"</span>]  <span class="op">=</span> ev.isin(SF_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-577"><a href="#cb19-577" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_SH"</span>]  <span class="op">=</span> ev.isin(SH_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-578"><a href="#cb19-578" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_CI"</span>]  <span class="op">=</span> ev.isin(CI_EVENTS).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-579"><a href="#cb19-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-580"><a href="#cb19-580" aria-hidden="true" tabindex="-1"></a><span class="co"># Total bases per PA</span></span>
<span id="cb19-581"><a href="#cb19-581" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb19-582"><a href="#cb19-582" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).to_numpy(dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-583"><a href="#cb19-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-584"><a href="#cb19-584" aria-hidden="true" tabindex="-1"></a><span class="co"># At-bat indicator (AB excludes BB, HBP, SF, SH, CI)</span></span>
<span id="cb19-585"><a href="#cb19-585" aria-hidden="true" tabindex="-1"></a>terminal[<span class="st">"pa_AB"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> terminal[[<span class="st">"pa_BB"</span>, <span class="st">"pa_HBP"</span>, <span class="st">"pa_SF"</span>, <span class="st">"pa_SH"</span>, <span class="st">"pa_CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb19-586"><a href="#cb19-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-587"><a href="#cb19-587" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-588"><a href="#cb19-588" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to sequence level, compute OPS, filter n_pas &gt;= 20</span></span>
<span id="cb19-589"><a href="#cb19-589" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-590"><a href="#cb19-590" aria-hidden="true" tabindex="-1"></a>seq_agg <span class="op">=</span> (</span>
<span id="cb19-591"><a href="#cb19-591" aria-hidden="true" tabindex="-1"></a>    terminal.groupby(<span class="st">"sequence"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-592"><a href="#cb19-592" aria-hidden="true" tabindex="-1"></a>            .agg(</span>
<span id="cb19-593"><a href="#cb19-593" aria-hidden="true" tabindex="-1"></a>                n_pas<span class="op">=</span>(<span class="st">"sequence"</span>, <span class="st">"size"</span>),</span>
<span id="cb19-594"><a href="#cb19-594" aria-hidden="true" tabindex="-1"></a>                H<span class="op">=</span>(<span class="st">"pa_H"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-595"><a href="#cb19-595" aria-hidden="true" tabindex="-1"></a>                BB<span class="op">=</span>(<span class="st">"pa_BB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-596"><a href="#cb19-596" aria-hidden="true" tabindex="-1"></a>                HBP<span class="op">=</span>(<span class="st">"pa_HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-597"><a href="#cb19-597" aria-hidden="true" tabindex="-1"></a>                SF<span class="op">=</span>(<span class="st">"pa_SF"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-598"><a href="#cb19-598" aria-hidden="true" tabindex="-1"></a>                AB<span class="op">=</span>(<span class="st">"pa_AB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-599"><a href="#cb19-599" aria-hidden="true" tabindex="-1"></a>                TB<span class="op">=</span>(<span class="st">"pa_TB"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-600"><a href="#cb19-600" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-601"><a href="#cb19-601" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-602"><a href="#cb19-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-603"><a href="#cb19-603" aria-hidden="true" tabindex="-1"></a><span class="co"># OBP &amp; SLG (avoid division by zero)</span></span>
<span id="cb19-604"><a href="#cb19-604" aria-hidden="true" tabindex="-1"></a>denom_obp <span class="op">=</span> seq_agg[<span class="st">"AB"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SF"</span>]</span>
<span id="cb19-605"><a href="#cb19-605" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>, (seq_agg[<span class="st">"H"</span>] <span class="op">+</span> seq_agg[<span class="st">"BB"</span>] <span class="op">+</span> seq_agg[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp, np.nan)</span>
<span id="cb19-606"><a href="#cb19-606" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(seq_agg[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, seq_agg[<span class="st">"TB"</span>] <span class="op">/</span> seq_agg[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb19-607"><a href="#cb19-607" aria-hidden="true" tabindex="-1"></a>seq_agg[<span class="st">"OPS"</span>] <span class="op">=</span> seq_agg[<span class="st">"OBP"</span>] <span class="op">+</span> seq_agg[<span class="st">"SLG"</span>]</span>
<span id="cb19-608"><a href="#cb19-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-609"><a href="#cb19-609" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only sequences with at least 20 PAs and valid OPS; show only n_pas and OPS</span></span>
<span id="cb19-610"><a href="#cb19-610" aria-hidden="true" tabindex="-1"></a>final_stats <span class="op">=</span> (</span>
<span id="cb19-611"><a href="#cb19-611" aria-hidden="true" tabindex="-1"></a>    seq_agg[(seq_agg[<span class="st">"n_pas"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>) <span class="op">&amp;</span> (seq_agg[<span class="st">"OPS"</span>].notna())]</span>
<span id="cb19-612"><a href="#cb19-612" aria-hidden="true" tabindex="-1"></a>    .loc[:, [<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]]</span>
<span id="cb19-613"><a href="#cb19-613" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])  <span class="co"># sort high→low by default</span></span>
<span id="cb19-614"><a href="#cb19-614" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-615"><a href="#cb19-615" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-616"><a href="#cb19-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-617"><a href="#cb19-617" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-618"><a href="#cb19-618" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Top 10 lowest / highest / most common (ONLY n_pas and OPS)</span></span>
<span id="cb19-619"><a href="#cb19-619" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-620"><a href="#cb19-620" aria-hidden="true" tabindex="-1"></a>top10_lowest <span class="op">=</span> (</span>
<span id="cb19-621"><a href="#cb19-621" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb19-622"><a href="#cb19-622" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-623"><a href="#cb19-623" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-624"><a href="#cb19-624" aria-hidden="true" tabindex="-1"></a>top10_highest <span class="op">=</span> (</span>
<span id="cb19-625"><a href="#cb19-625" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"OPS"</span>, <span class="st">"n_pas"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">False</span>])</span>
<span id="cb19-626"><a href="#cb19-626" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-627"><a href="#cb19-627" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-628"><a href="#cb19-628" aria-hidden="true" tabindex="-1"></a>top10_common <span class="op">=</span> (</span>
<span id="cb19-629"><a href="#cb19-629" aria-hidden="true" tabindex="-1"></a>    final_stats.sort_values([<span class="st">"n_pas"</span>, <span class="st">"sequence"</span>], ascending<span class="op">=</span>[<span class="va">False</span>, <span class="va">True</span>])</span>
<span id="cb19-630"><a href="#cb19-630" aria-hidden="true" tabindex="-1"></a>               .head(<span class="dv">10</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-631"><a href="#cb19-631" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-632"><a href="#cb19-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-633"><a href="#cb19-633" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-634"><a href="#cb19-634" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Display / export (optional)</span></span>
<span id="cb19-635"><a href="#cb19-635" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb19-636"><a href="#cb19-636" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-637"><a href="#cb19-637" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_lowest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-638"><a href="#cb19-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-639"><a href="#cb19-639" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-640"><a href="#cb19-640" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_highest.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-641"><a href="#cb19-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-642"><a href="#cb19-642" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Top 10 CLASS-ONLY sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ==="</span>)</span>
<span id="cb19-643"><a href="#cb19-643" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(top10_common.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-644"><a href="#cb19-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-645"><a href="#cb19-645" aria-hidden="true" tabindex="-1"></a><span class="co"># # Optionally save:</span></span>
<span id="cb19-646"><a href="#cb19-646" aria-hidden="true" tabindex="-1"></a><span class="co"># final_stats.to_csv("sequence_ops_summary_classONLY_min20.csv", index=False)</span></span>
<span id="cb19-647"><a href="#cb19-647" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_lowest.to_csv("top10_lowest_ops_sequences_classONLY_min20.csv", index=False)</span></span>
<span id="cb19-648"><a href="#cb19-648" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_highest.to_csv("top10_highest_ops_sequences_classONLY_min20.csv", index=False)</span></span>
<span id="cb19-649"><a href="#cb19-649" aria-hidden="true" tabindex="-1"></a><span class="co"># top10_common.to_csv("top10_most_common_sequences_ops_classONLY_min20.csv", index=False)</span></span>
<span id="cb19-650"><a href="#cb19-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-651"><a href="#cb19-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-652"><a href="#cb19-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-653"><a href="#cb19-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-654"><a href="#cb19-654" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Evidence: selected outputs kept for interpretability. --&gt;</span></span>
<span id="cb19-655"><a href="#cb19-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-656"><a href="#cb19-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-657"><a href="#cb19-657" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-658"><a href="#cb19-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-659"><a href="#cb19-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-660"><a href="#cb19-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-661"><a href="#cb19-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-662"><a href="#cb19-662" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 CLASS-ONLY sequences — LOWEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-663"><a href="#cb19-663" aria-hidden="true" tabindex="-1"></a><span class="in">                    sequence  n_pas      OPS</span></span>
<span id="cb19-664"><a href="#cb19-664" aria-hidden="true" tabindex="-1"></a><span class="in">      Change, Change, Change   4661 0.505688</span></span>
<span id="cb19-665"><a href="#cb19-665" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking, Breaking, Change   3179 0.520671</span></span>
<span id="cb19-666"><a href="#cb19-666" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Breaking, Breaking  25343 0.522692</span></span>
<span id="cb19-667"><a href="#cb19-667" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Breaking, Breaking  20000 0.525544</span></span>
<span id="cb19-668"><a href="#cb19-668" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball, Breaking, Change   5495 0.538381</span></span>
<span id="cb19-669"><a href="#cb19-669" aria-hidden="true" tabindex="-1"></a><span class="in">    Change, Breaking, Change   2438 0.549796</span></span>
<span id="cb19-670"><a href="#cb19-670" aria-hidden="true" tabindex="-1"></a><span class="in">    Fastball, Change, Change   9321 0.553125</span></span>
<span id="cb19-671"><a href="#cb19-671" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball, Change, Breaking   4844 0.561085</span></span>
<span id="cb19-672"><a href="#cb19-672" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Fastball, Breaking  33190 0.568219</span></span>
<span id="cb19-673"><a href="#cb19-673" aria-hidden="true" tabindex="-1"></a><span class="in">    Breaking, Change, Change   3464 0.572111</span></span>
<span id="cb19-674"><a href="#cb19-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-675"><a href="#cb19-675" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 CLASS-ONLY sequences — HIGHEST OPS (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-676"><a href="#cb19-676" aria-hidden="true" tabindex="-1"></a><span class="in">                    sequence  n_pas      OPS</span></span>
<span id="cb19-677"><a href="#cb19-677" aria-hidden="true" tabindex="-1"></a><span class="in">  Change, Fastball, Fastball  13134 0.759152</span></span>
<span id="cb19-678"><a href="#cb19-678" aria-hidden="true" tabindex="-1"></a><span class="in">    Change, Change, Fastball   8148 0.750642</span></span>
<span id="cb19-679"><a href="#cb19-679" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Fastball, Fastball  70505 0.732533</span></span>
<span id="cb19-680"><a href="#cb19-680" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball, Change, Fastball  14741 0.730778</span></span>
<span id="cb19-681"><a href="#cb19-681" aria-hidden="true" tabindex="-1"></a><span class="in">  Change, Breaking, Fastball   4503 0.714981</span></span>
<span id="cb19-682"><a href="#cb19-682" aria-hidden="true" tabindex="-1"></a><span class="in">  Breaking, Change, Fastball   5955 0.709868</span></span>
<span id="cb19-683"><a href="#cb19-683" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Breaking, Fastball  31953 0.703844</span></span>
<span id="cb19-684"><a href="#cb19-684" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Fastball, Fastball  29800 0.696462</span></span>
<span id="cb19-685"><a href="#cb19-685" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Breaking, Fastball  23819 0.679377</span></span>
<span id="cb19-686"><a href="#cb19-686" aria-hidden="true" tabindex="-1"></a><span class="in">    Change, Fastball, Change   7329 0.617856</span></span>
<span id="cb19-687"><a href="#cb19-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-688"><a href="#cb19-688" aria-hidden="true" tabindex="-1"></a><span class="in">=== Top 10 CLASS-ONLY sequences — MOST COMMON (n_pas ≥ 20; no 'Other' in sequence) ===</span></span>
<span id="cb19-689"><a href="#cb19-689" aria-hidden="true" tabindex="-1"></a><span class="in">                    sequence  n_pas      OPS</span></span>
<span id="cb19-690"><a href="#cb19-690" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Fastball, Fastball  70505 0.732533</span></span>
<span id="cb19-691"><a href="#cb19-691" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Fastball, Breaking  33190 0.568219</span></span>
<span id="cb19-692"><a href="#cb19-692" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Breaking, Fastball  31953 0.703844</span></span>
<span id="cb19-693"><a href="#cb19-693" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Fastball, Fastball  29800 0.696462</span></span>
<span id="cb19-694"><a href="#cb19-694" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball, Breaking, Breaking  25343 0.522692</span></span>
<span id="cb19-695"><a href="#cb19-695" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Breaking, Fastball  23819 0.679377</span></span>
<span id="cb19-696"><a href="#cb19-696" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Fastball, Breaking  21745 0.608894</span></span>
<span id="cb19-697"><a href="#cb19-697" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking, Breaking, Breaking  20000 0.525544</span></span>
<span id="cb19-698"><a href="#cb19-698" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball, Change, Fastball  14741 0.730778</span></span>
<span id="cb19-699"><a href="#cb19-699" aria-hidden="true" tabindex="-1"></a><span class="in">  Fastball, Fastball, Change  14171 0.598230</span></span>
<span id="cb19-700"><a href="#cb19-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-701"><a href="#cb19-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-702"><a href="#cb19-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-703"><a href="#cb19-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-704"><a href="#cb19-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-705"><a href="#cb19-705" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitch Sequencing (Class-level)</span></span>
<span id="cb19-706"><a href="#cb19-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-707"><a href="#cb19-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-710"><a href="#cb19-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-711"><a href="#cb19-711" aria-hidden="true" tabindex="-1"></a><span class="co"># I encoded pitch-class order (FB/BRK/CH) and quantified its relationship to outcomes in order to identify **repeatable** sequencing templates to script early counts for pitchers.</span></span>
<span id="cb19-712"><a href="#cb19-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-713"><a href="#cb19-713" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-714"><a href="#cb19-714" aria-hidden="true" tabindex="-1"></a><span class="co">Three-pitch class-only table (27 rows) coloured by OPS.</span></span>
<span id="cb19-715"><a href="#cb19-715" aria-hidden="true" tabindex="-1"></a><span class="co">Assumes `final_stats` DataFrame already exists with columns:</span></span>
<span id="cb19-716"><a href="#cb19-716" aria-hidden="true" tabindex="-1"></a><span class="co">    sequence | n_pas | OPS</span></span>
<span id="cb19-717"><a href="#cb19-717" aria-hidden="true" tabindex="-1"></a><span class="co">and contains only class-level sequences </span></span>
<span id="cb19-718"><a href="#cb19-718" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-719"><a href="#cb19-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-720"><a href="#cb19-720" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb19-721"><a href="#cb19-721" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-722"><a href="#cb19-722" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-723"><a href="#cb19-723" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-724"><a href="#cb19-724" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb19-725"><a href="#cb19-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-726"><a href="#cb19-726" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-727"><a href="#cb19-727" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Enumerate every three-pitch class combination (27 rows)</span></span>
<span id="cb19-728"><a href="#cb19-728" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-729"><a href="#cb19-729" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">"Fastball"</span>, <span class="st">"Breaking"</span>, <span class="st">"Change"</span>]</span>
<span id="cb19-730"><a href="#cb19-730" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> [</span>
<span id="cb19-731"><a href="#cb19-731" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb19-732"><a href="#cb19-732" aria-hidden="true" tabindex="-1"></a>        <span class="st">"first"</span>: f, <span class="st">"second"</span>: s, <span class="st">"third"</span>: t,</span>
<span id="cb19-733"><a href="#cb19-733" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sequence"</span>: <span class="ss">f"</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-734"><a href="#cb19-734" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-735"><a href="#cb19-735" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f, s, t <span class="kw">in</span> itertools.product(classes, repeat<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-736"><a href="#cb19-736" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-737"><a href="#cb19-737" aria-hidden="true" tabindex="-1"></a>all_seq <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb19-738"><a href="#cb19-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-739"><a href="#cb19-739" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-740"><a href="#cb19-740" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Merge with stats so missing combos show NaN</span></span>
<span id="cb19-741"><a href="#cb19-741" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-742"><a href="#cb19-742" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> (</span>
<span id="cb19-743"><a href="#cb19-743" aria-hidden="true" tabindex="-1"></a>    all_seq</span>
<span id="cb19-744"><a href="#cb19-744" aria-hidden="true" tabindex="-1"></a>    .merge(final_stats[[<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]], on<span class="op">=</span><span class="st">"sequence"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb19-745"><a href="#cb19-745" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>])</span>
<span id="cb19-746"><a href="#cb19-746" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-747"><a href="#cb19-747" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-748"><a href="#cb19-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-749"><a href="#cb19-749" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-750"><a href="#cb19-750" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Colour map: green (low) → yellow (≈0.710) → red (high)</span></span>
<span id="cb19-751"><a href="#cb19-751" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-752"><a href="#cb19-752" aria-hidden="true" tabindex="-1"></a>vmin <span class="op">=</span> <span class="fl">0.410</span></span>
<span id="cb19-753"><a href="#cb19-753" aria-hidden="true" tabindex="-1"></a>vmax <span class="op">=</span> <span class="fl">0.850</span></span>
<span id="cb19-754"><a href="#cb19-754" aria-hidden="true" tabindex="-1"></a>mid  <span class="op">=</span> <span class="fl">0.710</span>                                  <span class="co"># centre point requested</span></span>
<span id="cb19-755"><a href="#cb19-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-756"><a href="#cb19-756" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> matplotlib.colors.TwoSlopeNorm(vmin<span class="op">=</span>vmin, vcenter<span class="op">=</span>mid, vmax<span class="op">=</span>vmax)</span>
<span id="cb19-757"><a href="#cb19-757" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> plt.cm.get_cmap(<span class="st">"RdYlGn_r"</span>)             <span class="co"># reversed so high =&gt; red</span></span>
<span id="cb19-758"><a href="#cb19-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-759"><a href="#cb19-759" aria-hidden="true" tabindex="-1"></a>row_colors <span class="op">=</span> [</span>
<span id="cb19-760"><a href="#cb19-760" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#dddddd"</span> <span class="cf">if</span> np.isnan(v)                   <span class="co"># grey rows = no PAs</span></span>
<span id="cb19-761"><a href="#cb19-761" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> matplotlib.colors.to_hex(cmap(norm(v)))</span>
<span id="cb19-762"><a href="#cb19-762" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> merged[<span class="st">"OPS"</span>]</span>
<span id="cb19-763"><a href="#cb19-763" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-764"><a href="#cb19-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-765"><a href="#cb19-765" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-766"><a href="#cb19-766" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot a single figure containing the coloured table</span></span>
<span id="cb19-767"><a href="#cb19-767" aria-hidden="true" tabindex="-1"></a><span class="co"># ────────────────────────────────────────────────────────────────</span></span>
<span id="cb19-768"><a href="#cb19-768" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">18</span>))        <span class="co"># one figure = rule-compliant</span></span>
<span id="cb19-769"><a href="#cb19-769" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb19-770"><a href="#cb19-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-771"><a href="#cb19-771" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> ax.table(</span>
<span id="cb19-772"><a href="#cb19-772" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>merged[[<span class="st">"sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>]].fillna(<span class="st">""</span>).values,</span>
<span id="cb19-773"><a href="#cb19-773" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Sequence"</span>, <span class="st">"n_pas"</span>, <span class="st">"OPS"</span>],</span>
<span id="cb19-774"><a href="#cb19-774" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb19-775"><a href="#cb19-775" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"center"</span></span>
<span id="cb19-776"><a href="#cb19-776" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-777"><a href="#cb19-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-778"><a href="#cb19-778" aria-hidden="true" tabindex="-1"></a><span class="co"># Style header &amp; data rows</span></span>
<span id="cb19-779"><a href="#cb19-779" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (row, col), cell <span class="kw">in</span> tbl.get_celld().items():</span>
<span id="cb19-780"><a href="#cb19-780" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row <span class="op">==</span> <span class="dv">0</span>:                               <span class="co"># header row</span></span>
<span id="cb19-781"><a href="#cb19-781" aria-hidden="true" tabindex="-1"></a>        cell.set_text_props(weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb19-782"><a href="#cb19-782" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:                                      <span class="co"># data rows</span></span>
<span id="cb19-783"><a href="#cb19-783" aria-hidden="true" tabindex="-1"></a>        cell.set_facecolor(row_colors[row <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb19-784"><a href="#cb19-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-785"><a href="#cb19-785" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb19-786"><a href="#cb19-786" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-787"><a href="#cb19-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-788"><a href="#cb19-788" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: save to file</span></span>
<span id="cb19-789"><a href="#cb19-789" aria-hidden="true" tabindex="-1"></a><span class="co"># fig.savefig("three_pitch_sequences_table_red_to_green.png",</span></span>
<span id="cb19-790"><a href="#cb19-790" aria-hidden="true" tabindex="-1"></a><span class="co">#             dpi=300, bbox_inches="tight")</span></span>
<span id="cb19-791"><a href="#cb19-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-792"><a href="#cb19-792" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-793"><a href="#cb19-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-794"><a href="#cb19-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-795"><a href="#cb19-795" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-796"><a href="#cb19-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-797"><a href="#cb19-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-798"><a href="#cb19-798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-799"><a href="#cb19-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-800"><a href="#cb19-800" aria-hidden="true" tabindex="-1"></a><span class="in">/var/folders/b9/qvkdlgns0d19941by569ptqr0000gn/T/ipykernel_84802/3373149627.py:45: MatplotlibDeprecationWarning: The get_cmap function was deprecated in Matplotlib 3.7 and will be removed in 3.11. Use ``matplotlib.colormaps[name]`` or ``matplotlib.colormaps.get_cmap()`` or ``pyplot.get_cmap()`` instead.</span></span>
<span id="cb19-801"><a href="#cb19-801" aria-hidden="true" tabindex="-1"></a><span class="in">  cmap = plt.cm.get_cmap("RdYlGn_r")             # reversed so high =&gt; red</span></span>
<span id="cb19-802"><a href="#cb19-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-803"><a href="#cb19-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-804"><a href="#cb19-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-805"><a href="#cb19-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-806"><a href="#cb19-806" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-807"><a href="#cb19-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-808"><a href="#cb19-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-809"><a href="#cb19-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-810"><a href="#cb19-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-811"><a href="#cb19-811" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Figure size 900x1800 with 1 Axes&gt;</span></span>
<span id="cb19-812"><a href="#cb19-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-813"><a href="#cb19-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-814"><a href="#cb19-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-815"><a href="#cb19-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-816"><a href="#cb19-816" aria-hidden="true" tabindex="-1"></a><span class="al">![Figure from cell 4](figure_3_1_1.png)</span></span>
<span id="cb19-817"><a href="#cb19-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-818"><a href="#cb19-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-819"><a href="#cb19-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-820"><a href="#cb19-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-823"><a href="#cb19-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-824"><a href="#cb19-824" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-825"><a href="#cb19-825" aria-hidden="true" tabindex="-1"></a><span class="co">TOP-N OPENING SEQUENCES, RANKED BY OPS (WITH LOCATION INFO)</span></span>
<span id="cb19-826"><a href="#cb19-826" aria-hidden="true" tabindex="-1"></a><span class="co">======================================</span></span>
<span id="cb19-827"><a href="#cb19-827" aria-hidden="true" tabindex="-1"></a><span class="co">• Works from a Statcast-like pitch-level DataFrame `df`.</span></span>
<span id="cb19-828"><a href="#cb19-828" aria-hidden="true" tabindex="-1"></a><span class="co">• Produces five tables:</span></span>
<span id="cb19-829"><a href="#cb19-829" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #1   (single pitch context)</span></span>
<span id="cb19-830"><a href="#cb19-830" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #2   (first-two pitches)</span></span>
<span id="cb19-831"><a href="#cb19-831" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #3</span></span>
<span id="cb19-832"><a href="#cb19-832" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #4</span></span>
<span id="cb19-833"><a href="#cb19-833" aria-hidden="true" tabindex="-1"></a><span class="co">      – pitch #5</span></span>
<span id="cb19-834"><a href="#cb19-834" aria-hidden="true" tabindex="-1"></a><span class="co">  Each table shows: context count, ‘ended_here’ count,</span></span>
<span id="cb19-835"><a href="#cb19-835" aria-hidden="true" tabindex="-1"></a><span class="co">  wOBA, OPS, and the literal sequence.</span></span>
<span id="cb19-836"><a href="#cb19-836" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-837"><a href="#cb19-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-838"><a href="#cb19-838" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-839"><a href="#cb19-839" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Imports</span></span>
<span id="cb19-840"><a href="#cb19-840" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-841"><a href="#cb19-841" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-842"><a href="#cb19-842" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-843"><a href="#cb19-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-844"><a href="#cb19-844" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-845"><a href="#cb19-845" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Map pitch names → pitch_class</span></span>
<span id="cb19-846"><a href="#cb19-846" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-847"><a href="#cb19-847" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb19-848"><a href="#cb19-848" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>, <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-849"><a href="#cb19-849" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-850"><a href="#cb19-850" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-851"><a href="#cb19-851" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>, <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-852"><a href="#cb19-852" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>, <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-853"><a href="#cb19-853" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>, <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-854"><a href="#cb19-854" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>, <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-855"><a href="#cb19-855" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>, <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-856"><a href="#cb19-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>, <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-857"><a href="#cb19-857" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>, <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-858"><a href="#cb19-858" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>, <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-859"><a href="#cb19-859" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-860"><a href="#cb19-860" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-861"><a href="#cb19-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-862"><a href="#cb19-862" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-863"><a href="#cb19-863" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Build pitch_desc  (class + direction + zone)</span></span>
<span id="cb19-864"><a href="#cb19-864" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-865"><a href="#cb19-865" aria-hidden="true" tabindex="-1"></a>PLATE_HALF_WIDTH <span class="op">=</span> <span class="fl">0.708</span>  <span class="co"># feet (17" / 2)</span></span>
<span id="cb19-866"><a href="#cb19-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-867"><a href="#cb19-867" aria-hidden="true" tabindex="-1"></a>sz_bot2 <span class="op">=</span> df[<span class="st">"sz_bot"</span>]</span>
<span id="cb19-868"><a href="#cb19-868" aria-hidden="true" tabindex="-1"></a>sz_top2 <span class="op">=</span> df[<span class="st">"sz_top"</span>]</span>
<span id="cb19-869"><a href="#cb19-869" aria-hidden="true" tabindex="-1"></a>z_mid   <span class="op">=</span> (sz_top2 <span class="op">+</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-870"><a href="#cb19-870" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> (sz_top2 <span class="op">-</span> sz_bot2) <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb19-871"><a href="#cb19-871" aria-hidden="true" tabindex="-1"></a>z_half  <span class="op">=</span> z_half.where(z_half <span class="op">&gt;</span> <span class="dv">0</span>, <span class="fl">1.0</span>)</span>
<span id="cb19-872"><a href="#cb19-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-873"><a href="#cb19-873" aria-hidden="true" tabindex="-1"></a>x_norm <span class="op">=</span> df[<span class="st">"plate_x"</span>] <span class="op">/</span> PLATE_HALF_WIDTH</span>
<span id="cb19-874"><a href="#cb19-874" aria-hidden="true" tabindex="-1"></a>z_norm <span class="op">=</span> (df[<span class="st">"plate_z"</span>] <span class="op">-</span> z_mid) <span class="op">/</span> z_half</span>
<span id="cb19-875"><a href="#cb19-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-876"><a href="#cb19-876" aria-hidden="true" tabindex="-1"></a><span class="co"># in–zone?</span></span>
<span id="cb19-877"><a href="#cb19-877" aria-hidden="true" tabindex="-1"></a>in_zone <span class="op">=</span> (</span>
<span id="cb19-878"><a href="#cb19-878" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_x"</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> PLATE_HALF_WIDTH) <span class="op">&amp;</span></span>
<span id="cb19-879"><a href="#cb19-879" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&gt;=</span> sz_bot2) <span class="op">&amp;</span></span>
<span id="cb19-880"><a href="#cb19-880" aria-hidden="true" tabindex="-1"></a>    (df[<span class="st">"plate_z"</span>] <span class="op">&lt;=</span> sz_top2)</span>
<span id="cb19-881"><a href="#cb19-881" aria-hidden="true" tabindex="-1"></a>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-882"><a href="#cb19-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-883"><a href="#cb19-883" aria-hidden="true" tabindex="-1"></a><span class="co"># directions</span></span>
<span id="cb19-884"><a href="#cb19-884" aria-hidden="true" tabindex="-1"></a>cond_in   <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&lt;</span>  <span class="op">-</span><span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-885"><a href="#cb19-885" aria-hidden="true" tabindex="-1"></a>cond_away <span class="op">=</span> (df[<span class="st">"plate_x"</span>] <span class="op">&gt;</span>   <span class="fl">0.15</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-886"><a href="#cb19-886" aria-hidden="true" tabindex="-1"></a>horiz_dir <span class="op">=</span> np.select([cond_in, cond_away], [<span class="st">"In"</span>, <span class="st">"Away"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-887"><a href="#cb19-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-888"><a href="#cb19-888" aria-hidden="true" tabindex="-1"></a>cond_up   <span class="op">=</span> (z_norm <span class="op">&gt;</span>  <span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-889"><a href="#cb19-889" aria-hidden="true" tabindex="-1"></a>cond_down <span class="op">=</span> (z_norm <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.2</span>).fillna(<span class="va">False</span>).to_numpy()</span>
<span id="cb19-890"><a href="#cb19-890" aria-hidden="true" tabindex="-1"></a>vert_dir  <span class="op">=</span> np.select([cond_up, cond_down], [<span class="st">"Up"</span>, <span class="st">"Down"</span>], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-891"><a href="#cb19-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-892"><a href="#cb19-892" aria-hidden="true" tabindex="-1"></a><span class="co"># choose axis with greater deviance</span></span>
<span id="cb19-893"><a href="#cb19-893" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(x_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-894"><a href="#cb19-894" aria-hidden="true" tabindex="-1"></a>az <span class="op">=</span> np.nan_to_num(np.<span class="bu">abs</span>(z_norm.to_numpy()), nan<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb19-895"><a href="#cb19-895" aria-hidden="true" tabindex="-1"></a>prefer_vert  <span class="op">=</span> (az <span class="op">&gt;=</span> ax) <span class="op">&amp;</span> (vert_dir  <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-896"><a href="#cb19-896" aria-hidden="true" tabindex="-1"></a>prefer_horiz <span class="op">=</span> (ax <span class="op">&gt;</span>  az) <span class="op">&amp;</span> (horiz_dir <span class="op">!=</span> <span class="st">"Middle"</span>)</span>
<span id="cb19-897"><a href="#cb19-897" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.select([prefer_vert, prefer_horiz], [vert_dir, horiz_dir], default<span class="op">=</span><span class="st">"Middle"</span>)</span>
<span id="cb19-898"><a href="#cb19-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-899"><a href="#cb19-899" aria-hidden="true" tabindex="-1"></a>zone_label <span class="op">=</span> np.where(in_zone, <span class="st">"Strike"</span>, <span class="st">"Ball"</span>)</span>
<span id="cb19-900"><a href="#cb19-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-901"><a href="#cb19-901" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_desc"</span>] <span class="op">=</span> (</span>
<span id="cb19-902"><a href="#cb19-902" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pitch_class"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> pd.Series(direction, index<span class="op">=</span>df.index) <span class="op">+</span></span>
<span id="cb19-903"><a href="#cb19-903" aria-hidden="true" tabindex="-1"></a>    <span class="st">" ("</span> <span class="op">+</span> pd.Series(zone_label, index<span class="op">=</span>df.index) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb19-904"><a href="#cb19-904" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-905"><a href="#cb19-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-906"><a href="#cb19-906" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-907"><a href="#cb19-907" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Collapse to one row per plate appearance</span></span>
<span id="cb19-908"><a href="#cb19-908" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-909"><a href="#cb19-909" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]) <span class="op">\</span></span>
<span id="cb19-910"><a href="#cb19-910" aria-hidden="true" tabindex="-1"></a>      .groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])</span>
<span id="cb19-911"><a href="#cb19-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-912"><a href="#cb19-912" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> (</span>
<span id="cb19-913"><a href="#cb19-913" aria-hidden="true" tabindex="-1"></a>    g.agg(</span>
<span id="cb19-914"><a href="#cb19-914" aria-hidden="true" tabindex="-1"></a>        pitch_list<span class="op">=</span>(<span class="st">"pitch_desc"</span>, <span class="bu">list</span>),</span>
<span id="cb19-915"><a href="#cb19-915" aria-hidden="true" tabindex="-1"></a>        events<span class="op">=</span>(<span class="st">"events"</span>, <span class="st">"last"</span>)</span>
<span id="cb19-916"><a href="#cb19-916" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-917"><a href="#cb19-917" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb19-918"><a href="#cb19-918" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-919"><a href="#cb19-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-920"><a href="#cb19-920" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"n_pitches"</span>] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb19-921"><a href="#cb19-921" aria-hidden="true" tabindex="-1"></a><span class="co"># grab first five pitches if present</span></span>
<span id="cb19-922"><a href="#cb19-922" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lbl <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>, <span class="st">"fourth"</span>, <span class="st">"fifth"</span>], start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb19-923"><a href="#cb19-923" aria-hidden="true" tabindex="-1"></a>    pa[lbl] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>[i<span class="op">-</span><span class="dv">1</span>].where(pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> i)</span>
<span id="cb19-924"><a href="#cb19-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-925"><a href="#cb19-925" aria-hidden="true" tabindex="-1"></a><span class="co"># flags: PA ended exactly on pitch n?</span></span>
<span id="cb19-926"><a href="#cb19-926" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb19-927"><a href="#cb19-927" aria-hidden="true" tabindex="-1"></a>    pa[<span class="ss">f"end_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (pa[<span class="st">"n_pitches"</span>] <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb19-928"><a href="#cb19-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-929"><a href="#cb19-929" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-930"><a href="#cb19-930" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Per-PA outcome components</span></span>
<span id="cb19-931"><a href="#cb19-931" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-932"><a href="#cb19-932" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> pa[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-933"><a href="#cb19-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-934"><a href="#cb19-934" aria-hidden="true" tabindex="-1"></a><span class="co"># wOBA weights (2024 weights)</span></span>
<span id="cb19-935"><a href="#cb19-935" aria-hidden="true" tabindex="-1"></a>WOBA_WT <span class="op">=</span> {</span>
<span id="cb19-936"><a href="#cb19-936" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_run"</span>: <span class="fl">1.95</span>, <span class="st">"triple"</span>: <span class="fl">1.56</span>, <span class="st">"double"</span>: <span class="fl">1.24</span>, <span class="st">"single"</span>: <span class="fl">0.90</span>,</span>
<span id="cb19-937"><a href="#cb19-937" aria-hidden="true" tabindex="-1"></a>    <span class="st">"walk"</span>: <span class="fl">0.69</span>, <span class="st">"intent_walk"</span>: <span class="fl">0.69</span>, <span class="st">"hit_by_pitch"</span>: <span class="fl">0.72</span></span>
<span id="cb19-938"><a href="#cb19-938" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-939"><a href="#cb19-939" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_numerator"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(WOBA_WT).fillna(<span class="fl">0.0</span>)</span>
<span id="cb19-940"><a href="#cb19-940" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_denom"</span>] <span class="op">=</span> <span class="fl">1.0</span>   <span class="co"># one plate appearance per row</span></span>
<span id="cb19-941"><a href="#cb19-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-942"><a href="#cb19-942" aria-hidden="true" tabindex="-1"></a><span class="co"># OPS components</span></span>
<span id="cb19-943"><a href="#cb19-943" aria-hidden="true" tabindex="-1"></a>HIT <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb19-944"><a href="#cb19-944" aria-hidden="true" tabindex="-1"></a>BB  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb19-945"><a href="#cb19-945" aria-hidden="true" tabindex="-1"></a>HBP <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb19-946"><a href="#cb19-946" aria-hidden="true" tabindex="-1"></a>SF  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly_double_play"</span>}</span>
<span id="cb19-947"><a href="#cb19-947" aria-hidden="true" tabindex="-1"></a>SH  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb19-948"><a href="#cb19-948" aria-hidden="true" tabindex="-1"></a>CI  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb19-949"><a href="#cb19-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-950"><a href="#cb19-950" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"H"</span>]   <span class="op">=</span> ev.isin(HIT).astype(<span class="bu">int</span>)</span>
<span id="cb19-951"><a href="#cb19-951" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"BB"</span>]  <span class="op">=</span> ev.isin(BB).astype(<span class="bu">int</span>)</span>
<span id="cb19-952"><a href="#cb19-952" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"HBP"</span>] <span class="op">=</span> ev.isin(HBP).astype(<span class="bu">int</span>)</span>
<span id="cb19-953"><a href="#cb19-953" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SF"</span>]  <span class="op">=</span> ev.isin(SF).astype(<span class="bu">int</span>)</span>
<span id="cb19-954"><a href="#cb19-954" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SH"</span>]  <span class="op">=</span> ev.isin(SH).astype(<span class="bu">int</span>)</span>
<span id="cb19-955"><a href="#cb19-955" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"CI"</span>]  <span class="op">=</span> ev.isin(CI).astype(<span class="bu">int</span>)</span>
<span id="cb19-956"><a href="#cb19-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-957"><a href="#cb19-957" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb19-958"><a href="#cb19-958" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb19-959"><a href="#cb19-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-960"><a href="#cb19-960" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"AB"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> pa[[<span class="st">"BB"</span>, <span class="st">"HBP"</span>, <span class="st">"SF"</span>, <span class="st">"SH"</span>, <span class="st">"CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-961"><a href="#cb19-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-962"><a href="#cb19-962" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-963"><a href="#cb19-963" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Helper to build N-pitch tables (properly weighted OPS)</span></span>
<span id="cb19-964"><a href="#cb19-964" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-965"><a href="#cb19-965" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_table(n: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-966"><a href="#cb19-966" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">5</span> <span class="kw">or</span> n <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb19-967"><a href="#cb19-967" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be 1–5"</span>)</span>
<span id="cb19-968"><a href="#cb19-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-969"><a href="#cb19-969" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create opening-sequence key</span></span>
<span id="cb19-970"><a href="#cb19-970" aria-hidden="true" tabindex="-1"></a>    seq_col <span class="op">=</span> <span class="ss">f"seq_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-971"><a href="#cb19-971" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb19-972"><a href="#cb19-972" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> pa[<span class="st">"first"</span>]</span>
<span id="cb19-973"><a href="#cb19-973" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-974"><a href="#cb19-974" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">=</span> [pa[<span class="st">"first"</span>], pa[<span class="st">"second"</span>], pa[<span class="st">"third"</span>],</span>
<span id="cb19-975"><a href="#cb19-975" aria-hidden="true" tabindex="-1"></a>                 pa.get(<span class="st">"fourth"</span>), pa.get(<span class="st">"fifth"</span>)][:n]</span>
<span id="cb19-976"><a href="#cb19-976" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> parts[<span class="dv">0</span>]</span>
<span id="cb19-977"><a href="#cb19-977" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> parts[<span class="dv">1</span>:]:</span>
<span id="cb19-978"><a href="#cb19-978" aria-hidden="true" tabindex="-1"></a>            pa[seq_col] <span class="op">=</span> pa[seq_col] <span class="op">+</span> <span class="st">" </span><span class="ch">\u2192</span><span class="st"> "</span> <span class="op">+</span> p  <span class="co"># arrow separator</span></span>
<span id="cb19-979"><a href="#cb19-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-980"><a href="#cb19-980" aria-hidden="true" tabindex="-1"></a>    <span class="co"># aggregate</span></span>
<span id="cb19-981"><a href="#cb19-981" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> (</span>
<span id="cb19-982"><a href="#cb19-982" aria-hidden="true" tabindex="-1"></a>        pa[pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> n]</span>
<span id="cb19-983"><a href="#cb19-983" aria-hidden="true" tabindex="-1"></a>        .groupby(seq_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-984"><a href="#cb19-984" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb19-985"><a href="#cb19-985" aria-hidden="true" tabindex="-1"></a>            count<span class="op">=</span>(<span class="st">"game_pk"</span>, <span class="st">"size"</span>),</span>
<span id="cb19-986"><a href="#cb19-986" aria-hidden="true" tabindex="-1"></a>            ended_here<span class="op">=</span>(<span class="ss">f"end_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-987"><a href="#cb19-987" aria-hidden="true" tabindex="-1"></a>            woba_num<span class="op">=</span>(<span class="st">"woba_numerator"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-988"><a href="#cb19-988" aria-hidden="true" tabindex="-1"></a>            woba_den<span class="op">=</span>(<span class="st">"woba_denom"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-989"><a href="#cb19-989" aria-hidden="true" tabindex="-1"></a>            H<span class="op">=</span>(<span class="st">"H"</span>, <span class="st">"sum"</span>), BB<span class="op">=</span>(<span class="st">"BB"</span>, <span class="st">"sum"</span>), HBP<span class="op">=</span>(<span class="st">"HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-990"><a href="#cb19-990" aria-hidden="true" tabindex="-1"></a>            SF<span class="op">=</span>(<span class="st">"SF"</span>, <span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>, <span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>, <span class="st">"sum"</span>)</span>
<span id="cb19-991"><a href="#cb19-991" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-992"><a href="#cb19-992" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-993"><a href="#cb19-993" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-994"><a href="#cb19-994" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> grp[grp[<span class="st">"count"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>] </span>
<span id="cb19-995"><a href="#cb19-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-996"><a href="#cb19-996" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute wOBA</span></span>
<span id="cb19-997"><a href="#cb19-997" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"wOBA"</span>] <span class="op">=</span> grp[<span class="st">"woba_num"</span>] <span class="op">/</span> grp[<span class="st">"woba_den"</span>]</span>
<span id="cb19-998"><a href="#cb19-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-999"><a href="#cb19-999" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute OBP &amp; SLG from summed components</span></span>
<span id="cb19-1000"><a href="#cb19-1000" aria-hidden="true" tabindex="-1"></a>    denom_obp <span class="op">=</span> grp[<span class="st">"AB"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>] <span class="op">+</span> grp[<span class="st">"SF"</span>]</span>
<span id="cb19-1001"><a href="#cb19-1001" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb19-1002"><a href="#cb19-1002" aria-hidden="true" tabindex="-1"></a>                          (grp[<span class="st">"H"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp,</span>
<span id="cb19-1003"><a href="#cb19-1003" aria-hidden="true" tabindex="-1"></a>                          np.nan)</span>
<span id="cb19-1004"><a href="#cb19-1004" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(grp[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, grp[<span class="st">"TB"</span>] <span class="op">/</span> grp[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb19-1005"><a href="#cb19-1005" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OPS"</span>] <span class="op">=</span> grp[<span class="st">"OBP"</span>] <span class="op">+</span> grp[<span class="st">"SLG"</span>]</span>
<span id="cb19-1006"><a href="#cb19-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1007"><a href="#cb19-1007" aria-hidden="true" tabindex="-1"></a>    <span class="co"># final tidy</span></span>
<span id="cb19-1008"><a href="#cb19-1008" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> (</span>
<span id="cb19-1009"><a href="#cb19-1009" aria-hidden="true" tabindex="-1"></a>        grp.sort_values([<span class="st">"OPS"</span>, <span class="st">"count"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb19-1010"><a href="#cb19-1010" aria-hidden="true" tabindex="-1"></a>           .head(<span class="dv">10</span>)</span>
<span id="cb19-1011"><a href="#cb19-1011" aria-hidden="true" tabindex="-1"></a>           .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-1012"><a href="#cb19-1012" aria-hidden="true" tabindex="-1"></a>           .loc[:, [<span class="st">"count"</span>, <span class="st">"ended_here"</span>, <span class="st">"wOBA"</span>, <span class="st">"OPS"</span>, seq_col]]</span>
<span id="cb19-1013"><a href="#cb19-1013" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{seq_col: <span class="st">"sequence"</span>})</span>
<span id="cb19-1014"><a href="#cb19-1014" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-1015"><a href="#cb19-1015" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb19-1016"><a href="#cb19-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1017"><a href="#cb19-1017" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1018"><a href="#cb19-1018" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Produce and print tables for n = 1 … 5</span></span>
<span id="cb19-1019"><a href="#cb19-1019" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1020"><a href="#cb19-1020" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb19-1021"><a href="#cb19-1021" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb19-1022"><a href="#cb19-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1023"><a href="#cb19-1023" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb19-1024"><a href="#cb19-1024" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 sequences at pitch-number </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> (by OPS):"</span>)</span>
<span id="cb19-1025"><a href="#cb19-1025" aria-hidden="true" tabindex="-1"></a>    tbl <span class="op">=</span> build_table(n)</span>
<span id="cb19-1026"><a href="#cb19-1026" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tbl.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{</span>
<span id="cb19-1027"><a href="#cb19-1027" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wOBA"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span>,</span>
<span id="cb19-1028"><a href="#cb19-1028" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OPS"</span>:  <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span></span>
<span id="cb19-1029"><a href="#cb19-1029" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb19-1030"><a href="#cb19-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1031"><a href="#cb19-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1032"><a href="#cb19-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1033"><a href="#cb19-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1034"><a href="#cb19-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1035"><a href="#cb19-1035" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-1036"><a href="#cb19-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1037"><a href="#cb19-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1038"><a href="#cb19-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1039"><a href="#cb19-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1040"><a href="#cb19-1040" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 1 (by OPS):</span></span>
<span id="cb19-1041"><a href="#cb19-1041" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS               sequence</span></span>
<span id="cb19-1042"><a href="#cb19-1042" aria-hidden="true" tabindex="-1"></a><span class="in"> 10752        1313 0.277 0.645   Breaking Up (Strike)</span></span>
<span id="cb19-1043"><a href="#cb19-1043" aria-hidden="true" tabindex="-1"></a><span class="in"> 16469        3020 0.284 0.661 Breaking Away (Strike)</span></span>
<span id="cb19-1044"><a href="#cb19-1044" aria-hidden="true" tabindex="-1"></a><span class="in"> 35725        6257 0.286 0.668   Fastball Up (Strike)</span></span>
<span id="cb19-1045"><a href="#cb19-1045" aria-hidden="true" tabindex="-1"></a><span class="in"> 14728        2226 0.286 0.668   Breaking In (Strike)</span></span>
<span id="cb19-1046"><a href="#cb19-1046" aria-hidden="true" tabindex="-1"></a><span class="in"> 31362        6331 0.293 0.681 Fastball Down (Strike)</span></span>
<span id="cb19-1047"><a href="#cb19-1047" aria-hidden="true" tabindex="-1"></a><span class="in">    49          13 0.300 0.681    Other Down (Strike)</span></span>
<span id="cb19-1048"><a href="#cb19-1048" aria-hidden="true" tabindex="-1"></a><span class="in"> 36087        7238 0.293 0.681 Fastball Away (Strike)</span></span>
<span id="cb19-1049"><a href="#cb19-1049" aria-hidden="true" tabindex="-1"></a><span class="in"> 20365        4039 0.294 0.684 Breaking Down (Strike)</span></span>
<span id="cb19-1050"><a href="#cb19-1050" aria-hidden="true" tabindex="-1"></a><span class="in"> 35118        7933 0.297 0.690   Fastball In (Strike)</span></span>
<span id="cb19-1051"><a href="#cb19-1051" aria-hidden="true" tabindex="-1"></a><span class="in">  4045        1137 0.304 0.714     Change In (Strike)</span></span>
<span id="cb19-1052"><a href="#cb19-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1053"><a href="#cb19-1053" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 2 (by OPS):</span></span>
<span id="cb19-1054"><a href="#cb19-1054" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                        sequence</span></span>
<span id="cb19-1055"><a href="#cb19-1055" aria-hidden="true" tabindex="-1"></a><span class="in">    27          14 0.092 0.188   Breaking Middle (Strike) → Change In (Strike)</span></span>
<span id="cb19-1056"><a href="#cb19-1056" aria-hidden="true" tabindex="-1"></a><span class="in">    20          10 0.107 0.258         Change Up (Strike) → Change Up (Strike)</span></span>
<span id="cb19-1057"><a href="#cb19-1057" aria-hidden="true" tabindex="-1"></a><span class="in">    33          16 0.130 0.303       Change In (Strike) → Change Away (Strike)</span></span>
<span id="cb19-1058"><a href="#cb19-1058" aria-hidden="true" tabindex="-1"></a><span class="in">    32           4 0.145 0.323       Change Up (Strike) → Fastball Down (Ball)</span></span>
<span id="cb19-1059"><a href="#cb19-1059" aria-hidden="true" tabindex="-1"></a><span class="in">    44          14 0.157 0.328     Breaking Down (Strike) → Change Up (Strike)</span></span>
<span id="cb19-1060"><a href="#cb19-1060" aria-hidden="true" tabindex="-1"></a><span class="in">    25           8 0.158 0.360     Change In (Ball) → Breaking Middle (Strike)</span></span>
<span id="cb19-1061"><a href="#cb19-1061" aria-hidden="true" tabindex="-1"></a><span class="in">    25          12 0.158 0.360         Change In (Strike) → Change Up (Strike)</span></span>
<span id="cb19-1062"><a href="#cb19-1062" aria-hidden="true" tabindex="-1"></a><span class="in">   147           8 0.187 0.398       Breaking In (Strike) → Breaking Up (Ball)</span></span>
<span id="cb19-1063"><a href="#cb19-1063" aria-hidden="true" tabindex="-1"></a><span class="in">   251           9 0.183 0.399 Fastball Middle (Strike) → Fastball Down (Ball)</span></span>
<span id="cb19-1064"><a href="#cb19-1064" aria-hidden="true" tabindex="-1"></a><span class="in">    26           4 0.210 0.406     Change Middle (Strike) → Change Away (Ball)</span></span>
<span id="cb19-1065"><a href="#cb19-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1066"><a href="#cb19-1066" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 3 (by OPS):</span></span>
<span id="cb19-1067"><a href="#cb19-1067" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                                               sequence</span></span>
<span id="cb19-1068"><a href="#cb19-1068" aria-hidden="true" tabindex="-1"></a><span class="in">    20           6 0.000 0.000         Change Away (Ball) → Change Down (Strike) → Change Down (Ball)</span></span>
<span id="cb19-1069"><a href="#cb19-1069" aria-hidden="true" tabindex="-1"></a><span class="in">    22          10 0.031 0.045   Breaking Away (Strike) → Breaking Away (Ball) → Breaking Up (Strike)</span></span>
<span id="cb19-1070"><a href="#cb19-1070" aria-hidden="true" tabindex="-1"></a><span class="in">    22           9 0.031 0.045   Breaking Up (Strike) → Fastball Down (Strike) → Breaking Away (Ball)</span></span>
<span id="cb19-1071"><a href="#cb19-1071" aria-hidden="true" tabindex="-1"></a><span class="in">    21          14 0.034 0.048 Breaking Down (Strike) → Breaking In (Strike) → Breaking Down (Strike)</span></span>
<span id="cb19-1072"><a href="#cb19-1072" aria-hidden="true" tabindex="-1"></a><span class="in">    20           6 0.034 0.050       Breaking Up (Ball) → Breaking In (Ball) → Fastball Away (Strike)</span></span>
<span id="cb19-1073"><a href="#cb19-1073" aria-hidden="true" tabindex="-1"></a><span class="in">    38          13 0.037 0.053   Fastball In (Strike) → Fastball Down (Strike) → Fastball Down (Ball)</span></span>
<span id="cb19-1074"><a href="#cb19-1074" aria-hidden="true" tabindex="-1"></a><span class="in">    34           9 0.026 0.059     Breaking Up (Ball) → Breaking Away (Strike) → Breaking Down (Ball)</span></span>
<span id="cb19-1075"><a href="#cb19-1075" aria-hidden="true" tabindex="-1"></a><span class="in">    25           5 0.055 0.080   Breaking Away (Ball) → Breaking In (Strike) → Fastball Away (Strike)</span></span>
<span id="cb19-1076"><a href="#cb19-1076" aria-hidden="true" tabindex="-1"></a><span class="in">    22          10 0.041 0.091 Fastball Up (Strike) → Breaking Away (Ball) → Breaking Middle (Strike)</span></span>
<span id="cb19-1077"><a href="#cb19-1077" aria-hidden="true" tabindex="-1"></a><span class="in">    23          12 0.039 0.093       Change Down (Strike) → Change Down (Ball) → Fastball In (Strike)</span></span>
<span id="cb19-1078"><a href="#cb19-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1079"><a href="#cb19-1079" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 4 (by OPS):</span></span>
<span id="cb19-1080"><a href="#cb19-1080" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                                                                      sequence</span></span>
<span id="cb19-1081"><a href="#cb19-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    22           8 0.000 0.000   Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Strike) → Fastball Up (Ball)</span></span>
<span id="cb19-1082"><a href="#cb19-1082" aria-hidden="true" tabindex="-1"></a><span class="in">    20           9 0.000 0.000 Fastball Down (Strike) → Fastball Away (Strike) → Breaking Away (Ball) → Breaking Away (Ball)</span></span>
<span id="cb19-1083"><a href="#cb19-1083" aria-hidden="true" tabindex="-1"></a><span class="in">    23           9 0.030 0.043     Fastball In (Strike) → Fastball In (Strike) → Breaking Down (Ball) → Breaking Down (Ball)</span></span>
<span id="cb19-1084"><a href="#cb19-1084" aria-hidden="true" tabindex="-1"></a><span class="in">    34           7 0.047 0.089         Fastball Up (Ball) → Fastball Up (Strike) → Fastball Up (Strike) → Fastball Up (Ball)</span></span>
<span id="cb19-1085"><a href="#cb19-1085" aria-hidden="true" tabindex="-1"></a><span class="in">    21          10 0.043 0.095           Fastball In (Strike) → Breaking In (Ball) → Breaking In (Ball) → Breaking In (Ball)</span></span>
<span id="cb19-1086"><a href="#cb19-1086" aria-hidden="true" tabindex="-1"></a><span class="in">    20           9 0.070 0.100         Fastball In (Strike) → Fastball In (Ball) → Fastball Up (Ball) → Breaking Down (Ball)</span></span>
<span id="cb19-1087"><a href="#cb19-1087" aria-hidden="true" tabindex="-1"></a><span class="in">    24           5 0.066 0.129     Fastball Away (Strike) → Fastball Up (Ball) → Breaking Down (Ball) → Breaking Down (Ball)</span></span>
<span id="cb19-1088"><a href="#cb19-1088" aria-hidden="true" tabindex="-1"></a><span class="in">    23           7 0.090 0.130       Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking In (Ball)</span></span>
<span id="cb19-1089"><a href="#cb19-1089" aria-hidden="true" tabindex="-1"></a><span class="in">    20           8 0.079 0.153   Breaking Away (Strike) → Breaking Away (Ball) → Breaking Down (Ball) → Breaking Down (Ball)</span></span>
<span id="cb19-1090"><a href="#cb19-1090" aria-hidden="true" tabindex="-1"></a><span class="in">    25           2 0.072 0.163     Fastball Away (Strike) → Breaking Down (Ball) → Breaking Down (Ball) → Fastball Up (Ball)</span></span>
<span id="cb19-1091"><a href="#cb19-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1092"><a href="#cb19-1092" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 5 (by OPS):</span></span>
<span id="cb19-1093"><a href="#cb19-1093" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                                                                                           sequence</span></span>
<span id="cb19-1094"><a href="#cb19-1094" aria-hidden="true" tabindex="-1"></a><span class="in">    21          10 0.230 0.333   Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball) → Breaking Down (Ball)</span></span>
<span id="cb19-1095"><a href="#cb19-1095" aria-hidden="true" tabindex="-1"></a><span class="in">    20           8 0.194 0.483           Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Strike)</span></span>
<span id="cb19-1096"><a href="#cb19-1096" aria-hidden="true" tabindex="-1"></a><span class="in">    33          14 0.301 0.568             Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball) → Fastball Up (Ball)</span></span>
<span id="cb19-1097"><a href="#cb19-1097" aria-hidden="true" tabindex="-1"></a><span class="in">    31          11 0.337 0.610   Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball)</span></span>
<span id="cb19-1098"><a href="#cb19-1098" aria-hidden="true" tabindex="-1"></a><span class="in">    30          18 0.451 0.800             Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball)</span></span>
<span id="cb19-1099"><a href="#cb19-1099" aria-hidden="true" tabindex="-1"></a><span class="in">    22           7 0.385 0.919 Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Ball)</span></span>
<span id="cb19-1100"><a href="#cb19-1100" aria-hidden="true" tabindex="-1"></a><span class="in">    20           8 0.486 0.983           Fastball In (Ball) → Fastball In (Ball) → Fastball In (Ball) → Fastball In (Strike) → Fastball In (Ball)</span></span>
<span id="cb19-1101"><a href="#cb19-1101" aria-hidden="true" tabindex="-1"></a><span class="in">    23          11 0.492 1.016 Fastball Away (Ball) → Fastball Away (Ball) → Fastball Away (Strike) → Fastball Away (Ball) → Fastball Away (Ball)</span></span>
<span id="cb19-1102"><a href="#cb19-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1103"><a href="#cb19-1103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1104"><a href="#cb19-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1105"><a href="#cb19-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1108"><a href="#cb19-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-1109"><a href="#cb19-1109" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-1110"><a href="#cb19-1110" aria-hidden="true" tabindex="-1"></a><span class="co">TOP-N OPENING SEQUENCES, RANKED BY OPS – **NO LOCATION INFO**</span></span>
<span id="cb19-1111"><a href="#cb19-1111" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================================</span></span>
<span id="cb19-1112"><a href="#cb19-1112" aria-hidden="true" tabindex="-1"></a><span class="co">• Works from a Statcast-like pitch-level DataFrame `df`.</span></span>
<span id="cb19-1113"><a href="#cb19-1113" aria-hidden="true" tabindex="-1"></a><span class="co">• Sequences are built only from the *pitch class* (“Fastball”, “Breaking” …)</span></span>
<span id="cb19-1114"><a href="#cb19-1114" aria-hidden="true" tabindex="-1"></a><span class="co">  — nothing about In/Away/Up/Down/Strike/Ball.</span></span>
<span id="cb19-1115"><a href="#cb19-1115" aria-hidden="true" tabindex="-1"></a><span class="co">• Produces five tables (first pitch through fifth pitch), each showing</span></span>
<span id="cb19-1116"><a href="#cb19-1116" aria-hidden="true" tabindex="-1"></a><span class="co">  context count, ‘ended_here’ count, wOBA, OPS, and the literal sequence.</span></span>
<span id="cb19-1117"><a href="#cb19-1117" aria-hidden="true" tabindex="-1"></a><span class="co">• Only sequences with ≥ 20 PAs are kept, and tables are sorted</span></span>
<span id="cb19-1118"><a href="#cb19-1118" aria-hidden="true" tabindex="-1"></a><span class="co">  from **lowest OPS to highest**.</span></span>
<span id="cb19-1119"><a href="#cb19-1119" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb19-1120"><a href="#cb19-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1121"><a href="#cb19-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1122"><a href="#cb19-1122" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Imports</span></span>
<span id="cb19-1123"><a href="#cb19-1123" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1124"><a href="#cb19-1124" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-1125"><a href="#cb19-1125" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-1126"><a href="#cb19-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1127"><a href="#cb19-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1128"><a href="#cb19-1128" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Map Statcast pitch_name → pitch_class         (no location used)</span></span>
<span id="cb19-1129"><a href="#cb19-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1130"><a href="#cb19-1130" aria-hidden="true" tabindex="-1"></a>pitch_map <span class="op">=</span> {</span>
<span id="cb19-1131"><a href="#cb19-1131" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckle Curve"</span>: <span class="st">"Breaking"</span>, <span class="st">"Cutter"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-1132"><a href="#cb19-1132" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Four-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-1133"><a href="#cb19-1133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2-Seam Fastball"</span>: <span class="st">"Fastball"</span>, <span class="st">"Two-Seam Fastball"</span>: <span class="st">"Fastball"</span>,</span>
<span id="cb19-1134"><a href="#cb19-1134" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinker"</span>: <span class="st">"Fastball"</span>, <span class="st">"Sweeper"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-1135"><a href="#cb19-1135" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Curveball"</span>: <span class="st">"Breaking"</span>, <span class="st">"Split-Finger"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-1136"><a href="#cb19-1136" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Splitter"</span>: <span class="st">"Change"</span>, <span class="st">"Changeup"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-1137"><a href="#cb19-1137" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slider"</span>: <span class="st">"Breaking"</span>, <span class="st">"Screwball"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-1138"><a href="#cb19-1138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Forkball"</span>: <span class="st">"Change"</span>, <span class="st">"Slurve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-1139"><a href="#cb19-1139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Knuckleball"</span>: <span class="st">"Change"</span>, <span class="st">"Slow Curve"</span>: <span class="st">"Breaking"</span>,</span>
<span id="cb19-1140"><a href="#cb19-1140" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pitch Out"</span>: <span class="st">"Fastball"</span>, <span class="st">"Eephus"</span>: <span class="st">"Change"</span>,</span>
<span id="cb19-1141"><a href="#cb19-1141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Other"</span>: <span class="st">"Other"</span>, <span class="st">"nan"</span>: <span class="st">"Other"</span>,</span>
<span id="cb19-1142"><a href="#cb19-1142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-1143"><a href="#cb19-1143" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(pitch_map).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-1144"><a href="#cb19-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1145"><a href="#cb19-1145" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1146"><a href="#cb19-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Collapse to one row per plate appearance</span></span>
<span id="cb19-1147"><a href="#cb19-1147" aria-hidden="true" tabindex="-1"></a><span class="co">#    (using **only** pitch_class tokens)</span></span>
<span id="cb19-1148"><a href="#cb19-1148" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1149"><a href="#cb19-1149" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>, <span class="st">"pitch_number"</span>]) <span class="op">\</span></span>
<span id="cb19-1150"><a href="#cb19-1150" aria-hidden="true" tabindex="-1"></a>      .groupby([<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>])</span>
<span id="cb19-1151"><a href="#cb19-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1152"><a href="#cb19-1152" aria-hidden="true" tabindex="-1"></a>pa <span class="op">=</span> (</span>
<span id="cb19-1153"><a href="#cb19-1153" aria-hidden="true" tabindex="-1"></a>    g.agg(</span>
<span id="cb19-1154"><a href="#cb19-1154" aria-hidden="true" tabindex="-1"></a>        pitch_list<span class="op">=</span>(<span class="st">"pitch_class"</span>, <span class="bu">list</span>),   <span class="co"># ← token is pitch_class</span></span>
<span id="cb19-1155"><a href="#cb19-1155" aria-hidden="true" tabindex="-1"></a>        events<span class="op">=</span>(<span class="st">"events"</span>, <span class="st">"last"</span>)</span>
<span id="cb19-1156"><a href="#cb19-1156" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-1157"><a href="#cb19-1157" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb19-1158"><a href="#cb19-1158" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-1159"><a href="#cb19-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1160"><a href="#cb19-1160" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"n_pitches"</span>] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb19-1161"><a href="#cb19-1161" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lbl <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"third"</span>, <span class="st">"fourth"</span>, <span class="st">"fifth"</span>], start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb19-1162"><a href="#cb19-1162" aria-hidden="true" tabindex="-1"></a>    pa[lbl] <span class="op">=</span> pa[<span class="st">"pitch_list"</span>].<span class="bu">str</span>[i<span class="op">-</span><span class="dv">1</span>].where(pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> i)</span>
<span id="cb19-1163"><a href="#cb19-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1164"><a href="#cb19-1164" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb19-1165"><a href="#cb19-1165" aria-hidden="true" tabindex="-1"></a>    pa[<span class="ss">f"end_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (pa[<span class="st">"n_pitches"</span>] <span class="op">==</span> i).astype(<span class="bu">int</span>)</span>
<span id="cb19-1166"><a href="#cb19-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1167"><a href="#cb19-1167" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1168"><a href="#cb19-1168" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Per-PA outcome components (same as before)</span></span>
<span id="cb19-1169"><a href="#cb19-1169" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1170"><a href="#cb19-1170" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> pa[<span class="st">"events"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-1171"><a href="#cb19-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1172"><a href="#cb19-1172" aria-hidden="true" tabindex="-1"></a>WOBA_WT <span class="op">=</span> {           <span class="co"># 2024 weights</span></span>
<span id="cb19-1173"><a href="#cb19-1173" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_run"</span>: <span class="fl">1.95</span>, <span class="st">"triple"</span>: <span class="fl">1.56</span>, <span class="st">"double"</span>: <span class="fl">1.24</span>, <span class="st">"single"</span>: <span class="fl">0.90</span>,</span>
<span id="cb19-1174"><a href="#cb19-1174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"walk"</span>: <span class="fl">0.69</span>, <span class="st">"intent_walk"</span>: <span class="fl">0.69</span>, <span class="st">"hit_by_pitch"</span>: <span class="fl">0.72</span></span>
<span id="cb19-1175"><a href="#cb19-1175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-1176"><a href="#cb19-1176" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_numerator"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(WOBA_WT).fillna(<span class="fl">0.0</span>)</span>
<span id="cb19-1177"><a href="#cb19-1177" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"woba_denom"</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb19-1178"><a href="#cb19-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1179"><a href="#cb19-1179" aria-hidden="true" tabindex="-1"></a>HIT <span class="op">=</span> {<span class="st">"single"</span>, <span class="st">"double"</span>, <span class="st">"triple"</span>, <span class="st">"home_run"</span>}</span>
<span id="cb19-1180"><a href="#cb19-1180" aria-hidden="true" tabindex="-1"></a>BB  <span class="op">=</span> {<span class="st">"walk"</span>, <span class="st">"intent_walk"</span>}</span>
<span id="cb19-1181"><a href="#cb19-1181" aria-hidden="true" tabindex="-1"></a>HBP <span class="op">=</span> {<span class="st">"hit_by_pitch"</span>}</span>
<span id="cb19-1182"><a href="#cb19-1182" aria-hidden="true" tabindex="-1"></a>SF  <span class="op">=</span> {<span class="st">"sac_fly"</span>, <span class="st">"sac fly"</span>, <span class="st">"sacrifice_fly"</span>, <span class="st">"sac_fly_double_play"</span>}</span>
<span id="cb19-1183"><a href="#cb19-1183" aria-hidden="true" tabindex="-1"></a>SH  <span class="op">=</span> {<span class="st">"sac_bunt"</span>, <span class="st">"sac bunt"</span>}</span>
<span id="cb19-1184"><a href="#cb19-1184" aria-hidden="true" tabindex="-1"></a>CI  <span class="op">=</span> {<span class="st">"catcher_interference"</span>, <span class="st">"catcher_interf"</span>}</span>
<span id="cb19-1185"><a href="#cb19-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1186"><a href="#cb19-1186" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"H"</span>]   <span class="op">=</span> ev.isin(HIT).astype(<span class="bu">int</span>)</span>
<span id="cb19-1187"><a href="#cb19-1187" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"BB"</span>]  <span class="op">=</span> ev.isin(BB).astype(<span class="bu">int</span>)</span>
<span id="cb19-1188"><a href="#cb19-1188" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"HBP"</span>] <span class="op">=</span> ev.isin(HBP).astype(<span class="bu">int</span>)</span>
<span id="cb19-1189"><a href="#cb19-1189" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SF"</span>]  <span class="op">=</span> ev.isin(SF).astype(<span class="bu">int</span>)</span>
<span id="cb19-1190"><a href="#cb19-1190" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"SH"</span>]  <span class="op">=</span> ev.isin(SH).astype(<span class="bu">int</span>)</span>
<span id="cb19-1191"><a href="#cb19-1191" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"CI"</span>]  <span class="op">=</span> ev.isin(CI).astype(<span class="bu">int</span>)</span>
<span id="cb19-1192"><a href="#cb19-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1193"><a href="#cb19-1193" aria-hidden="true" tabindex="-1"></a>TB_MAP <span class="op">=</span> {<span class="st">"single"</span>: <span class="dv">1</span>, <span class="st">"double"</span>: <span class="dv">2</span>, <span class="st">"triple"</span>: <span class="dv">3</span>, <span class="st">"home_run"</span>: <span class="dv">4</span>}</span>
<span id="cb19-1194"><a href="#cb19-1194" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"TB"</span>] <span class="op">=</span> ev.<span class="bu">map</span>(TB_MAP).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb19-1195"><a href="#cb19-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1196"><a href="#cb19-1196" aria-hidden="true" tabindex="-1"></a>pa[<span class="st">"AB"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> pa[[<span class="st">"BB"</span>, <span class="st">"HBP"</span>, <span class="st">"SF"</span>, <span class="st">"SH"</span>, <span class="st">"CI"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-1197"><a href="#cb19-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1198"><a href="#cb19-1198" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1199"><a href="#cb19-1199" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Helper to build N-pitch tables (OPS from summed components)</span></span>
<span id="cb19-1200"><a href="#cb19-1200" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1201"><a href="#cb19-1201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_table(n: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-1202"><a href="#cb19-1202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="kw">not</span> <span class="kw">in</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>):</span>
<span id="cb19-1203"><a href="#cb19-1203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n must be 1–5"</span>)</span>
<span id="cb19-1204"><a href="#cb19-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1205"><a href="#cb19-1205" aria-hidden="true" tabindex="-1"></a>    seq_col <span class="op">=</span> <span class="ss">f"seq_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-1206"><a href="#cb19-1206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb19-1207"><a href="#cb19-1207" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> pa[<span class="st">"first"</span>]</span>
<span id="cb19-1208"><a href="#cb19-1208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-1209"><a href="#cb19-1209" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">=</span> [pa[<span class="st">"first"</span>], pa[<span class="st">"second"</span>], pa[<span class="st">"third"</span>],</span>
<span id="cb19-1210"><a href="#cb19-1210" aria-hidden="true" tabindex="-1"></a>                 pa.get(<span class="st">"fourth"</span>), pa.get(<span class="st">"fifth"</span>)][:n]</span>
<span id="cb19-1211"><a href="#cb19-1211" aria-hidden="true" tabindex="-1"></a>        pa[seq_col] <span class="op">=</span> parts[<span class="dv">0</span>]</span>
<span id="cb19-1212"><a href="#cb19-1212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> parts[<span class="dv">1</span>:]:</span>
<span id="cb19-1213"><a href="#cb19-1213" aria-hidden="true" tabindex="-1"></a>            pa[seq_col] <span class="op">=</span> pa[seq_col] <span class="op">+</span> <span class="st">" → "</span> <span class="op">+</span> p</span>
<span id="cb19-1214"><a href="#cb19-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1215"><a href="#cb19-1215" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> (</span>
<span id="cb19-1216"><a href="#cb19-1216" aria-hidden="true" tabindex="-1"></a>        pa[pa[<span class="st">"n_pitches"</span>] <span class="op">&gt;=</span> n]</span>
<span id="cb19-1217"><a href="#cb19-1217" aria-hidden="true" tabindex="-1"></a>        .groupby(seq_col, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-1218"><a href="#cb19-1218" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb19-1219"><a href="#cb19-1219" aria-hidden="true" tabindex="-1"></a>            count<span class="op">=</span>(<span class="st">"game_pk"</span>, <span class="st">"size"</span>),</span>
<span id="cb19-1220"><a href="#cb19-1220" aria-hidden="true" tabindex="-1"></a>            ended_here<span class="op">=</span>(<span class="ss">f"end_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-1221"><a href="#cb19-1221" aria-hidden="true" tabindex="-1"></a>            woba_num<span class="op">=</span>(<span class="st">"woba_numerator"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-1222"><a href="#cb19-1222" aria-hidden="true" tabindex="-1"></a>            woba_den<span class="op">=</span>(<span class="st">"woba_denom"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-1223"><a href="#cb19-1223" aria-hidden="true" tabindex="-1"></a>            H<span class="op">=</span>(<span class="st">"H"</span>, <span class="st">"sum"</span>), BB<span class="op">=</span>(<span class="st">"BB"</span>, <span class="st">"sum"</span>), HBP<span class="op">=</span>(<span class="st">"HBP"</span>, <span class="st">"sum"</span>),</span>
<span id="cb19-1224"><a href="#cb19-1224" aria-hidden="true" tabindex="-1"></a>            SF<span class="op">=</span>(<span class="st">"SF"</span>, <span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>, <span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>, <span class="st">"sum"</span>)</span>
<span id="cb19-1225"><a href="#cb19-1225" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-1226"><a href="#cb19-1226" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-1227"><a href="#cb19-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1228"><a href="#cb19-1228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only sequences with ≥ 20 PAs</span></span>
<span id="cb19-1229"><a href="#cb19-1229" aria-hidden="true" tabindex="-1"></a>    grp <span class="op">=</span> grp[grp[<span class="st">"count"</span>] <span class="op">&gt;=</span> <span class="dv">20</span>]</span>
<span id="cb19-1230"><a href="#cb19-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1231"><a href="#cb19-1231" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"wOBA"</span>] <span class="op">=</span> grp[<span class="st">"woba_num"</span>] <span class="op">/</span> grp[<span class="st">"woba_den"</span>]</span>
<span id="cb19-1232"><a href="#cb19-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1233"><a href="#cb19-1233" aria-hidden="true" tabindex="-1"></a>    denom_obp <span class="op">=</span> grp[<span class="st">"AB"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>] <span class="op">+</span> grp[<span class="st">"SF"</span>]</span>
<span id="cb19-1234"><a href="#cb19-1234" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OBP"</span>] <span class="op">=</span> np.where(denom_obp <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb19-1235"><a href="#cb19-1235" aria-hidden="true" tabindex="-1"></a>                          (grp[<span class="st">"H"</span>] <span class="op">+</span> grp[<span class="st">"BB"</span>] <span class="op">+</span> grp[<span class="st">"HBP"</span>]) <span class="op">/</span> denom_obp,</span>
<span id="cb19-1236"><a href="#cb19-1236" aria-hidden="true" tabindex="-1"></a>                          np.nan)</span>
<span id="cb19-1237"><a href="#cb19-1237" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"SLG"</span>] <span class="op">=</span> np.where(grp[<span class="st">"AB"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, grp[<span class="st">"TB"</span>] <span class="op">/</span> grp[<span class="st">"AB"</span>], np.nan)</span>
<span id="cb19-1238"><a href="#cb19-1238" aria-hidden="true" tabindex="-1"></a>    grp[<span class="st">"OPS"</span>] <span class="op">=</span> grp[<span class="st">"OBP"</span>] <span class="op">+</span> grp[<span class="st">"SLG"</span>]</span>
<span id="cb19-1239"><a href="#cb19-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1240"><a href="#cb19-1240" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> (</span>
<span id="cb19-1241"><a href="#cb19-1241" aria-hidden="true" tabindex="-1"></a>        grp.sort_values([<span class="st">"OPS"</span>, <span class="st">"count"</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])  <span class="co"># lowest OPS first</span></span>
<span id="cb19-1242"><a href="#cb19-1242" aria-hidden="true" tabindex="-1"></a>           .head(<span class="dv">10</span>)</span>
<span id="cb19-1243"><a href="#cb19-1243" aria-hidden="true" tabindex="-1"></a>           .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-1244"><a href="#cb19-1244" aria-hidden="true" tabindex="-1"></a>           .loc[:, [<span class="st">"count"</span>, <span class="st">"ended_here"</span>, <span class="st">"wOBA"</span>, <span class="st">"OPS"</span>, seq_col]]</span>
<span id="cb19-1245"><a href="#cb19-1245" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{seq_col: <span class="st">"sequence"</span>})</span>
<span id="cb19-1246"><a href="#cb19-1246" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-1247"><a href="#cb19-1247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb19-1248"><a href="#cb19-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1249"><a href="#cb19-1249" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1250"><a href="#cb19-1250" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Produce and print tables for n = 1 … 5</span></span>
<span id="cb19-1251"><a href="#cb19-1251" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1252"><a href="#cb19-1252" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)</span>
<span id="cb19-1253"><a href="#cb19-1253" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb19-1254"><a href="#cb19-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1255"><a href="#cb19-1255" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb19-1256"><a href="#cb19-1256" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top 10 sequences at pitch-number </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> (by OPS; ≥20 PAs):"</span>)</span>
<span id="cb19-1257"><a href="#cb19-1257" aria-hidden="true" tabindex="-1"></a>    tbl <span class="op">=</span> build_table(n)</span>
<span id="cb19-1258"><a href="#cb19-1258" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tbl.to_string(index<span class="op">=</span><span class="va">False</span>, formatters<span class="op">=</span>{</span>
<span id="cb19-1259"><a href="#cb19-1259" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wOBA"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span>,</span>
<span id="cb19-1260"><a href="#cb19-1260" aria-hidden="true" tabindex="-1"></a>        <span class="st">"OPS"</span>:  <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>.<span class="bu">format</span></span>
<span id="cb19-1261"><a href="#cb19-1261" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb19-1262"><a href="#cb19-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1263"><a href="#cb19-1263" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1264"><a href="#cb19-1264" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Visualise OPS trajectories, growing one pitch at a time</span></span>
<span id="cb19-1265"><a href="#cb19-1265" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb19-1266"><a href="#cb19-1266" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-1267"><a href="#cb19-1267" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.collections <span class="im">import</span> LineCollection</span>
<span id="cb19-1268"><a href="#cb19-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1269"><a href="#cb19-1269" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-a) cache the OPS tables for n = 1 … 5</span></span>
<span id="cb19-1270"><a href="#cb19-1270" aria-hidden="true" tabindex="-1"></a>ops_by_len <span class="op">=</span> {n: build_table(n).set_index(<span class="st">"sequence"</span>)[<span class="st">"OPS"</span>] <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)}</span>
<span id="cb19-1271"><a href="#cb19-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1272"><a href="#cb19-1272" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-b) helper to fetch OPS for a sequence’s (n-1) prefix</span></span>
<span id="cb19-1273"><a href="#cb19-1273" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prefix_ops(seq, n):</span>
<span id="cb19-1274"><a href="#cb19-1274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb19-1275"><a href="#cb19-1275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ops_by_len[<span class="dv">1</span>].get(seq)      <span class="co"># base case</span></span>
<span id="cb19-1276"><a href="#cb19-1276" aria-hidden="true" tabindex="-1"></a>    prefix <span class="op">=</span> <span class="st">" → "</span>.join(seq.split(<span class="st">" → "</span>)[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb19-1277"><a href="#cb19-1277" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ops_by_len[n<span class="op">-</span><span class="dv">1</span>].get(prefix)</span>
<span id="cb19-1278"><a href="#cb19-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1279"><a href="#cb19-1279" aria-hidden="true" tabindex="-1"></a><span class="co"># 6-c) colour map for the *last pitch* in each segment</span></span>
<span id="cb19-1280"><a href="#cb19-1280" aria-hidden="true" tabindex="-1"></a>COLOR_MAP <span class="op">=</span> {<span class="st">"Fastball"</span>: <span class="st">"#377eb8"</span>, <span class="st">"Breaking"</span>: <span class="st">"#e41a1c"</span>,</span>
<span id="cb19-1281"><a href="#cb19-1281" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Change"</span>: <span class="st">"#4daf4a"</span>, <span class="st">"Other"</span>: <span class="st">"#984ea3"</span>}</span>
<span id="cb19-1282"><a href="#cb19-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1283"><a href="#cb19-1283" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb19-1284"><a href="#cb19-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1285"><a href="#cb19-1285" aria-hidden="true" tabindex="-1"></a><span class="co"># first-pitch dots</span></span>
<span id="cb19-1286"><a href="#cb19-1286" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> seq, ops <span class="kw">in</span> ops_by_len[<span class="dv">1</span>].items():</span>
<span id="cb19-1287"><a href="#cb19-1287" aria-hidden="true" tabindex="-1"></a>    ax.scatter(<span class="dv">1</span>, ops, s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb19-1288"><a href="#cb19-1288" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span>COLOR_MAP.get(seq, <span class="st">"#999999"</span>),</span>
<span id="cb19-1289"><a href="#cb19-1289" aria-hidden="true" tabindex="-1"></a>               zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-1290"><a href="#cb19-1290" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="fl">1.02</span>, ops, seq, va<span class="op">=</span><span class="st">"center"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb19-1291"><a href="#cb19-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1292"><a href="#cb19-1292" aria-hidden="true" tabindex="-1"></a><span class="co"># build segments for n = 2 … 5</span></span>
<span id="cb19-1293"><a href="#cb19-1293" aria-hidden="true" tabindex="-1"></a>segments <span class="op">=</span> []</span>
<span id="cb19-1294"><a href="#cb19-1294" aria-hidden="true" tabindex="-1"></a>colors   <span class="op">=</span> []</span>
<span id="cb19-1295"><a href="#cb19-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1296"><a href="#cb19-1296" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">6</span>):</span>
<span id="cb19-1297"><a href="#cb19-1297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> seq, ops_n <span class="kw">in</span> ops_by_len[n].items():</span>
<span id="cb19-1298"><a href="#cb19-1298" aria-hidden="true" tabindex="-1"></a>        ops_prev <span class="op">=</span> prefix_ops(seq, n)</span>
<span id="cb19-1299"><a href="#cb19-1299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isna(ops_prev):</span>
<span id="cb19-1300"><a href="#cb19-1300" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>          <span class="co"># prefix didn’t meet 20-PA threshold</span></span>
<span id="cb19-1301"><a href="#cb19-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1302"><a href="#cb19-1302" aria-hidden="true" tabindex="-1"></a>        x0, y0 <span class="op">=</span> n<span class="op">-</span><span class="dv">1</span>, ops_prev</span>
<span id="cb19-1303"><a href="#cb19-1303" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> n,   ops_n</span>
<span id="cb19-1304"><a href="#cb19-1304" aria-hidden="true" tabindex="-1"></a>        segments.append([(x0, y0), (x1, y1)])</span>
<span id="cb19-1305"><a href="#cb19-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1306"><a href="#cb19-1306" aria-hidden="true" tabindex="-1"></a>        last_pitch <span class="op">=</span> seq.split(<span class="st">" → "</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb19-1307"><a href="#cb19-1307" aria-hidden="true" tabindex="-1"></a>        colors.append(COLOR_MAP.get(last_pitch, <span class="st">"#999999"</span>))</span>
<span id="cb19-1308"><a href="#cb19-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1309"><a href="#cb19-1309" aria-hidden="true" tabindex="-1"></a><span class="co"># plot all segments at once</span></span>
<span id="cb19-1310"><a href="#cb19-1310" aria-hidden="true" tabindex="-1"></a>lc <span class="op">=</span> LineCollection(segments, colors<span class="op">=</span>colors, linewidths<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb19-1311"><a href="#cb19-1311" aria-hidden="true" tabindex="-1"></a>ax.add_collection(lc)</span>
<span id="cb19-1312"><a href="#cb19-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1313"><a href="#cb19-1313" aria-hidden="true" tabindex="-1"></a><span class="co"># scatter end-points so the last pitch colour shows on dots too</span></span>
<span id="cb19-1314"><a href="#cb19-1314" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x0, y0), (x1, y1), c <span class="kw">in</span> <span class="bu">zip</span>([s[<span class="dv">0</span>] <span class="cf">for</span> s <span class="kw">in</span> segments],</span>
<span id="cb19-1315"><a href="#cb19-1315" aria-hidden="true" tabindex="-1"></a>                                 [s[<span class="dv">1</span>] <span class="cf">for</span> s <span class="kw">in</span> segments], colors):</span>
<span id="cb19-1316"><a href="#cb19-1316" aria-hidden="true" tabindex="-1"></a>    ax.scatter(x1, y1, color<span class="op">=</span>c, s<span class="op">=</span><span class="dv">25</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-1317"><a href="#cb19-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1318"><a href="#cb19-1318" aria-hidden="true" tabindex="-1"></a><span class="co"># axes cosmetics</span></span>
<span id="cb19-1319"><a href="#cb19-1319" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Pitch number in sequence"</span>)</span>
<span id="cb19-1320"><a href="#cb19-1320" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"OPS"</span>)</span>
<span id="cb19-1321"><a href="#cb19-1321" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"OPS Trajectories for Opening Sequences</span><span class="ch">\n</span><span class="st">(segment colour = pitch thrown at that step)"</span>)</span>
<span id="cb19-1322"><a href="#cb19-1322" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="fl">0.8</span>, <span class="fl">5.2</span>)</span>
<span id="cb19-1323"><a href="#cb19-1323" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>))</span>
<span id="cb19-1324"><a href="#cb19-1324" aria-hidden="true" tabindex="-1"></a>ax.grid(ls<span class="op">=</span><span class="st">"--"</span>, lw<span class="op">=</span><span class="fl">0.4</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb19-1325"><a href="#cb19-1325" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-1326"><a href="#cb19-1326" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-1327"><a href="#cb19-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1328"><a href="#cb19-1328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1329"><a href="#cb19-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1330"><a href="#cb19-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1331"><a href="#cb19-1331" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-1332"><a href="#cb19-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1333"><a href="#cb19-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1334"><a href="#cb19-1334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1335"><a href="#cb19-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1336"><a href="#cb19-1336" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 1 (by OPS; ≥20 PAs):</span></span>
<span id="cb19-1337"><a href="#cb19-1337" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS sequence</span></span>
<span id="cb19-1338"><a href="#cb19-1338" aria-hidden="true" tabindex="-1"></a><span class="in">158664       14620 0.310 0.713 Breaking</span></span>
<span id="cb19-1339"><a href="#cb19-1339" aria-hidden="true" tabindex="-1"></a><span class="in">312271       39637 0.310 0.713 Fastball</span></span>
<span id="cb19-1340"><a href="#cb19-1340" aria-hidden="true" tabindex="-1"></a><span class="in"> 43423        5426 0.326 0.755   Change</span></span>
<span id="cb19-1341"><a href="#cb19-1341" aria-hidden="true" tabindex="-1"></a><span class="in"> 19429        9041 0.330 0.759    Other</span></span>
<span id="cb19-1342"><a href="#cb19-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1343"><a href="#cb19-1343" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 2 (by OPS; ≥20 PAs):</span></span>
<span id="cb19-1344"><a href="#cb19-1344" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS            sequence</span></span>
<span id="cb19-1345"><a href="#cb19-1345" aria-hidden="true" tabindex="-1"></a><span class="in"> 57306        8696 0.292 0.665 Breaking → Breaking</span></span>
<span id="cb19-1346"><a href="#cb19-1346" aria-hidden="true" tabindex="-1"></a><span class="in"> 72168       11085 0.295 0.673 Fastball → Breaking</span></span>
<span id="cb19-1347"><a href="#cb19-1347" aria-hidden="true" tabindex="-1"></a><span class="in">162489       28438 0.300 0.685 Fastball → Fastball</span></span>
<span id="cb19-1348"><a href="#cb19-1348" aria-hidden="true" tabindex="-1"></a><span class="in"> 10255        1335 0.306 0.687       Other → Other</span></span>
<span id="cb19-1349"><a href="#cb19-1349" aria-hidden="true" tabindex="-1"></a><span class="in"> 37968        6601 0.302 0.688   Fastball → Change</span></span>
<span id="cb19-1350"><a href="#cb19-1350" aria-hidden="true" tabindex="-1"></a><span class="in"> 19355        3237 0.306 0.697   Breaking → Change</span></span>
<span id="cb19-1351"><a href="#cb19-1351" aria-hidden="true" tabindex="-1"></a><span class="in"> 67368       12507 0.308 0.703 Breaking → Fastball</span></span>
<span id="cb19-1352"><a href="#cb19-1352" aria-hidden="true" tabindex="-1"></a><span class="in"> 17940        3062 0.315 0.724   Change → Fastball</span></span>
<span id="cb19-1353"><a href="#cb19-1353" aria-hidden="true" tabindex="-1"></a><span class="in"> 14102        2754 0.318 0.731     Change → Change</span></span>
<span id="cb19-1354"><a href="#cb19-1354" aria-hidden="true" tabindex="-1"></a><span class="in">  5860         887 0.327 0.750   Change → Breaking</span></span>
<span id="cb19-1355"><a href="#cb19-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1356"><a href="#cb19-1356" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 3 (by OPS; ≥20 PAs):</span></span>
<span id="cb19-1357"><a href="#cb19-1357" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                       sequence</span></span>
<span id="cb19-1358"><a href="#cb19-1358" aria-hidden="true" tabindex="-1"></a><span class="in"> 20500        5522 0.255 0.567 Breaking → Breaking → Breaking</span></span>
<span id="cb19-1359"><a href="#cb19-1359" aria-hidden="true" tabindex="-1"></a><span class="in"> 26831        6784 0.261 0.583 Fastball → Breaking → Breaking</span></span>
<span id="cb19-1360"><a href="#cb19-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  5480        1320 0.268 0.597   Fastball → Breaking → Change</span></span>
<span id="cb19-1361"><a href="#cb19-1361" aria-hidden="true" tabindex="-1"></a><span class="in"> 38656        9212 0.271 0.608 Fastball → Fastball → Breaking</span></span>
<span id="cb19-1362"><a href="#cb19-1362" aria-hidden="true" tabindex="-1"></a><span class="in">  8875        4199 0.281 0.608          Other → Other → Other</span></span>
<span id="cb19-1363"><a href="#cb19-1363" aria-hidden="true" tabindex="-1"></a><span class="in"> 19188        4866 0.278 0.623 Breaking → Fastball → Breaking</span></span>
<span id="cb19-1364"><a href="#cb19-1364" aria-hidden="true" tabindex="-1"></a><span class="in"> 11369        2916 0.278 0.626     Fastball → Change → Change</span></span>
<span id="cb19-1365"><a href="#cb19-1365" aria-hidden="true" tabindex="-1"></a><span class="in">  3662         995 0.284 0.638       Change → Change → Change</span></span>
<span id="cb19-1366"><a href="#cb19-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  4828        1090 0.284 0.638   Fastball → Change → Breaking</span></span>
<span id="cb19-1367"><a href="#cb19-1367" aria-hidden="true" tabindex="-1"></a><span class="in">  4049         839 0.288 0.639   Breaking → Breaking → Change</span></span>
<span id="cb19-1368"><a href="#cb19-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1369"><a href="#cb19-1369" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 4 (by OPS; ≥20 PAs):</span></span>
<span id="cb19-1370"><a href="#cb19-1370" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                  sequence</span></span>
<span id="cb19-1371"><a href="#cb19-1371" aria-hidden="true" tabindex="-1"></a><span class="in">   891         338 0.220 0.476     Fastball → Change → Breaking → Change</span></span>
<span id="cb19-1372"><a href="#cb19-1372" aria-hidden="true" tabindex="-1"></a><span class="in">   322         128 0.233 0.491       Change → Breaking → Change → Change</span></span>
<span id="cb19-1373"><a href="#cb19-1373" aria-hidden="true" tabindex="-1"></a><span class="in">  6978        2674 0.236 0.515 Breaking → Breaking → Breaking → Breaking</span></span>
<span id="cb19-1374"><a href="#cb19-1374" aria-hidden="true" tabindex="-1"></a><span class="in">  1480         498 0.243 0.530   Fastball → Breaking → Breaking → Change</span></span>
<span id="cb19-1375"><a href="#cb19-1375" aria-hidden="true" tabindex="-1"></a><span class="in">   895         353 0.244 0.531       Breaking → Change → Change → Change</span></span>
<span id="cb19-1376"><a href="#cb19-1376" aria-hidden="true" tabindex="-1"></a><span class="in">  7880        2968 0.242 0.532 Fastball → Breaking → Breaking → Breaking</span></span>
<span id="cb19-1377"><a href="#cb19-1377" aria-hidden="true" tabindex="-1"></a><span class="in">  2094         785 0.247 0.537       Fastball → Change → Change → Change</span></span>
<span id="cb19-1378"><a href="#cb19-1378" aria-hidden="true" tabindex="-1"></a><span class="in"> 11770        4181 0.246 0.543 Fastball → Fastball → Breaking → Breaking</span></span>
<span id="cb19-1379"><a href="#cb19-1379" aria-hidden="true" tabindex="-1"></a><span class="in">  1381         417 0.252 0.550   Breaking → Breaking → Fastball → Change</span></span>
<span id="cb19-1380"><a href="#cb19-1380" aria-hidden="true" tabindex="-1"></a><span class="in">  1370         530 0.252 0.553       Change → Fastball → Change → Change</span></span>
<span id="cb19-1381"><a href="#cb19-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1382"><a href="#cb19-1382" aria-hidden="true" tabindex="-1"></a><span class="in">Top 10 sequences at pitch-number 5 (by OPS; ≥20 PAs):</span></span>
<span id="cb19-1383"><a href="#cb19-1383" aria-hidden="true" tabindex="-1"></a><span class="in"> count  ended_here  wOBA   OPS                                           sequence</span></span>
<span id="cb19-1384"><a href="#cb19-1384" aria-hidden="true" tabindex="-1"></a><span class="in">    74          40 0.164 0.296     Change → Breaking → Fastball → Change → Change</span></span>
<span id="cb19-1385"><a href="#cb19-1385" aria-hidden="true" tabindex="-1"></a><span class="in">   179          76 0.173 0.336 Breaking → Breaking → Breaking → Breaking → Change</span></span>
<span id="cb19-1386"><a href="#cb19-1386" aria-hidden="true" tabindex="-1"></a><span class="in">   131          58 0.192 0.378   Breaking → Breaking → Change → Breaking → Change</span></span>
<span id="cb19-1387"><a href="#cb19-1387" aria-hidden="true" tabindex="-1"></a><span class="in">    34          13 0.211 0.408     Change → Change → Change → Breaking → Breaking</span></span>
<span id="cb19-1388"><a href="#cb19-1388" aria-hidden="true" tabindex="-1"></a><span class="in">    87          42 0.209 0.410 Change → Fastball → Breaking → Breaking → Breaking</span></span>
<span id="cb19-1389"><a href="#cb19-1389" aria-hidden="true" tabindex="-1"></a><span class="in">   246         101 0.219 0.428 Breaking → Fastball → Breaking → Breaking → Change</span></span>
<span id="cb19-1390"><a href="#cb19-1390" aria-hidden="true" tabindex="-1"></a><span class="in">   109          39 0.239 0.443   Change → Change → Fastball → Breaking → Breaking</span></span>
<span id="cb19-1391"><a href="#cb19-1391" aria-hidden="true" tabindex="-1"></a><span class="in">    55          26 0.249 0.476       Change → Breaking → Change → Change → Change</span></span>
<span id="cb19-1392"><a href="#cb19-1392" aria-hidden="true" tabindex="-1"></a><span class="in">   420         214 0.228 0.477       Change → Change → Fastball → Change → Change</span></span>
<span id="cb19-1393"><a href="#cb19-1393" aria-hidden="true" tabindex="-1"></a><span class="in">   162          78 0.240 0.482 Change → Fastball → Breaking → Fastball → Breaking</span></span>
<span id="cb19-1394"><a href="#cb19-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1395"><a href="#cb19-1395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1396"><a href="#cb19-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1397"><a href="#cb19-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1398"><a href="#cb19-1398" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-1399"><a href="#cb19-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1400"><a href="#cb19-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1401"><a href="#cb19-1401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1402"><a href="#cb19-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1403"><a href="#cb19-1403" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Figure size 1000x600 with 1 Axes&gt;</span></span>
<span id="cb19-1404"><a href="#cb19-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1405"><a href="#cb19-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1406"><a href="#cb19-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1407"><a href="#cb19-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1408"><a href="#cb19-1408" aria-hidden="true" tabindex="-1"></a><span class="al">![Figure from cell 6](figure_5_1_2.png)</span></span>
<span id="cb19-1409"><a href="#cb19-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1410"><a href="#cb19-1410" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitch Tunneling</span></span>
<span id="cb19-1411"><a href="#cb19-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1412"><a href="#cb19-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1415"><a href="#cb19-1415" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-1416"><a href="#cb19-1416" aria-hidden="true" tabindex="-1"></a><span class="co"># This portion of the project assesses how "tunneling" pitches improves pitching outcomes. It flags pairs of pitches as being tunneled using Statcast's extremely granular location/release data, and a couple physics equations found at https://baseball.physics.illinois.edu/</span></span>
<span id="cb19-1417"><a href="#cb19-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1418"><a href="#cb19-1418" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-1419"><a href="#cb19-1419" aria-hidden="true" tabindex="-1"></a><span class="co">#  OPS Impact of Optimal Tunnelling  –  last-pitch sequences (class change)</span></span>
<span id="cb19-1420"><a href="#cb19-1420" aria-hidden="true" tabindex="-1"></a><span class="co">#  • DataFrame `df` must already hold raw Statcast rows</span></span>
<span id="cb19-1421"><a href="#cb19-1421" aria-hidden="true" tabindex="-1"></a><span class="co">#  • “Tunneled” if:</span></span>
<span id="cb19-1422"><a href="#cb19-1422" aria-hidden="true" tabindex="-1"></a><span class="co">#       3-D hand-distance  &lt; 0.35 ft  (≈ 4.2″)      AND</span></span>
<span id="cb19-1423"><a href="#cb19-1423" aria-hidden="true" tabindex="-1"></a><span class="co">#       distance between trajectories at 23 ft front of plate &lt; 0.18 ft</span></span>
<span id="cb19-1424"><a href="#cb19-1424" aria-hidden="true" tabindex="-1"></a><span class="co">#  • Computes OPS for each DIFFERENT-class pair  ± tunnelling</span></span>
<span id="cb19-1425"><a href="#cb19-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-1426"><a href="#cb19-1426" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb19-1427"><a href="#cb19-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1428"><a href="#cb19-1428" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1  Pitch-class buckets ------------------------------------------------</span></span>
<span id="cb19-1429"><a href="#cb19-1429" aria-hidden="true" tabindex="-1"></a>CLASS <span class="op">=</span> {<span class="st">"Knuckle Curve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Curveball"</span>:<span class="st">"Breaking"</span>,<span class="st">"Sweeper"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb19-1430"><a href="#cb19-1430" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Slider"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slurve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slow Curve"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb19-1431"><a href="#cb19-1431" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Cutter"</span>:<span class="st">"Fastball"</span>,<span class="st">"4-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"2-Seam Fastball"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb19-1432"><a href="#cb19-1432" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Sinker"</span>:<span class="st">"Fastball"</span>,<span class="st">"Pitch Out"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb19-1433"><a href="#cb19-1433" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Split-Finger"</span>:<span class="st">"Change"</span>,<span class="st">"Changeup"</span>:<span class="st">"Change"</span>,<span class="st">"Forkball"</span>:<span class="st">"Change"</span>,</span>
<span id="cb19-1434"><a href="#cb19-1434" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Knuckleball"</span>:<span class="st">"Change"</span>,<span class="st">"Eephus"</span>:<span class="st">"Change"</span>}</span>
<span id="cb19-1435"><a href="#cb19-1435" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(CLASS).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-1436"><a href="#cb19-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1437"><a href="#cb19-1437" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2  Last two pitches of every PA --------------------------------------</span></span>
<span id="cb19-1438"><a href="#cb19-1438" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>,<span class="st">"pitch_number"</span>])</span>
<span id="cb19-1439"><a href="#cb19-1439" aria-hidden="true" tabindex="-1"></a>last2 <span class="op">=</span> df.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).tail(<span class="dv">2</span>).copy()</span>
<span id="cb19-1440"><a href="#cb19-1440" aria-hidden="true" tabindex="-1"></a>last2[<span class="st">"idx"</span>] <span class="op">=</span> last2.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).cumcount()</span>
<span id="cb19-1441"><a href="#cb19-1441" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> (</span>
<span id="cb19-1442"><a href="#cb19-1442" aria-hidden="true" tabindex="-1"></a>    last2.pivot(index<span class="op">=</span>[<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>], columns<span class="op">=</span><span class="st">"idx"</span>)</span>
<span id="cb19-1443"><a href="#cb19-1443" aria-hidden="true" tabindex="-1"></a>         .dropna(subset<span class="op">=</span>[(<span class="st">"pitch_class"</span>,<span class="dv">0</span>),(<span class="st">"pitch_class"</span>,<span class="dv">1</span>)])</span>
<span id="cb19-1444"><a href="#cb19-1444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-1445"><a href="#cb19-1445" aria-hidden="true" tabindex="-1"></a>wide.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,i <span class="kw">in</span> wide.columns]</span>
<span id="cb19-1446"><a href="#cb19-1446" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> wide[wide[<span class="st">"pitch_class_0"</span>] <span class="op">!=</span> wide[<span class="st">"pitch_class_1"</span>]]        <span class="co"># class change only</span></span>
<span id="cb19-1447"><a href="#cb19-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1448"><a href="#cb19-1448" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3  Tunnel metrics ----------------------------------------------------</span></span>
<span id="cb19-1449"><a href="#cb19-1449" aria-hidden="true" tabindex="-1"></a>HAND_THR, DEC_THR, Y_DEC <span class="op">=</span> <span class="fl">0.35</span>, <span class="fl">0.18</span>, <span class="fl">23.0</span></span>
<span id="cb19-1450"><a href="#cb19-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1451"><a href="#cb19-1451" aria-hidden="true" tabindex="-1"></a>hand_dist <span class="op">=</span> np.sqrt(</span>
<span id="cb19-1452"><a href="#cb19-1452" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_x_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_x_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb19-1453"><a href="#cb19-1453" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_z_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_z_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb19-1454"><a href="#cb19-1454" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_extension_1"</span>] <span class="op">-</span> wide[<span class="st">"release_extension_0"</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb19-1455"><a href="#cb19-1455" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-1456"><a href="#cb19-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1457"><a href="#cb19-1457" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xy_at_23ft(frame, s):                             <span class="co"># s = 0 or 1</span></span>
<span id="cb19-1458"><a href="#cb19-1458" aria-hidden="true" tabindex="-1"></a>    y0  <span class="op">=</span> frame[<span class="ss">f"release_pos_y_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1459"><a href="#cb19-1459" aria-hidden="true" tabindex="-1"></a>    dy  <span class="op">=</span> y0 <span class="op">-</span> Y_DEC</span>
<span id="cb19-1460"><a href="#cb19-1460" aria-hidden="true" tabindex="-1"></a>    vy0 <span class="op">=</span> frame[<span class="ss">f"vy0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1461"><a href="#cb19-1461" aria-hidden="true" tabindex="-1"></a>    ay  <span class="op">=</span> frame[<span class="ss">f"ay_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1462"><a href="#cb19-1462" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> vy0<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>ay<span class="op">*</span>dy</span>
<span id="cb19-1463"><a href="#cb19-1463" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.full_like(vy0, np.nan)</span>
<span id="cb19-1464"><a href="#cb19-1464" aria-hidden="true" tabindex="-1"></a>    ok <span class="op">=</span> (disc <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (ay <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb19-1465"><a href="#cb19-1465" aria-hidden="true" tabindex="-1"></a>    t[ok] <span class="op">=</span> (<span class="op">-</span>vy0[ok] <span class="op">-</span> np.sqrt(disc[ok])) <span class="op">/</span> ay[ok]</span>
<span id="cb19-1466"><a href="#cb19-1466" aria-hidden="true" tabindex="-1"></a>    vx0, ax <span class="op">=</span> frame[<span class="ss">f"vx0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"ax_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1467"><a href="#cb19-1467" aria-hidden="true" tabindex="-1"></a>    vz0, az <span class="op">=</span> frame[<span class="ss">f"vz0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"az_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1468"><a href="#cb19-1468" aria-hidden="true" tabindex="-1"></a>    x_rel, z_rel <span class="op">=</span> frame[<span class="ss">f"release_pos_x_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy(), frame[<span class="ss">f"release_pos_z_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1469"><a href="#cb19-1469" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x_rel <span class="op">+</span> vx0<span class="op">*</span>t <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>ax<span class="op">*</span>t<span class="op">**</span><span class="dv">2</span></span>
<span id="cb19-1470"><a href="#cb19-1470" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> z_rel <span class="op">+</span> vz0<span class="op">*</span>t <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>az<span class="op">*</span>t<span class="op">**</span><span class="dv">2</span></span>
<span id="cb19-1471"><a href="#cb19-1471" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x, z</span>
<span id="cb19-1472"><a href="#cb19-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1473"><a href="#cb19-1473" aria-hidden="true" tabindex="-1"></a>x0,z0 <span class="op">=</span> xy_at_23ft(wide,<span class="dv">0</span>)</span>
<span id="cb19-1474"><a href="#cb19-1474" aria-hidden="true" tabindex="-1"></a>x1,z1 <span class="op">=</span> xy_at_23ft(wide,<span class="dv">1</span>)</span>
<span id="cb19-1475"><a href="#cb19-1475" aria-hidden="true" tabindex="-1"></a>dec_dist <span class="op">=</span> np.sqrt((x1<span class="op">-</span>x0)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (z1<span class="op">-</span>z0)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb19-1476"><a href="#cb19-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1477"><a href="#cb19-1477" aria-hidden="true" tabindex="-1"></a><span class="co"># Boolean masks (NA → False)</span></span>
<span id="cb19-1478"><a href="#cb19-1478" aria-hidden="true" tabindex="-1"></a>cond_hand <span class="op">=</span> (hand_dist <span class="op">&lt;</span> HAND_THR).fillna(<span class="va">False</span>)</span>
<span id="cb19-1479"><a href="#cb19-1479" aria-hidden="true" tabindex="-1"></a>cond_dec  <span class="op">=</span> np.where(np.isnan(dec_dist), <span class="va">False</span>, dec_dist <span class="op">&lt;</span> DEC_THR)</span>
<span id="cb19-1480"><a href="#cb19-1480" aria-hidden="true" tabindex="-1"></a>cond_dec  <span class="op">=</span> pd.Series(cond_dec, index<span class="op">=</span>wide.index)</span>
<span id="cb19-1481"><a href="#cb19-1481" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"tunneled"</span>] <span class="op">=</span> cond_hand <span class="op">&amp;</span> cond_dec</span>
<span id="cb19-1482"><a href="#cb19-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1483"><a href="#cb19-1483" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4  Sequence label ----------------------------------------------------</span></span>
<span id="cb19-1484"><a href="#cb19-1484" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"seq"</span>] <span class="op">=</span> wide[<span class="st">"pitch_class_0"</span>] <span class="op">+</span> <span class="st">"→"</span> <span class="op">+</span> wide[<span class="st">"pitch_class_1"</span>]</span>
<span id="cb19-1485"><a href="#cb19-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1486"><a href="#cb19-1486" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5  OPS components from final-pitch result ----------------------------</span></span>
<span id="cb19-1487"><a href="#cb19-1487" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> wide[<span class="st">"events_1"</span>].fillna(<span class="st">"none"</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-1488"><a href="#cb19-1488" aria-hidden="true" tabindex="-1"></a>single <span class="op">=</span> ev.eq(<span class="st">"single"</span>)<span class="op">;</span> double <span class="op">=</span> ev.eq(<span class="st">"double"</span>)<span class="op">;</span> triple <span class="op">=</span> ev.eq(<span class="st">"triple"</span>)</span>
<span id="cb19-1489"><a href="#cb19-1489" aria-hidden="true" tabindex="-1"></a>hr     <span class="op">=</span> ev.eq(<span class="st">"home_run"</span>)<span class="op">;</span> walk <span class="op">=</span> ev.isin([<span class="st">"walk"</span>,<span class="st">"intent_walk"</span>,<span class="st">"hit_by_pitch"</span>])</span>
<span id="cb19-1490"><a href="#cb19-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1491"><a href="#cb19-1491" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"PA"</span>]  <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-1492"><a href="#cb19-1492" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"AB"</span>]  <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> walk</span>
<span id="cb19-1493"><a href="#cb19-1493" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"TB"</span>]  <span class="op">=</span> single <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>double <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>triple <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>hr</span>
<span id="cb19-1494"><a href="#cb19-1494" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"ONB"</span>] <span class="op">=</span> single <span class="op">+</span> double <span class="op">+</span> triple <span class="op">+</span> hr <span class="op">+</span> walk</span>
<span id="cb19-1495"><a href="#cb19-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1496"><a href="#cb19-1496" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6  Aggregate to OPS --------------------------------------------------</span></span>
<span id="cb19-1497"><a href="#cb19-1497" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> (wide.groupby([<span class="st">"seq"</span>,<span class="st">"tunneled"</span>])</span>
<span id="cb19-1498"><a href="#cb19-1498" aria-hidden="true" tabindex="-1"></a>             .agg(PA<span class="op">=</span>(<span class="st">"PA"</span>,<span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>,<span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>,<span class="st">"sum"</span>), ONB<span class="op">=</span>(<span class="st">"ONB"</span>,<span class="st">"sum"</span>))</span>
<span id="cb19-1499"><a href="#cb19-1499" aria-hidden="true" tabindex="-1"></a>             .reset_index())</span>
<span id="cb19-1500"><a href="#cb19-1500" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OBP"</span>] <span class="op">=</span> agg[<span class="st">"ONB"</span>] <span class="op">/</span> agg[<span class="st">"PA"</span>]</span>
<span id="cb19-1501"><a href="#cb19-1501" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"SLG"</span>] <span class="op">=</span> agg[<span class="st">"TB"</span>]  <span class="op">/</span> agg[<span class="st">"AB"</span>].where(agg[<span class="st">"AB"</span>]<span class="op">&gt;</span><span class="dv">0</span>, np.nan)</span>
<span id="cb19-1502"><a href="#cb19-1502" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OPS"</span>] <span class="op">=</span> agg[<span class="st">"OBP"</span>] <span class="op">+</span> agg[<span class="st">"SLG"</span>]</span>
<span id="cb19-1503"><a href="#cb19-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1504"><a href="#cb19-1504" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (agg.pivot(index<span class="op">=</span><span class="st">"seq"</span>, columns<span class="op">=</span><span class="st">"tunneled"</span>, values<span class="op">=</span>[<span class="st">"PA"</span>,<span class="st">"OPS"</span>])</span>
<span id="cb19-1505"><a href="#cb19-1505" aria-hidden="true" tabindex="-1"></a>             .rename(columns<span class="op">=</span>{<span class="va">False</span>:<span class="st">"NoTunnel"</span>, <span class="va">True</span>:<span class="st">"Tunnel"</span>}))</span>
<span id="cb19-1506"><a href="#cb19-1506" aria-hidden="true" tabindex="-1"></a>table.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,col <span class="kw">in</span> table.columns]</span>
<span id="cb19-1507"><a href="#cb19-1507" aria-hidden="true" tabindex="-1"></a>table[<span class="st">"ΔOPS (Tunnel – No)"</span>] <span class="op">=</span> table[<span class="st">"OPS_Tunnel"</span>] <span class="op">-</span> table[<span class="st">"OPS_NoTunnel"</span>]</span>
<span id="cb19-1508"><a href="#cb19-1508" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> table.sort_values(<span class="st">"ΔOPS (Tunnel – No)"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-1509"><a href="#cb19-1509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1510"><a href="#cb19-1510" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== OPS on last-pitch sequences  |  Tunneled vs Not Tunneled ==="</span>)</span>
<span id="cb19-1511"><a href="#cb19-1511" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table.to_string(float_format<span class="op">=</span><span class="kw">lambda</span> x:<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span>, na_rep<span class="op">=</span><span class="st">"–"</span>))</span>
<span id="cb19-1512"><a href="#cb19-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1513"><a href="#cb19-1513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1514"><a href="#cb19-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1515"><a href="#cb19-1515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1516"><a href="#cb19-1516" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Evidence: selected outputs kept for interpretability. --&gt;</span></span>
<span id="cb19-1517"><a href="#cb19-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1518"><a href="#cb19-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1519"><a href="#cb19-1519" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-1520"><a href="#cb19-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1521"><a href="#cb19-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1522"><a href="#cb19-1522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1523"><a href="#cb19-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1524"><a href="#cb19-1524" aria-hidden="true" tabindex="-1"></a><span class="in">=== OPS on last-pitch sequences  |  Tunneled vs Not Tunneled ===</span></span>
<span id="cb19-1525"><a href="#cb19-1525" aria-hidden="true" tabindex="-1"></a><span class="in">                   PA_NoTunnel  PA_Tunnel  OPS_NoTunnel  OPS_Tunnel  ΔOPS (Tunnel – No)</span></span>
<span id="cb19-1526"><a href="#cb19-1526" aria-hidden="true" tabindex="-1"></a><span class="in">seq                                                                                    </span></span>
<span id="cb19-1527"><a href="#cb19-1527" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Fastball    72115.000    665.000         0.729       0.924               0.195</span></span>
<span id="cb19-1528"><a href="#cb19-1528" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Fastball      31333.000    589.000         0.746       0.777               0.031</span></span>
<span id="cb19-1529"><a href="#cb19-1529" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Change      32965.000    649.000         0.643       0.611              -0.032</span></span>
<span id="cb19-1530"><a href="#cb19-1530" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Breaking      11244.000     90.000         0.608       0.550              -0.057</span></span>
<span id="cb19-1531"><a href="#cb19-1531" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Change      14236.000    113.000         0.595       0.527              -0.068</span></span>
<span id="cb19-1532"><a href="#cb19-1532" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Breaking    71010.000    521.000         0.632       0.563              -0.069</span></span>
<span id="cb19-1533"><a href="#cb19-1533" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Other          23.000          –         1.503           –                   –</span></span>
<span id="cb19-1534"><a href="#cb19-1534" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Other           103.000          –         0.958           –                   –</span></span>
<span id="cb19-1535"><a href="#cb19-1535" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Other          42.000          –         0.819           –                   –</span></span>
<span id="cb19-1536"><a href="#cb19-1536" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Breaking          29.000          –         0.466           –                   –</span></span>
<span id="cb19-1537"><a href="#cb19-1537" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Change           104.000          –         0.864           –                   –</span></span>
<span id="cb19-1538"><a href="#cb19-1538" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Fastball          51.000          –         0.514           –                   –</span></span>
<span id="cb19-1539"><a href="#cb19-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1540"><a href="#cb19-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1541"><a href="#cb19-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1542"><a href="#cb19-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1545"><a href="#cb19-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb19-1546"><a href="#cb19-1546" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-1547"><a href="#cb19-1547" aria-hidden="true" tabindex="-1"></a><span class="co">#  OPS Impact of Straight-Line Tunnelling  – last-pitch class-change pairs</span></span>
<span id="cb19-1548"><a href="#cb19-1548" aria-hidden="true" tabindex="-1"></a><span class="co"># ════════════════════════════════════════════════════════════════════════</span></span>
<span id="cb19-1549"><a href="#cb19-1549" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, numpy <span class="im">as</span> np</span>
<span id="cb19-1550"><a href="#cb19-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1551"><a href="#cb19-1551" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 1  Pitch-class buckets ----------------------------------------------</span></span>
<span id="cb19-1552"><a href="#cb19-1552" aria-hidden="true" tabindex="-1"></a>CLASS <span class="op">=</span> {<span class="st">"Knuckle Curve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Curveball"</span>:<span class="st">"Breaking"</span>,<span class="st">"Sweeper"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb19-1553"><a href="#cb19-1553" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Slider"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slurve"</span>:<span class="st">"Breaking"</span>,<span class="st">"Slow Curve"</span>:<span class="st">"Breaking"</span>,</span>
<span id="cb19-1554"><a href="#cb19-1554" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Cutter"</span>:<span class="st">"Fastball"</span>,<span class="st">"4-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Four-Seam Fastball"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb19-1555"><a href="#cb19-1555" aria-hidden="true" tabindex="-1"></a>         <span class="st">"2-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Two-Seam Fastball"</span>:<span class="st">"Fastball"</span>,<span class="st">"Sinker"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb19-1556"><a href="#cb19-1556" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Pitch Out"</span>:<span class="st">"Fastball"</span>,</span>
<span id="cb19-1557"><a href="#cb19-1557" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Split-Finger"</span>:<span class="st">"Change"</span>,<span class="st">"Splitter"</span>:<span class="st">"Change"</span>,<span class="st">"Changeup"</span>:<span class="st">"Change"</span>,<span class="st">"Forkball"</span>:<span class="st">"Change"</span>,</span>
<span id="cb19-1558"><a href="#cb19-1558" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Knuckleball"</span>:<span class="st">"Change"</span>,<span class="st">"Eephus"</span>:<span class="st">"Change"</span>}</span>
<span id="cb19-1559"><a href="#cb19-1559" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"pitch_class"</span>] <span class="op">=</span> df[<span class="st">"pitch_name"</span>].<span class="bu">map</span>(CLASS).fillna(<span class="st">"Other"</span>)</span>
<span id="cb19-1560"><a href="#cb19-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1561"><a href="#cb19-1561" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 2  Last two pitches of each plate appearance ------------------------</span></span>
<span id="cb19-1562"><a href="#cb19-1562" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>,<span class="st">"pitch_number"</span>])</span>
<span id="cb19-1563"><a href="#cb19-1563" aria-hidden="true" tabindex="-1"></a>last2 <span class="op">=</span> df.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).tail(<span class="dv">2</span>).copy()</span>
<span id="cb19-1564"><a href="#cb19-1564" aria-hidden="true" tabindex="-1"></a>last2[<span class="st">"idx"</span>] <span class="op">=</span> last2.groupby([<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>]).cumcount()</span>
<span id="cb19-1565"><a href="#cb19-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1566"><a href="#cb19-1566" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> (last2</span>
<span id="cb19-1567"><a href="#cb19-1567" aria-hidden="true" tabindex="-1"></a>        .pivot(index<span class="op">=</span>[<span class="st">"game_pk"</span>,<span class="st">"at_bat_number"</span>], columns<span class="op">=</span><span class="st">"idx"</span>)</span>
<span id="cb19-1568"><a href="#cb19-1568" aria-hidden="true" tabindex="-1"></a>        .dropna(subset<span class="op">=</span>[(<span class="st">"pitch_class"</span>,<span class="dv">0</span>),(<span class="st">"pitch_class"</span>,<span class="dv">1</span>)]))</span>
<span id="cb19-1569"><a href="#cb19-1569" aria-hidden="true" tabindex="-1"></a>wide.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,i <span class="kw">in</span> wide.columns]</span>
<span id="cb19-1570"><a href="#cb19-1570" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> wide[wide[<span class="st">"pitch_class_0"</span>] <span class="op">!=</span> wide[<span class="st">"pitch_class_1"</span>]]   <span class="co"># class switch only</span></span>
<span id="cb19-1571"><a href="#cb19-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1572"><a href="#cb19-1572" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 3  Tunnel metrics ----------------------------------------------------</span></span>
<span id="cb19-1573"><a href="#cb19-1573" aria-hidden="true" tabindex="-1"></a>HAND_THR   <span class="op">=</span> <span class="fl">0.333</span>   <span class="co"># 4 inches</span></span>
<span id="cb19-1574"><a href="#cb19-1574" aria-hidden="true" tabindex="-1"></a>PRED_THR   <span class="op">=</span> <span class="fl">0.333</span>   <span class="co"># 4 inches</span></span>
<span id="cb19-1575"><a href="#cb19-1575" aria-hidden="true" tabindex="-1"></a>Y_PLATE    <span class="op">=</span> <span class="fl">1.417</span>   <span class="co"># Statcast y at back edge of plate (ft)</span></span>
<span id="cb19-1576"><a href="#cb19-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1577"><a href="#cb19-1577" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-a) release-point distance (x, z, extension)</span></span>
<span id="cb19-1578"><a href="#cb19-1578" aria-hidden="true" tabindex="-1"></a>hand_dist <span class="op">=</span> np.sqrt(</span>
<span id="cb19-1579"><a href="#cb19-1579" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_x_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_x_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb19-1580"><a href="#cb19-1580" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_pos_z_1"</span>] <span class="op">-</span> wide[<span class="st">"release_pos_z_0"</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span></span>
<span id="cb19-1581"><a href="#cb19-1581" aria-hidden="true" tabindex="-1"></a>    (wide[<span class="st">"release_extension_1"</span>] <span class="op">-</span> wide[<span class="st">"release_extension_0"</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb19-1582"><a href="#cb19-1582" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-1583"><a href="#cb19-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1584"><a href="#cb19-1584" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-b) straight-line (no-spin) projection to plate -----------------------</span></span>
<span id="cb19-1585"><a href="#cb19-1585" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> projected_xy(frame, s: <span class="bu">int</span>):</span>
<span id="cb19-1586"><a href="#cb19-1586" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return (x_proj, z_proj) at plate assuming ax = az = 0."""</span></span>
<span id="cb19-1587"><a href="#cb19-1587" aria-hidden="true" tabindex="-1"></a>    y0  <span class="op">=</span> frame[<span class="ss">f"release_pos_y_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1588"><a href="#cb19-1588" aria-hidden="true" tabindex="-1"></a>    dy  <span class="op">=</span> y0 <span class="op">-</span> Y_PLATE</span>
<span id="cb19-1589"><a href="#cb19-1589" aria-hidden="true" tabindex="-1"></a>    vy0 <span class="op">=</span> frame[<span class="ss">f"vy0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1590"><a href="#cb19-1590" aria-hidden="true" tabindex="-1"></a>    ay  <span class="op">=</span> frame[<span class="ss">f"ay_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()         <span class="co"># drag + gravity only</span></span>
<span id="cb19-1591"><a href="#cb19-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1592"><a href="#cb19-1592" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> vy0<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>ay<span class="op">*</span>dy</span>
<span id="cb19-1593"><a href="#cb19-1593" aria-hidden="true" tabindex="-1"></a>    t    <span class="op">=</span> np.full_like(vy0, np.nan)</span>
<span id="cb19-1594"><a href="#cb19-1594" aria-hidden="true" tabindex="-1"></a>    ok   <span class="op">=</span> (disc <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (ay <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb19-1595"><a href="#cb19-1595" aria-hidden="true" tabindex="-1"></a>    t[ok] <span class="op">=</span> (<span class="op">-</span>vy0[ok] <span class="op">-</span> np.sqrt(disc[ok])) <span class="op">/</span> ay[ok]</span>
<span id="cb19-1596"><a href="#cb19-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1597"><a href="#cb19-1597" aria-hidden="true" tabindex="-1"></a>    vx0 <span class="op">=</span> frame[<span class="ss">f"vx0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1598"><a href="#cb19-1598" aria-hidden="true" tabindex="-1"></a>    vz0 <span class="op">=</span> frame[<span class="ss">f"vz0_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1599"><a href="#cb19-1599" aria-hidden="true" tabindex="-1"></a>    x0  <span class="op">=</span> frame[<span class="ss">f"release_pos_x_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1600"><a href="#cb19-1600" aria-hidden="true" tabindex="-1"></a>    z0  <span class="op">=</span> frame[<span class="ss">f"release_pos_z_</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>].to_numpy()</span>
<span id="cb19-1601"><a href="#cb19-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1602"><a href="#cb19-1602" aria-hidden="true" tabindex="-1"></a>    x_proj <span class="op">=</span> x0 <span class="op">+</span> vx0 <span class="op">*</span> t           <span class="co"># ax = 0</span></span>
<span id="cb19-1603"><a href="#cb19-1603" aria-hidden="true" tabindex="-1"></a>    z_proj <span class="op">=</span> z0 <span class="op">+</span> vz0 <span class="op">*</span> t           <span class="co"># az = 0</span></span>
<span id="cb19-1604"><a href="#cb19-1604" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_proj, z_proj</span>
<span id="cb19-1605"><a href="#cb19-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1606"><a href="#cb19-1606" aria-hidden="true" tabindex="-1"></a>x_proj0, z_proj0 <span class="op">=</span> projected_xy(wide, <span class="dv">0</span>)</span>
<span id="cb19-1607"><a href="#cb19-1607" aria-hidden="true" tabindex="-1"></a>x_proj1, z_proj1 <span class="op">=</span> projected_xy(wide, <span class="dv">1</span>)</span>
<span id="cb19-1608"><a href="#cb19-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1609"><a href="#cb19-1609" aria-hidden="true" tabindex="-1"></a>pred_dist <span class="op">=</span> np.sqrt((x_proj1 <span class="op">-</span> x_proj0)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (z_proj1 <span class="op">-</span> z_proj0)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb19-1610"><a href="#cb19-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1611"><a href="#cb19-1611" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-c) tunnel flag</span></span>
<span id="cb19-1612"><a href="#cb19-1612" aria-hidden="true" tabindex="-1"></a>cond_hand <span class="op">=</span> (hand_dist <span class="op">&lt;</span> HAND_THR).fillna(<span class="va">False</span>)</span>
<span id="cb19-1613"><a href="#cb19-1613" aria-hidden="true" tabindex="-1"></a>cond_pred <span class="op">=</span> np.where(np.isnan(pred_dist), <span class="va">False</span>, pred_dist <span class="op">&lt;</span> PRED_THR)</span>
<span id="cb19-1614"><a href="#cb19-1614" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"tunneled"</span>] <span class="op">=</span> cond_hand <span class="op">&amp;</span> cond_pred</span>
<span id="cb19-1615"><a href="#cb19-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1616"><a href="#cb19-1616" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 4  Sequence label ----------------------------------------------------</span></span>
<span id="cb19-1617"><a href="#cb19-1617" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"seq"</span>] <span class="op">=</span> wide[<span class="st">"pitch_class_0"</span>] <span class="op">+</span> <span class="st">"→"</span> <span class="op">+</span> wide[<span class="st">"pitch_class_1"</span>]</span>
<span id="cb19-1618"><a href="#cb19-1618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1619"><a href="#cb19-1619" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 5  OPS components for final pitch -----------------------------------</span></span>
<span id="cb19-1620"><a href="#cb19-1620" aria-hidden="true" tabindex="-1"></a>ev <span class="op">=</span> wide[<span class="st">"events_1"</span>].fillna(<span class="st">"none"</span>).<span class="bu">str</span>.lower()</span>
<span id="cb19-1621"><a href="#cb19-1621" aria-hidden="true" tabindex="-1"></a>single <span class="op">=</span> ev.eq(<span class="st">"single"</span>)<span class="op">;</span> double <span class="op">=</span> ev.eq(<span class="st">"double"</span>)<span class="op">;</span> triple <span class="op">=</span> ev.eq(<span class="st">"triple"</span>)</span>
<span id="cb19-1622"><a href="#cb19-1622" aria-hidden="true" tabindex="-1"></a>hr     <span class="op">=</span> ev.eq(<span class="st">"home_run"</span>)<span class="op">;</span> walk  <span class="op">=</span> ev.isin([<span class="st">"walk"</span>,<span class="st">"intent_walk"</span>,<span class="st">"hit_by_pitch"</span>])</span>
<span id="cb19-1623"><a href="#cb19-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1624"><a href="#cb19-1624" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"PA"</span>]  <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-1625"><a href="#cb19-1625" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"AB"</span>]  <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> walk</span>
<span id="cb19-1626"><a href="#cb19-1626" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"TB"</span>]  <span class="op">=</span> single <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>double <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>triple <span class="op">+</span> <span class="dv">4</span><span class="op">*</span>hr</span>
<span id="cb19-1627"><a href="#cb19-1627" aria-hidden="true" tabindex="-1"></a>wide[<span class="st">"ONB"</span>] <span class="op">=</span> single <span class="op">+</span> double <span class="op">+</span> triple <span class="op">+</span> hr <span class="op">+</span> walk</span>
<span id="cb19-1628"><a href="#cb19-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1629"><a href="#cb19-1629" aria-hidden="true" tabindex="-1"></a><span class="co"># ── 6  Aggregate OPS split by tunnel flag -------------------------------</span></span>
<span id="cb19-1630"><a href="#cb19-1630" aria-hidden="true" tabindex="-1"></a>agg <span class="op">=</span> (wide.groupby([<span class="st">"seq"</span>,<span class="st">"tunneled"</span>])</span>
<span id="cb19-1631"><a href="#cb19-1631" aria-hidden="true" tabindex="-1"></a>             .agg(PA<span class="op">=</span>(<span class="st">"PA"</span>,<span class="st">"sum"</span>), AB<span class="op">=</span>(<span class="st">"AB"</span>,<span class="st">"sum"</span>), TB<span class="op">=</span>(<span class="st">"TB"</span>,<span class="st">"sum"</span>), ONB<span class="op">=</span>(<span class="st">"ONB"</span>,<span class="st">"sum"</span>))</span>
<span id="cb19-1632"><a href="#cb19-1632" aria-hidden="true" tabindex="-1"></a>             .reset_index())</span>
<span id="cb19-1633"><a href="#cb19-1633" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OBP"</span>] <span class="op">=</span> agg[<span class="st">"ONB"</span>] <span class="op">/</span> agg[<span class="st">"PA"</span>]</span>
<span id="cb19-1634"><a href="#cb19-1634" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"SLG"</span>] <span class="op">=</span> agg[<span class="st">"TB"</span>]  <span class="op">/</span> agg[<span class="st">"AB"</span>].where(agg[<span class="st">"AB"</span>]<span class="op">&gt;</span><span class="dv">0</span>, np.nan)</span>
<span id="cb19-1635"><a href="#cb19-1635" aria-hidden="true" tabindex="-1"></a>agg[<span class="st">"OPS"</span>] <span class="op">=</span> agg[<span class="st">"OBP"</span>] <span class="op">+</span> agg[<span class="st">"SLG"</span>]</span>
<span id="cb19-1636"><a href="#cb19-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1637"><a href="#cb19-1637" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (agg.pivot(index<span class="op">=</span><span class="st">"seq"</span>, columns<span class="op">=</span><span class="st">"tunneled"</span>, values<span class="op">=</span>[<span class="st">"PA"</span>,<span class="st">"OPS"</span>])</span>
<span id="cb19-1638"><a href="#cb19-1638" aria-hidden="true" tabindex="-1"></a>             .rename(columns<span class="op">=</span>{<span class="va">False</span>:<span class="st">"NoTunnel"</span>, <span class="va">True</span>:<span class="st">"Tunnel"</span>}))</span>
<span id="cb19-1639"><a href="#cb19-1639" aria-hidden="true" tabindex="-1"></a>table.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c,col <span class="kw">in</span> table.columns]</span>
<span id="cb19-1640"><a href="#cb19-1640" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"OPS_Tunnel"</span>, <span class="st">"OPS_NoTunnel"</span>]:        <span class="co"># ensure columns exist</span></span>
<span id="cb19-1641"><a href="#cb19-1641" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> table.columns:</span>
<span id="cb19-1642"><a href="#cb19-1642" aria-hidden="true" tabindex="-1"></a>        table[col] <span class="op">=</span> np.nan</span>
<span id="cb19-1643"><a href="#cb19-1643" aria-hidden="true" tabindex="-1"></a>table[<span class="st">"ΔOPS (Tunnel – No)"</span>] <span class="op">=</span> table[<span class="st">"OPS_Tunnel"</span>] <span class="op">-</span> table[<span class="st">"OPS_NoTunnel"</span>]</span>
<span id="cb19-1644"><a href="#cb19-1644" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> table.sort_values(<span class="st">"ΔOPS (Tunnel – No)"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-1645"><a href="#cb19-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1646"><a href="#cb19-1646" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== OPS on last-pitch sequences | Straight-Line Tunnel vs Not ==="</span>)</span>
<span id="cb19-1647"><a href="#cb19-1647" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(table.to_string(float_format<span class="op">=</span><span class="kw">lambda</span> x:<span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span>, na_rep<span class="op">=</span><span class="st">"–"</span>))</span>
<span id="cb19-1648"><a href="#cb19-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1649"><a href="#cb19-1649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1650"><a href="#cb19-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1651"><a href="#cb19-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1652"><a href="#cb19-1652" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Evidence: selected outputs kept for interpretability. --&gt;</span></span>
<span id="cb19-1653"><a href="#cb19-1653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1654"><a href="#cb19-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1655"><a href="#cb19-1655" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Console Output (evidence):**</span></span>
<span id="cb19-1656"><a href="#cb19-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1657"><a href="#cb19-1657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1658"><a href="#cb19-1658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb19-1659"><a href="#cb19-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-1660"><a href="#cb19-1660" aria-hidden="true" tabindex="-1"></a><span class="in">=== OPS on last-pitch sequences | Straight-Line Tunnel vs Not ===</span></span>
<span id="cb19-1661"><a href="#cb19-1661" aria-hidden="true" tabindex="-1"></a><span class="in">                   PA_NoTunnel  PA_Tunnel  OPS_NoTunnel  OPS_Tunnel  ΔOPS (Tunnel – No)</span></span>
<span id="cb19-1662"><a href="#cb19-1662" aria-hidden="true" tabindex="-1"></a><span class="in">seq                                                                                    </span></span>
<span id="cb19-1663"><a href="#cb19-1663" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Change      13945.000    404.000         0.593       0.662               0.069</span></span>
<span id="cb19-1664"><a href="#cb19-1664" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Breaking      11081.000    253.000         0.607       0.638               0.032</span></span>
<span id="cb19-1665"><a href="#cb19-1665" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Fastball    70794.000   1986.000         0.731       0.742               0.012</span></span>
<span id="cb19-1666"><a href="#cb19-1666" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Fastball      30874.000   1048.000         0.747       0.745              -0.002</span></span>
<span id="cb19-1667"><a href="#cb19-1667" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Change      32230.000   1384.000         0.645       0.592              -0.053</span></span>
<span id="cb19-1668"><a href="#cb19-1668" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Breaking    69876.000   1655.000         0.633       0.535              -0.098</span></span>
<span id="cb19-1669"><a href="#cb19-1669" aria-hidden="true" tabindex="-1"></a><span class="in">Change→Other           100.000      3.000         0.973       0.333              -0.640</span></span>
<span id="cb19-1670"><a href="#cb19-1670" aria-hidden="true" tabindex="-1"></a><span class="in">Breaking→Other          23.000          –         1.503           –                   –</span></span>
<span id="cb19-1671"><a href="#cb19-1671" aria-hidden="true" tabindex="-1"></a><span class="in">Fastball→Other          42.000          –         0.819           –                   –</span></span>
<span id="cb19-1672"><a href="#cb19-1672" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Breaking          28.000      1.000         0.438           –                   –</span></span>
<span id="cb19-1673"><a href="#cb19-1673" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Change           104.000          –         0.864           –                   –</span></span>
<span id="cb19-1674"><a href="#cb19-1674" aria-hidden="true" tabindex="-1"></a><span class="in">Other→Fastball          51.000          –         0.514           –                   –</span></span>
<span id="cb19-1675"><a href="#cb19-1675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>